# include:
# - template: Container-Scanning.gitlab-ci.yml

variables:
  LABREPO_HOST: "labrepo.sil.lab"
  DIP_EXPORT_LOC: "/mnt/drive_creation/dip"
  MIP_EXPORT_LOC: "/mnt/drive_creation/mip"
  GIP_EXPORT_LOC: "/mnt/drive_creation/gip"
  REPO_EXPORT_LOC: "/mnt/drive_creation/repo"
  DIP_DOC_EXPORT_LOC: "/mnt/drive_creation/dip"
  MIP_DOC_EXPORT_LOC: "/mnt/drive_creation/mip"
  TFPLENUM_EXPORT_VERSION: RC
  TFPLENUM_CONFLUENCE_PAGE: "6.8 CVAH 3.3"
  PIPELINE: "developer-dip"
  BUILD_TYPE: "clone_from_nightly"
  IS_CLEANUP: "false"
  VMWARE_FOLDER: "Testing"
  NETWORK_ID: "10.40.12.0"
  DIP_NETWORK_BLOCK_INDEX: 0
  MIP_NETWORK_BLOCK_INDEX: 1
  GIP_NETWORK_BLOCK_INDEX: 2
  GIP_SERVICES_NETWORK_BLOCK_INDEX: 3
  RHEL_NETWORK_BLOCK_INDEX: 3
  SONAR_TOKEN: "88288e09065a3d865d20a10c05563b3225566490"
  SONAR_HOST_URL: "http://sonarqube.sil.lab:9000/"
  ACAS_IPADDRESS: "172.16.82.15"
  ACAS_USERNAME: "acas"
  ACAS_PASSWORD: "we.are.tfplenum"
  DIP_ACAS_SCAN_TO_RUN: "DIP Dynamic Scan"
  MIP_ACAS_SCAN_TO_RUN: "MIP Dynamic Scan"
  RUN_ACAS: "false"
  RUN_INTEGRATION: "false"
  DNS_SERVERS: "10.10.101.11 10.10.101.12 10.11.101.13"
  REPO_URL: "https://gitlab.sil.lab/tfplenum/tfplenum.git"
  VCENTER_IPADDRESS: "10.10.103.10"
  VCENTER_DATACENTER: "DEV_Datacenter"
  VCENTER_PORTGROUP: "12-Dev2-Navarro"
  VCENTER_DATASTORE: "dev-vol02"
  DIP_TEMPLATE_TO_CLONE: "nightly-dip-ctrl.lan"
  MIP_TEMPLATE_TO_CLONE: "nightly-mip-ctrl.lan"
  GIP_TEMPLATE_TO_CLONE: "nightly-gip-ctrl.lan"
  GIP_SVC_TEMPLATE_TO_CLONE: "GIP SVC Template"
  MIP_OPERATOR_TYPE: "CPT"
  VM_GATEWAY: "10.40.12.1"
  RHEL_SUB_METHOD: "standard"
  RHEL_ORGANIZATION: "7403688"
  RHEL_ACTIVATIONKEY: "Reposync"

  RUN_DIP_STIGS: "true"
  RUN_MIP_STIGS: "true"
  RUN_GIP_STIGS: "true"
  RUN_GIPSVC_STIGS: "true"

  #Master Drive Creation Variables
  MASTER_DRIVE_CREATION_USERNAME: "davidnavarro"
  MASTER_DRIVE_CREATION_IPADDRESS: "10.10.102.179"
  MASTER_DRIVE_CREATION_MULTIBOOT_IMG_PATH: "/mnt/drive_creation/MULTIBOOT_20200110.IMG"
  MASTER_DRIVE_CREATION_EXTERNAL_DRIVE: "/dev/sdb"
  MASTER_DRIVE_CREATION_MOUNT_POINT: "/mnt/Data"
  MASTER_DRIVE_CREATION_RSYNC_SOURCE: "/mnt/drive_creation/v3.3/CPT/Data/"
  RUN_CREATE_MASTER_DRIVE: "false"
  #End

  #The VM prefix is the prefix for all the VMs that will be created.
  #EX <VM_PREFIX>-ctrl.lan | <VM_PREFIX>-sensor1.lan | <VM_PREFIX>-server1.lan
  VM_PREFIX: "test1"
  NUM_SERVERS: 2
  NUM_SENSORS: 1
  SERVER_CPU: 32
  SERVER_MEM: 30720
  SENSOR_CPU: 24
  SENSOR_MEM: 30720
  NUM_MIPS: 1
  GIP_NUM_SERVERS: 4
  GIP_SERVER_CPU: 32
  GIP_SERVER_MEM: 65536

stages:
  - code-analysis
  - pre-build
  - build
  - docs
  - kickstart
  - kit
  - stig-kit
  - security_scans
  - catalog
  - unit-test
  - integration-test
  - test-powerfailure
  - rerun-integration-test
  - cleanup
  - export
  - hashfiles
  - publish

include:
  - local: code-analysis.yml
  - local: dip.gitlab-ci.yml
  - local: mip.gitlab-ci.yml
  - local: dip.export.gitlab-ci.yml
  - local: gip.gitlab-ci.yml
  - local: mip.export.gitlab-ci.yml
  - local: gip.export.gitlab-ci.yml
  - local: repo.gitlab-ci.yml
  - local: repo.export.gitlab-ci.yml

Create Master Drive:
  stage: publish
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py create-master-drive \
    --multi-boot-img-path "$MASTER_DRIVE_CREATION_MULTIBOOT_IMG_PATH" \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_DRIVE" \
    --mount-point "$MASTER_DRIVE_CREATION_MOUNT_POINT" \
    --rsync-source "$MASTER_DRIVE_CREATION_RSYNC_SOURCE" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS"
  only:
    variables:
      - $RUN_CREATE_MASTER_DRIVE == "true"