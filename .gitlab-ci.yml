# include:
# - template: Container-Scanning.gitlab-ci.yml

variables:

  #Version variables
  TFPLENUM_EXPORT_VERSION: "3.5"
  TFPLENUM_EXPORT_HASH: "$CI_COMMIT_SHORT_SHA"

  #Pipeline specific variables
  PIPELINE: "developer-dip"
  BUILD_TYPE: "clone_from_nightly"
  VMWARE_FOLDER: "Testing"
  NETWORK_ID: "10.40.12.0"
  DIP_NETWORK_BLOCK_INDEX: 0
  MIP_NETWORK_BLOCK_INDEX: 1
  GIP_NETWORK_BLOCK_INDEX: 2
  GIP_SERVICES_NETWORK_BLOCK_INDEX: 4
  RHEL_NETWORK_BLOCK_INDEX: 3

  # Common varibles used across multiple pipelines
  DNS_SERVERS: "10.10.101.11 10.10.101.12 10.11.101.13"
  REPO_URL: "https://gitlab.sil.lab/tfplenum/tfplenum.git"
  VCENTER_IPADDRESS: "10.10.103.10"
  VCENTER_DATACENTER: "DEV_Datacenter"
  VCENTER_PORTGROUP: ""
  VCENTER_DATASTORE: "DEV-vSAN"
  DIP_TEMPLATE_TO_CLONE: "nightly$TFPLENUM_EXPORT_VERSION-dip-ctrl"
  MIP_TEMPLATE_TO_CLONE: "nightly$TFPLENUM_EXPORT_VERSION-mip-ctrl"
  GIP_TEMPLATE_TO_CLONE: "nightly$TFPLENUM_EXPORT_VERSION-gip-ctrl"
  GIP_SVC_TEMPLATE_TO_CLONE: "GIP SVC Template"
  MIP_OPERATOR_TYPE: "CPT"
  VM_GATEWAY: "10.40.12.1"
  RHEL_SUB_METHOD: "standard"
  RHEL_ORGANIZATION: "7403688"
  RHEL_ACTIVATIONKEY: "Reposync"
  UPSTREAM_DNS: "10.10.101.11"
  UPSTREAM_NTP: "10.10.101.11"

  #VM Default variables
  VM_PREFIX: "test1" #EX <VM_PREFIX>-ctrl.<KIT_DOMAIN> | <VM_PREFIX>-sensor1.<KIT_DOMAIN> | <VM_PREFIX>-server1.<KIT_DOMAIN>
  KIT_DOMAIN: "lan"
  CTRL_CPU: 24
  CTRL_MEMORY: 16384
  NUM_SERVERS: 2
  NUM_SENSORS: 1
  SERVER_CPU: 16
  SERVER_MEM: 24576
  SENSOR_CPU: 16
  SENSOR_MEM: 16384
  NUM_MIPS: 1
  GIP_NUM_SERVERS: 4
  GIP_SERVER_CPU: 16
  GIP_SERVER_MEM: 32768

  # Yes no flag variables
  CREATE_NIGHTLY: "no"
  RUN_DIP_STIGS: "yes"
  RUN_MIP_STIGS: "yes"
  RUN_GIP_STIGS: "yes"
  RUN_GIPSVC_STIGS: "yes"
  RUN_REPOSYNC_SERVER_STIGS: "yes"
  RUN_REPOSYNC_WORKSTATION_STIGS: "yes"
  VM_RAID: "no"
  RUN_REMOTE_NODE: "no"
  RUN_INTEGRATION: "no"
  COMMUNITY_APPS: "no"
  RUN_CODE_CHECKS: "yes"
  RUN_POWER_FAILURE: "no"
  RUN_BREAKINGPOINT : "no"
  RUN_ACAS: "no"
  UPDATE_CODE: "yes"
  IS_CLEANUP: "no"
  RUN_ROBOT_TESTS: "yes"
  MINIO_USE_TLS: "yes"

  #ACAS specific variables:
  ACAS_IPADDRESS: "172.16.82.15"
  ACAS_USERNAME: "acas"
  DIP_ACAS_SCAN_TO_RUN: "DIP Dynamic Scan"
  MIP_ACAS_SCAN_TO_RUN: "MIP Dynamic Scan"

  # Breaking point variables
  BREAKINGPOINT_IP: "10.10.103.29"
  BREAKINGPOINT_TEST_NAME: "BP-1GB-Pipeline-Test"

  # TODO for simplicity everything should have same password go back and fix this later.
  DEFAULT_TEMPLATE_PASSWORD: "d2UuYXJlLnRmcGxlbnVt"
  DEFAULT_VM_PASSWORD: "V2UuYXJlLnRmcGxlbnVtNCQ="

  # Repo Sync variables
  REPO_SERVER_TEMPLATE_TO_CLONE: reposync-server
  REPO_WORKSTATION_TEMPLATE_TO_CLONE: reposync-workstation
  REPO_WORKSTATION_DISK_SIZE: 300
  REPO_SERVER_DISK_SIZE: 175

  # MinIO
  MINIO_STORAGE_SIZE: 250
  MINIO_MEMORY: 8192
  MINIO_CPU: 2
  MINIO_VM: "no"
  MINIO_TEMPLATE_TO_CLONE: "jdms-rhel7-template"
  MINIO_DISK_SIZE: 10

  # Hardware specific variables
  REDFISH_USER: "root"
  ESXI_DATASTORE: "datastore1"
  CONTROLLER_OVA: DIP_Controller
  DIP_TEMPLATE_OVA: "dip_template.ova"
  CONTROLLER_DNS_SERVERS: "10.10.101.248"
  REDFISH_PASSWORD: ""
  MANAGEMENT_PASSWORD: ""
  CONTROLLER_GATEWAY: ""
  CONTROLLER_IPADDRESS: ""
  SERVER_OOB: ""
  SENSOR_OOB: ""
  MP_EXTERNAL_IP: ""
  PFSENSE_IP: ""
  SWITCH_IP: ""
  MONITORING_INTERFACE: ""

  #Master Drive Creation Variables
  MASTER_DRIVE_CREATION_USERNAME: "drive_creator"
  MASTER_DRIVE_CREATION_IPADDRESS: "10.10.102.10"
  MASTER_DRIVE_CREATION_EXTERNAL_CPT_DRIVE: "/dev/sdb"
  MASTER_DRIVE_CREATION_EXTERNAL_MDT_DRIVE: "/dev/sdc"
  MASTER_DRIVE_CREATION_CPT_MOUNT_POINT: "/mnt/CPTData"
  MASTER_DRIVE_CREATION_MDT_MOUNT_POINT: "/mnt/MDTData"
  RUN_CREATE_MASTER_DRIVE: "no"

  #EXPORT Variables
  GIP_EXPORT_LOC: "/mnt/drive_creation/gip"
  DIP_CONFLUENCE_SETUP_DOCS: ""
  DIP_CONFLUENCE_USER_DOCS: ""
  DIP_CONFLUENCE_TRAINING_DOCS: ""
  DIP_CONFLUENCE_MAIN_DOCS: ""
  DIP_CONFLUENCE_TROUBLE_DOCS: ""
  DIP_CONFLUENCE_VDD_DOCS: ""
  MIP_CONFLUENCE_SETUP_DOCS: ""
  MIP_CONFLUENCE_USER_DOCS: ""
  MIP_CONFLUENCE_MAIN_DOCS: ""
  MIP_CONFLUENCE_TROUBLE_DOCS: ""
  MIP_CONFLUENCE_VDD_DOCS: ""

  #THE VARIBALES IN THIS SECTION DO NOT NEED TO BE OVERWRITTEN IN SCHEDULES.
  SONAR_TOKEN: "88288e09065a3d865d20a10c05563b3225566490"
  SONAR_HOST_URL: "http://sonarqube.sil.lab:9000/"

  NIGHTLY_PREFIX: "nightly$TFPLENUM_EXPORT_VERSION"
  MASTER_DRIVE_CREATION_PATH: "/mnt/drive_creation"
  MASTER_DRIVE_CPT_MULTIBOOT_PATH: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/CPT_MULTIBOOT/"
  MASTER_DRIVE_MDT_MULTIBOOT_PATH: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/MDT_MULTIBOOT/"

  MASTER_DRIVE_CREATION_CPT_RSYNC_SOURCE: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/CPT/Data/"
  MASTER_DRIVE_CREATION_MDT_RSYNC_SOURCE: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/MDT/Data/"
  SOFTWARE_CPT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software"
  SOFTWARE_MDT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software"
  REPO_CPT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/VMs/RhelRepo"
  REPO_MDT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/VMs/RhelRepo"
  MIP_CPT_DOC_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/MIP"
  MIP_MDT_DOC_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/MIP"
  DIP_CPT_DOC_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/DIP"
  DIP_MDT_DOC_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/DIP"
  APP_STORE_CPT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/AppStore"
  APP_STORE_MDT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/AppStore"

  DRIVE_STAGING_FOLDER: "$MASTER_DRIVE_CREATION_PATH/staging_$TFPLENUM_EXPORT_VERSION"
  CPT_DOCUMENTATION_STAGING: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/Documentation/CPT"
  MDT_DOCUMENTATION_STAGING: "$MASTER_DRIVE_CREATION_PATH/v$TFPLENUM_EXPORT_VERSION/Documentation/MDT"

  DIP_TEMPLATE_PATH: "/mnt/drive_creation/templates/"
  DIP_CONTROLLER_PATH: "/mnt/drive_creation/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH\ $TFPLENUM_EXPORT_VERSION/Software/DIP/"

  APP_STORE_DIRECTORY: "PowerShell_Modules"
  DOCS_ARCH_FOLDER: "Architecture"
  DOCS_SETUP_FOLDER: "Setup"
  DOCS_TRAINING_FOLDER: "Training"
  DOCS_USER_FOLDER: "User"
  DOCS_VDD_FOLDER: "VDD"
  DOCS_MAINTENANCE_FOLDER: "Maintenance"
  DOCS_TROUBLESHOOTING_FOLDER: "TroubleShooting"
  DOCS_FOLDERS: "$DOCS_ARCH_FOLDER $DOCS_SETUP_FOLDER $DOCS_TRAINING_FOLDER $DOCS_USER_FOLDER $DOCS_VDD_FOLDER $DOCS_MAINTENANCE_FOLDER $DOCS_TROUBLESHOOTING_FOLDER"

  STACK_SOFTWARE_FOLDER: "Physical_Stack_Build"
  DIP_SOFTWARE_FOLDER: "DIP"
  MIP_SOFTWARE_FOLDER: "MIP"

  DIP_SOFTWARE_FOLDERS: "$STACK_SOFTWARE_FOLDER $DIP_SOFTWARE_FOLDER"
  MIP_SOFTWARE_FOLDERS: "$MIP_SOFTWARE_FOLDER"
  REPO_SYNC_FOLDERS: "RhelRepo"

  # Robot Test Integration
  JIRA_PROJECT_KEY: "THISISCVAH"

stages:
  - code-analysis
  - clean-staging-env
  - build
  - docs
  - unit-test
  - kickstart
  - kit
  - configure:minio
  - stig-kit
  - security_scans
  - catalog
  - robot-test
  - integration-test
  - test-powerfailure
  - rerun-integration-test
  - publish-nightly
  - export
  - cleanup
  - hashfiles
  - checkhash
  - publish
  - breakingpoint-test
  - remote-node

default:
  before_script:
    - |
      python3 testing/pipeline/pipeline.py \
          --system-name "DIP" \
          checkout-latest-code \
          --repo-username "$REPO_USERNAME" \
          --repo-password "$REPO_PASSWORD" \
          --repo-url "$REPO_URL" \
          --branch-name "$CI_COMMIT_REF_NAME"

include:
  - local: gitlab/code-analysis.yml
  - local: gitlab/DIP/dip.gitlab-ci.yml
  - local: gitlab/DIP/dip.export.gitlab-ci.yml
  - local: gitlab/DIP/dip.docs.gitlab-ci.yml
  - local: gitlab/DIP/dip.robot.gitlab-ci.yml
  - local: gitlab/DIP/dip.baremetal-gitlab-ci.yml
  - local: gitlab/MIP/mip.gitlab-ci.yml
  - local: gitlab/MIP/mip.export.gitlab-ci.yml
  - local: gitlab/MIP/mip.docs.gitlab-ci.yml
  - local: gitlab/GIP/gip.gitlab-ci.yml
  - local: gitlab/GIP/gip.export.gitlab-ci.yml
  - local: gitlab/Drive/repo.gitlab-ci.yml
  - local: gitlab/Drive/repo.export.gitlab-ci.yml
  - local: gitlab/Drive/powershell.gitlab-export.yml
  - local: gitlab/Drive/drive.create.gitlab-ci.yml
