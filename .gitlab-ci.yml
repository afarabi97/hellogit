variables:
  #Version variables
  TFPLENUM_EXPORT_VERSION: "3.7"
  TFPLENUM_EXPORT_HASH: "$CI_COMMIT_SHORT_SHA"

  #Pipeline specific variables
  PIPELINE: ""
  VMWARE_FOLDER: "Testing"
  NETWORK_ID: "10.40.12.0"
  NETWORK_BLOCK_INDEX: 0
  MINIO_NETWORK_BLOCK_INDEX: 1
  RHEL_NETWORK_BLOCK_INDEX: 2

  # Common varibles used across multiple pipelines
  DNS_SERVERS: "10.10.101.248 10.10.101.11 10.10.101.12"
  REPO_URL: "https://gitlab.sil.lab/tfplenum/tfplenum.git"
  VCENTER_IPADDRESS: "10.10.103.10"
  VCENTER_DATACENTER: "DEV_Datacenter"
  VCENTER_PORTGROUP: ""
  VCENTER_DATASTORE: "DEV-vSAN"
  VCENTER_CLUSTER: "DEV_Cluster"
  TEMPLATE_TO_CLONE: "RHEL8 Template"
  VM_GATEWAY: "10.40.12.1"
  RHEL_SUB_METHOD: "standard"
  RHEL_ORGANIZATION: "7403688"
  RHEL_ACTIVATIONKEY: "Reposync"
  UPSTREAM_DNS: "10.10.101.11"
  UPSTREAM_NTP: "10.10.101.11"
  MONITORING_INTERFACE: "ens224"
  OPERATOR_TYPE: "CPT"

  #VM Default variables
  VM_PREFIX: "test1" #EX <VM_PREFIX>-ctrl.<KIT_DOMAIN> | <VM_PREFIX>-sensor1.<KIT_DOMAIN> | <VM_PREFIX>-server1.<KIT_DOMAIN>
  KIT_DOMAIN: "lan"
  CTRL_CPU: 24
  CTRL_MEMORY: 16384
  NUM_SERVERS: 2
  NUM_SENSORS: 1
  NUM_SERVICE_NODES: 1
  SERVER_CPU: 16
  SERVER_MEM: 32768
  SENSOR_CPU: 16
  SENSOR_MEM: 16384
  SERVICE_CPU: 24
  SERVICE_MEM: 32
  MIP_CPU: 16
  MIP_MEM: 24576
  NUM_MIPS: 1

  # Yes no flag variables
  VM_RAID: "no"
  BUILD_FROM_RELEASE: "no"
  RUN_REMOTE_NODE: "no"
  RUN_INTEGRATION: "no"
  RUN_DISK_TEST: "no"
  COMMUNITY_APPS: "no"
  RUN_CODE_CHECKS: "yes"
  RUN_POWER_FAILURE: "no"
  RUN_BREAKINGPOINT: "no"
  RUN_SECURITY_SCANS: "yes"
  UPDATE_CODE: "yes"
  IS_CLEANUP: "no"
  RUN_ROBOT_TESTS: "yes"
  MINIO_USE_TLS: "no"
  # Creates multiboot partition on full drives, when doing a minor release make sure this is set to no
  CREATE_MULTIBOOT: "yes"
  CREATE_CPT_DRIVE: "yes"
  CREATE_MDT_DRIVE: "yes"
  CREATE_GIP_DRIVE: "yes"
  RPM_BUILD: "no"

  # Breaking point variables
  BREAKINGPOINT_IP: "10.10.103.29"
  BREAKINGPOINT_TEST_NAME: "BP-1GB-Pipeline-Test"

  # Passwords intentionally left blank as they are overridden
  DEFAULT_TEMPLATE_PASSWORD: ""
  DEFAULT_VM_PASSWORD: ""

  # Repo Sync variables
  REPO_SERVER_TEMPLATE_TO_CLONE: RHEL8 Template
  REPO_SERVER_DISK_SIZE: 175

  # MinIO
  MINIO_STORAGE_SIZE: 250
  MINIO_MEMORY: 8192
  MINIO_CPU: 2
  MINIO_VM: "no"
  MINIO_TEMPLATE_TO_CLONE: "RHEL8 Template"
  MINIO_DISK_SIZE: 100

  # Hardware specific variables
  REDFISH_USER: "root"
  PXE_TYPE: "UEFI"
  ESXI_DATASTORE: "datastore1"
  ESXI_PORTGROUP: "Internal"
  CONTROLLER_OVA: DIP_Controller
  TEMPLATE_OVA: "rhel8_template.ova"
  REDFISH_PASSWORD: ""
  MANAGEMENT_PASSWORD: ""
  CONTROLLER_GATEWAY: ""
  CONTROLLER_IPADDRESS: ""
  SERVER_OOB: ""
  SENSOR_OOB: ""
  MP_EXTERNAL_IP: ""
  PFSENSE_IP: ""
  SWITCH_IP: ""

  #Master Drive Creation Variables
  MASTER_DRIVE_CREATION_USERNAME: "drive_creator"
  MASTER_DRIVE_CREATION_IPADDRESS: "10.10.102.10"
  MASTER_DRIVE_CREATION_EXTERNAL_GIP_DRIVE: "/dev/sdb"
  MASTER_DRIVE_CREATION_EXTERNAL_CPT_DRIVE: "/dev/sdb"
  MASTER_DRIVE_CREATION_EXTERNAL_MDT_DRIVE: "/dev/sdc"
  MASTER_DRIVE_CREATION_GIP_MOUNT_POINT: "/mnt/GIPData"
  MASTER_DRIVE_CREATION_CPT_MOUNT_POINT: "/mnt/CPTData"
  MASTER_DRIVE_CREATION_MDT_MOUNT_POINT: "/mnt/MDTData"

  #EXPORT Variables
  CONFLUENCE_SUP_DOCS: ""
  GIP_CONFLUENCE_DOCS: ""
  DIP_CONFLUENCE_SETUP_DOCS: ""
  DIP_CONFLUENCE_USER_DOCS: ""
  DIP_CONFLUENCE_MAIN_DOCS: ""
  DIP_CONFLUENCE_TROUBLE_DOCS: ""
  DIP_CONFLUENCE_VDD_DOCS: ""
  DIP_CONFLUENCE_VDD_MDT_DOCS: ""

  MIP_CONFLUENCE_SETUP_DOCS: ""
  MIP_CONFLUENCE_USER_DOCS: ""
  MIP_CONFLUENCE_MAIN_DOCS: ""
  MIP_CONFLUENCE_TROUBLE_DOCS: ""

  MDT_CONFLUENCE_VDD_DOCS: ""
  CPT_CONFLUENCE_VDD_DOCS: ""

  CONFLUENCE_VDD_DOCS: ""

  #THE VARIBALES IN THIS SECTION DO NOT NEED TO BE OVERWRITTEN IN SCHEDULES.
  SONAR_TOKEN: "88288e09065a3d865d20a10c05563b3225566490"
  SONAR_HOST_URL: "http://sonarqube.sil.lab:9000/"
  MASTER_DRIVE_CREATION_PATH: "/mnt/drive_creation"

  GIP_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging_gip/v$TFPLENUM_EXPORT_VERSION/GIP/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/VM"
  SOFTWARE_CPT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software"
  SOFTWARE_MDT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software"
  REPO_CPT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/VMs/RhelRepo"
  REPO_MDT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/VMs/RhelRepo"
  GIP_DOC_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging_gip/v$TFPLENUM_EXPORT_VERSION/GIP/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation"

  MIP_CPT_DOC_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/MIP/Guides"
  MIP_MDT_DOC_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/MIP/Guides"
  DIP_CPT_DOC_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/DIP/Guides"
  DIP_MDT_DOC_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/DIP/Guides"

  CPT_VDD_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/VDD"
  MDT_VDD_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Documentation/VDD"

  APP_STORE_CPT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/AppStore"
  APP_STORE_MDT_EXPORT_LOC: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/AppStore"

  DRIVE_STAGING_FOLDER: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION"
  DRIVE_GIP_STAGING_FOLDER: "$MASTER_DRIVE_CREATION_PATH/staging_gip"
  TEMPLATE_PATH: "/mnt/drive_creation/templates"
  RELEASE_PATH: "/mnt/drive_creation/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/DIP"

  # Options for the export-powershell-modules pipeline.
  POWERSHELL_MODULES_CPT_EXPORT_DIR: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/CPT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/AppStore/PowerShell_Modules"
  POWERSHELL_MODULES_MDT_EXPORT_DIR: "$MASTER_DRIVE_CREATION_PATH/staging/v$TFPLENUM_EXPORT_VERSION/MDT/Data/CVAH $TFPLENUM_EXPORT_VERSION/Software/AppStore/PowerShell_Modules"
  POWERSHELL_MODULES_REPO_DIR: "$MASTER_DRIVE_CREATION_PATH/Repo/Shared/AppStore/PowerShell_Modules/$TFPLENUM_EXPORT_VERSION/PowerShell_Modules"

  STACK_SOFTWARE_FOLDER: "Physical_Stack_Build"
  DIP_SOFTWARE_FOLDER: "DIP"
  MIP_SOFTWARE_FOLDER: "MIP"

  DIP_SOFTWARE_FOLDERS: "$STACK_SOFTWARE_FOLDER $DIP_SOFTWARE_FOLDER"
  MIP_SOFTWARE_FOLDERS: "$MIP_SOFTWARE_FOLDER"
  REPO_SYNC_FOLDERS: "RhelRepo"

  # Robot Test Integration
  JIRA_PROJECT_KEY: "THISISCVAH"

  # Verodin Automation
  VERODIN_IPADDRESS: "10.30.206.200"
  VERODIN_USERNAME: "dev-user@sil.local"
  SEQUENCE_NAME: "Common Detection Alerts - Improved"
  NUM_OF_ACTIONS: 50
  ACTION_SAMPLE: "no"

  #Nexus URLs
  DEV_REGISTRY_URL: "https://nexus.sil.lab/repository/tfplenum-dev"
  RELEASE_REGISTRY_URL: "https://nexus.sil.lab/repository/tfplenum-stable"
  REGISTRY_URL: "$DEV_REGISTRY_URL"

  # ROBOT flags
  ROBOT_BROWSER: Firefox
  ROBOT_REGRESSION_CATEGORY: integration
  ROBOT_REGRESSION_ZEPHYR_CYCLE: INTEGRATION
  ROBOT_REGRESSION_ZEPHYR_PROJECT_VERSION: Unscheduled

stages:
  - test-compile
  - code-analysis
  - publish-to-confluence
  - clean-staging-env
  - verify-manifest
  - build-manifest
  - build
  - robot-test-sso
  - build-helm
  - build-docker
  - build-frontend
  - build-rpm
  - docs
  - unit-test
  - kit-settings
  - control-plane
  - server-setup
  - deploy-kit
  - node-setup
  - security_scans
  - robot-test-setup
  - robot-test-elastic
  - integration-test
  - disk-test
  - test-powerfailure
  - rerun-integration-test
  - robot-test-cleanup
  - export
  - cleanup
  - hashfiles
  - publish
  - release
  - checkhash
  - breakingpoint-test
  - verodin-test
  - remote-node
  - range-mip-controller
  - range-mip-kickstart
  - range-mip-kit

.before-script-super:
  before_script:
    - |
      if [ ! -z "$CI_COMMIT_TAG" ]; then
        set +e # Disable exit on error
        if echo "$CI_COMMIT_TAG" | grep -Eq '^v[1-9]+.[0-9]+.[0-9]+(dev|)-[0-9]+-[A-Za-z-]*$'; then
          echo "$CI_COMMIT_TAG has correct format"
        elif echo "$CI_COMMIT_TAG" | grep -Eq '^v[1-9]+.[0-9]+.[0-9]+(dev|)-[0-9]+$'; then
          echo "$CI_COMMIT_TAG has correct format"
        else
          echo "$CI_COMMIT_TAG invalid format.  It must be in vX.X.Xdev-X, vX.X.X-X, vX.X.Xdev-X-<helm name> or vX.X.Xd-X-<helm name>."
          exit 1
        fi

        echo "$CI_COMMIT_TAG" | grep -Eq '.*dev.*'
        if [ $? = 0 ]; then
            REGISTRY_URL="$DEV_REGISTRY_URL"
        else
            REGISTRY_URL="$RELEASE_REGISTRY_URL"
        fi

        RPM_VERSION=$(echo "$CI_COMMIT_TAG" | cut -d"-" -f1)
        RPM_VERSION="${RPM_VERSION:1}"
        RPM_RELEASE_NUM=$(echo "$CI_COMMIT_TAG" | cut -d"-" -f2)
        SINGLE_MODULE=$(echo "$CI_COMMIT_TAG" | cut -d"-" -f3-)

        echo "RPM_VERSION: $RPM_VERSION"
        echo "RPM_RELEASE_NUM: $RPM_RELEASE_NUM"
        echo "SINGLE_MODULE: $SINGLE_MODULE"
        echo "REGISTRY_URL: $REGISTRY_URL"
        set -e # Enable exit on error
      fi

include:
  - local: gitlab/pipeline-rules.yml
  - local: gitlab/test-compile.yml
  - local: gitlab/code-analysis.yml
  - local: gitlab/confluence-publish.yml
  - local: gitlab/DIP/dip.gitlab-ci.yml
  - local: gitlab/DIP/dip.export.gitlab-ci.yml
  - local: gitlab/DIP/dip.manifest.gitlab-ci.yml
  - local: gitlab/DIP/dip.docs.gitlab-ci.yml
  - local: gitlab/DIP/dip.robot.gitlab-ci.yml
  - local: gitlab/DIP/dip.baremetal-gitlab-ci.yml
  - local: gitlab/MIP/mip.docs.gitlab-ci.yml
  - local: gitlab/GIP/gip.export.gitlab-ci.yml
  - local: gitlab/GIP/gip.docs.gitlab-ci.yml
  - local: gitlab/Drive/repo.gitlab-ci.yml
  - local: gitlab/Drive/repo.export.gitlab-ci.yml
  - local: gitlab/Drive/powershell.gitlab-export.yml
  - local: gitlab/Drive/drive.create.gitlab-ci.yml
  - local: gitlab/RPM/tfplenum.rpm.gitlab-ci.yml
  - local: component-builder/builder.gitlab-ci.yml
