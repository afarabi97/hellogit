---

- name: Delete existing config directory
  file:
    path: "{{ bro_dir }}"
    state: absent

- name: Create directories
  file:
    path: "{{ bro_dir }}/custom"
    owner: root
    group: root
    mode: u+rw,g+rw
    state: directory

- name: Create dummy rule file
  file:
    path: "{{ bro_dir }}/custom/__load__.bro"
    owner: root
    group: root
    mode: u+rw,g+rw
    state: touch

- name: Create scripts directory
  file:
    path: "{{ bro_scripts }}"
    owner: root
    group: root
    mode: 0755
    state: directory

- name: Copy custom scripts to sensors
  copy:
    src: "{{ item }}"
    dest: "{{ bro_scripts }}"
  with_fileglob:
    - "files/scripts/*"

- name: Copy files
  copy:
    src: "files/local.bro"
    dest: "{{ bro_dir }}/local.bro"
    owner: root
    group: root
    mode: 0644

- name: Setup configs
  template:
    src: "templates/{{ item }}.j2"
    dest: "{{ bro_dir }}/{{ item }}"
    owner: root
    group: root
    mode: 0644
  loop: ['filebeat.yml', 'networks.cfg', 'node.cfg', 'broctl.cfg']
  when: inventory_hostname in groups['bro']

- name: Setup deployment configs
  template:
    src: "templates/deploy.yml.j2"
    dest: "{{ bro_dir }}/{{ item }}-deploy.yml"
    owner: root
    group: root
    mode: 0644
  vars:
    hostname: "{{ item }}"
  loop: "{{ groups['bro'] }}"
  when: inventory_hostname in groups['master-server']

...
