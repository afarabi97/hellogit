######################################################
################# Setup Bro ##########################
######################################################
---

- name: "Create config directory"
  file:
    path: "{{ bro_dir }}"
    state: directory
    owner: root
    group: root
    mode: u+rw,g+rw

- name: Copy Files
  copy:
    src: "files/{{ item }}"
    dest: "{{ bro_dir }}/{{ item }}"
    group: root
    owner: root
    mode: 0644
  with_items:
    - local.bro
    - custom.bro

- name: Copy bro configuration files
  include: 15_install_templates.yml hostname="{{ item[0] }}" filename="{{ item[1] }}"
  with_nested:
    - "{{ groups['sensors'] | union(groups['remote-sensors']) }}"
    - ['deploy.yml', 'kafka.bro', 'networks.cfg', 'node.cfg', 'broctl.cfg']

- name: Flush Deployments
  command: 'kubectl --kubeconfig="{{ kubernetes_conf_file }}" delete -f {{ bro_dir }}/{{ item }}-deploy.yml --ignore-not-found=true'
  with_items:
    - "{{ groups['sensors'] }}"
  when: inventory_hostname in groups['master-server']

- name: Deploy Services
  include_role: # Using include_role because you cannot use a loop with import_role
    name: kubernetes/common
    tasks_from: kube_create
  vars:
    name: "Bro"
    file_name: "{{ bro_dir }}/{{ item }}-deploy.yml"
  with_items:
    - "{{ groups['sensors'] }}"
  when: inventory_hostname in groups['master-server']

- name: Wait for Bro to be ready
  import_role:
    name: kubernetes/common
    tasks_from: kube_wait
  vars:
    type: "deployments"
    namespace: "default"
    resource_name: "bro"
    label: ""
  when: inventory_hostname in groups['master-server']

- name: Scale up Bro Deployment
  command: "kubectl scale deployment bro --replicas={{ groups['bro'] | length }}"
  when: node_to_add is defined
    and node_to_add in groups['bro']
    and inventory_hostname in groups['master-server']
  tags:
    - bro-scale
