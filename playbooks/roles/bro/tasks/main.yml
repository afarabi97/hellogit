---

- set_fact:
    cmd: !unsafe kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}'

- name: get bro pods
  shell: |
    {{ cmd }}
  register: get_pods
  changed_when: get_pods.failed

- set_fact:
    bro_pods: []

- set_fact:
    bro_pods: "{{ bro_pods }} + [ '{{ item }}' ]"
  with_items: "{{ get_pods.stdout_lines }}"
  when: "'bro' in item"

- debug:
    msg: "{{ bro_pods }}"

- name: Get bro status
  shell: |
    kubectl exec {{ item }} -- systemctl is-active bro
  with_items: "{{ bro_pods }}"
  register: bro_status
  changed_when: bro_status.failed
  ignore_errors: yes

- name: Test | Bro service should be active
  assert:
    that: "'active' in item.stdout"
    msg: "Bro service is reporting  {{ item.stdout }}"
  with_items: "{{ bro_status.results }}"

    
...