---

- set_fact:
    cmd: !unsafe kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}'

- name: get bro pods
  shell: |
    {{ cmd }} | grep 'bro-'
  register: get_pods
  changed_when: get_pods.failed

- name: Check Bro Process
  include_role:
    name: common
    tasks_from: check_pod_process
  vars:
    app_name: "bro"
    process_name: "bro"
    pod_name: "{{ item }}"
  with_items: "{{ get_pods.stdout_lines }}"

- name: Check Bro Indicies
  import_role:
    name: common
    tasks_from: check_indices
  vars:
    app_name: "bro"
    index_regex: "^bro.*"

- name: Check Bro HTTP Result
  uri:
    url: "{{ elastic_uri }}/*bro*/_search?q=method:GET+AND+@timestamp:[now-15m+TO+now]"
    return_content: y
  register: results_bh
  until: results_bh.json.hits.total != 0
  retries: 10
  delay: 15
  ignore_errors: y

- name: Test | Check Bro HTTP Results
  assert:
    that: results_bh.json.hits.total != 0
    msg: "Failed verifying Elasticsearch received HTTP logs from Bro"

- name: Check Bro DNS Result
  uri:
    url: "{{ elastic_uri }}/*bro*/_search?q=event_type:bro_dns+AND+@timestamp:[now-15m+TO+now]"
    return_content: y
  register: results_bd
  until: results_bd.json.hits.total != 0
  retries: 5
  delay: 10
  ignore_errors: y

- name: Test | Check Bro DNS Results
  assert:
    that: results_bd.json.hits.total != 0
    msg: "Failed verifying Elasticsearch received DNS logs from Bro"

- name: Check Bro SMB Result
  uri:
    url: "{{ elastic_uri }}/*bro*/_search?q=event_type:bro_smb_mapping+AND+@timestamp:[now-15m+TO+now]"
    return_content: y
  register: results_bs
  until: results_bs.json.hits.total != 0
  retries: 5
  delay: 10
  ignore_errors: y

- name: Test | Check Bro SMB Results
  assert:
    that: results_bs.json.hits.total != 0
    msg: "Failed verifying Elasticsearch received SMB logs from Bro"

...
