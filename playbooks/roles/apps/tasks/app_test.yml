---

- set_fact:
    pods: []

- set_fact:
    pods: "{{ pods }} + [ '{{ pod_name }}' ]"
  with_items: "{{ pod_list }}"
  when: "app_name in pod_name and 'moloch-viewer' not in pod_name"
  loop_control:
    loop_var: pod_name

- set_fact:
    pod_process: "bro"
  when: app_name == 'bro'

- set_fact:
    pod_process: "suricata"
  when: app_name == 'suricata'

- set_fact:
    pod_process: "molochcapture"
  when: app_name == 'moloch'

- name: Get {{ app_name }} status
  shell: |
    kubectl exec {{ pod_name }} -- systemctl is-active {{ pod_process }}
  with_items: "{{ pods }}"
  register: pod_status
  changed_when: pod_status.failed
  ignore_errors: yes
  loop_control:
    loop_var: pod_name

- name: Test | {{ app_name }} service should be active
  assert:
    that: "'active' in pod_item.stdout"
    msg: "{{ pod_process }} service is reporting  {{ pod_item.stdout }}"
  with_items: "{{ pod_status.results }}"
  loop_control:
    loop_var: pod_item

    
...