---
- name: "{{ os_name }} block"
  block:
    - name: Make default bios {{ os_name }} {{ kick_cfg }} avail
      template:
        src: ks.cfg.j2
        dest: "{{ ks_template_dir }}/ks.cfg"
        owner: root
        group: root
        mode: 0644
        setype: httpd_sys_content_t
      vars:
        uefi: false
        
    - name: Make default uefi {{ os_name }} {{ kick_cfg }} avail
      template:
        src: ks.cfg.j2
        dest: "{{ ks_template_dir }}/uefi/ks.cfg"
        owner: root
        group: root
        mode: 0644
        setype: httpd_sys_content_t
      vars:
        uefi: true
    
    - name: Create {{ os_name }} bios ks for each server
      template:
        src: "ks.cfg.j2"
        dest: "{{ ks_template_dir }}/{{ item }}.cfg"
        owner: root
        group: root
        mode: 0644
        setype: httpd_sys_content_t
      with_items:
      - "{{ groups['servers'] }}"
      when: hostvars[item].pxe_type == 'bios'
      vars:
        uefi: false

    - name: Create {{ os_name }} uefi ks for each server
      template:
        src: "ks.cfg.j2"
        dest: "{{ ks_template_dir }}/uefi/{{ item }}.cfg"
        owner: root
        group: root
        mode: 0644
        setype: httpd_sys_content_t
      with_items:
      - "{{ groups['servers'] }}"
      when: hostvars[item].pxe_type == 'uefi'
      vars:
        uefi: true

    - name: Default {{ os_name }} PXE Menus
      template:
        src: "default.j2"
        dest: "{{ tftp_dir }}/pxelinux.cfg/default"
        owner: root
        group: root
        mode: 0644
        setype: "cobbler_var_lib_t"
      register: tftp

    - name: UEFI {{ os_name }} PXE Menus
      template:
        src: "grub.cfg.j2"
        dest: "{{ tftp_dir }}/uefi/grub.cfg"
        owner: root
        group: root
        mode: 0644
        setype: "cobbler_var_lib_t"
      register: tftp

    - name: Create {{ os_name }} bios pxe menu for each server
      template:
        src: "default.j2"
        # This takes the mac address from the inventory file for each node.
        # Replaces the colon with a dash and makes it lower case
        dest: "{{ tftp_dir }}/pxelinux.cfg/01-{{ hostvars[item].mac | regex_replace(':', '-') | lower }}"
        owner: root
        group: root
        mode: 0644
        setype: "cobbler_var_lib_t"
      register: tftp
      with_items:
      - "{{ groups['servers'] }}"
      when: hostvars[item].pxe_type == 'bios'

    - name: Create {{ os_name }} uefi pxe menu for each server
      template:
        src: "grub.cfg.j2"
        # This takes the mac address from the inventory file for each node.
        # Replaces the colon with a dash and makes it lower case
        dest: "{{ tftp_dir }}/uefi/grub.cfg-01-{{ hostvars[item].mac | regex_replace(':', '-') | lower }}"
        owner: root
        group: root
        mode: 0644
        setype: "cobbler_var_lib_t"
      register: tftp
      with_items:
      - "{{ groups['servers'] }}"
      when: hostvars[item].pxe_type == 'uefi'
  when: "'rhel' in os_name or 'centos' in os_name"

