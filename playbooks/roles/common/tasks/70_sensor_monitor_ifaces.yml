---
- block:
  - name: install inotify-tools
    yum:
      name: inotify-tools
      state: present

  - name: Create interfaces directory
    file:
      mode: u+rx,g+rx
      path: "{{ install_dir }}/interfaces"
      state: directory

  - name: Set on boot to yes
    replace:
      path: "/etc/sysconfig/network-scripts/ifcfg-{{ item }}"
      regexp: "ONBOOT=no"
      replace: "ONBOOT=yes"
    with_items: "{{ sensor_monitor_interface }}"

  - name: Set bootproto to link-local
    replace:
      path: "/etc/sysconfig/network-scripts/ifcfg-{{ item }}"
      regexp: "BOOTPROTO=none|BOOTPROTO=dhcp|BOOTPROTO=static"
      replace: "BOOTPROTO=autoip"
    with_items: "{{ sensor_monitor_interface }}"

  - name: if interface link status is up then bring up the interface
    shell: |
      link=`ethtool {{ item }} | grep "Link detected" | awk -F ":" '{gsub(/ /,"",$2); print $2 }'`
      if [[ $link == 'yes' ]]; then
          ifup {{ item }}
      fi
    with_items: "{{ sensor_monitor_interface }}"

  - name: Add promisc service
    copy:
      src: enable-promisc-mode.service
      dest: /etc/systemd/system/enable-promisc-mode.service    
      owner: root
      group: root
      mode: 0755

  - name: Create promisc script for service
    copy:
      src: "iface-promisc-mode"
      dest: "/usr/bin/iface-promisc-mode"
      group: root
      owner: root
      mode: 0755

  - name: Add promisc service
    template:
      src: templates/monitor_interfaces
      dest: "{{ install_dir }}/interfaces/monitor_interfaces"
      owner: root
      group: root
      mode: 0600
    register: interface_results

  - name: Enable promisc service
    systemd:
      name: enable-promisc-mode
      daemon-reload: yes
      state: started
      enabled: yes

  - name: Restart promisc service
    systemd:
      name: enable-promisc-mode    
      state: restarted
  when: inventory_hostname in groups['sensors'] or inventory_hostname in groups['remote-sensors']