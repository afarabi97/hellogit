---
- name: Ensure tcpreplay is installed
  yum:
    name: tcpreplay
    state: present
  changed_when: False

- name: Set Test Interface
  set_fact:
    test_interface: "{{ lookup('env', 'TEST_INTERFACE') | default('ens224', true) }}"

# Only launch the PCAP if the controller has a second interface for testing purposes.
# The playbook will not fail out if this is not the case, and will display a message
# indicating that the PCAP did not play.

- name: Announce starting PCAP test
  debug:
    msg: "{{ test_interface }} test interface detected. Starting PCAP replay..."
  when: test_interface is defined

- name: Announce when test interface not detected
  debug:
    msg: "{{ test_interface }} test interface not found. No PCAP will be played."
  when: test_interface is not defined

- name: Start Testing PCAP Replay
  shell: |
    /usr/bin/tcpreplay --loop=3 --intf1={{ test_interface }} {{ item }}
  with_fileglob:
    - "{{ install_dir }}/playbooks/roles/replay/pcaps/*"
  when: test_interface is defined
  changed_when: False

...
