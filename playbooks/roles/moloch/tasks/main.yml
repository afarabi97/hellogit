---

- set_fact:
        cmd: !unsafe kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}'

- name: get moloch pods
  shell: |
    {{ cmd }} | grep 'moloch-' | grep -Fv 'moloch-viewer'
  register: get_pods
  changed_when: get_pods.failed

- name: Check Moloch Process
  include_role:
    name: common
    tasks_from: check_pod_process
  vars:
    app_name: "moloch"
    process_name: "molochcapture"
    pod_name: "{{ item }}"
  with_items: "{{ get_pods.stdout_lines }}"

# - set_fact:
#     moloch_indices: "{{ moloch_indices }} + [ {{ item }} ]"
#   with_items: "{{ elasticsearch_indices.json }}"
#   when: "('sessions2' in item.index)
#     or ('fields' in item.index)
#     or ('queries' in item.index)
#     or ('dstats' in item.index)
#     or ('users' in item.index)
#     or ('sequence' in item.index)
#     or ('stats' in item.index)
#     or ('files' in item.index)"


- name: Check Moloch Indicies
  import_role:
    name: common
    tasks_from: check_indices
  vars:
    app_name: "moloch"
    index_regex: "^(files|stats|sequence|users|dstats|queries|fields|sessions2).*"

- name: Check HTTP Moloch Data
  uri:
    url: "{{ elastic_uri }}/sessions*/_search?q=http.method:GET+AND+timestamp:[now-15m+TO+now]"
    return_content: y
  register: results_mh
  until: results_mh.json.hits.total != 0
  retries: 60
  delay: 5
  ignore_errors: y

- name: Test | Check Moloch HTTP Results
  assert:
    that: results_mh.json.hits.total != 0
    msg: "Failed verifying Elasticsearch received HTTP logs from Moloch"

- name: Check DNS Moloch Data
  uri:
    url: "{{ elastic_uri }}/sessions*/_search?q=protocol:dns+AND+timestamp:[now-15m+TO+now]"
    return_content: y
  register: results_md
  until: results_md.json.hits.total != 0
  retries: 60
  delay: 5
  ignore_errors: y

- name: Test | Check Moloch DNS Results
  assert:
    that: results_md.json.hits.total != 0
    msg: "Failed verifying Elasticsearch received DNS logs from Moloch"

# For some reason, Moloch doesn't reliably report SMB traffic. Here's what sometimes works.
# - name: Check SMB Moloch Data
#   uri:
#     url: "{{ elastic_uri }}/sessions*/_search?q=protocol:smb+AND+timestamp:[now-15m+TO+now]"
#     return_content: y
#   register: results
#   until: results.json.hits.total != 0
#   retries: 10
#   delay: 10

...
