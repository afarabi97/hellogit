---

- name: Get elasticsearch indices
  uri:
    url: "{{ elastic_uri }}/_cat/indices?v&format=json"
  register: elasticsearch_indices

- set_fact:
    bro_indices: []

- set_fact:
    suricata_indices: []

- set_fact:
    moloch_indices: []

- set_fact:
    bro_indices: "{{ bro_indices }} + [ {{ item }} ]"
  with_items: "{{ elasticsearch_indices.json }}"
  when: "'bro' in item.index"

- set_fact:
    suricata_indices: "{{ suricata_indices }} + [ {{ item }} ]"
  with_items: "{{ elasticsearch_indices.json }}"
  when: "'suricata' in item.index"

- set_fact:
    moloch_indices: "{{ moloch_indices }} + [ {{ item }} ]"
  with_items: "{{ elasticsearch_indices.json }}"
  when: "('sessions2' in item.index) 
    or ('fields' in item.index) 
    or ('queries' in item.index) 
    or ('dstats' in item.index) 
    or ('users' in item.index) 
    or ('sequence' in item.index) 
    or ('stats' in item.index) 
    or ('files' in item.index)"

- debug:
    msg: "{{ moloch_indices }}"

- name: Test | Verify bro index is available in elasticsearch
  assert:
    that: "'green' in item.health"
    msg: "Bro index verification has failed. Bro index {{ item.index }} health is {{ item.health }}."
  with_items: "{{ bro_indices }}"

- name: Test | Verify suricata index is available in elasticsearch
  assert:
    that: "'green' in item.health"
    msg: "Suricata index verification has failed.  Suricata index {{ item.index }} health is {{ item.health }}."
  with_items: "{{ suricata_indices }}"

- name: Test | Verify moloch index is available in elasticsearch
  assert:
    that: "'green' in item.health"
    msg: "Moloch index verification has failed.  Moloch index {{ item.index }} health is {{ item.health }}."
  with_items: "{{ moloch_indices }}"


...