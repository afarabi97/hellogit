---
- import_role:
    name: cleanup
    tasks_from: cleanup
  when: "system_name == 'DIP' or system_name == 'GIP'"

- name: Set_fact bootstrap and git
  set_fact:
    BOOTSTRAP: "{{ lookup('env','BOOTSTRAP') }}"
    GIT_USERNAME: "{{ lookup('env','GIT_USERNAME') }}"
    GIT_PASSWORD: "{{ lookup('env','GIT_PASSWORD') }}"

- name: Execute RHEL repo role.
  include_role:
    name: rhel_repo
  when: "ansible_distribution == 'RedHat'"

- import_tasks: additional_repos.yml
  when: "system_name == 'DIP' or system_name == 'GIP'"

- name: "Install required packages"
  dnf:
    name: "{{ package_list }}"
    state: present
  when: "system_name == 'DIP' or system_name == 'GIP'"

- name: "Install required packages"
  dnf:
    name: "{{ mip_package_list }}"
    state: present
  when: system_name == 'MIP'

- name: Execute clone repo role.
  include_role:
    name: clonerepo

- name: Add local repo
  template:
    src: templates/offline-tfplenum.repo
    dest: "/etc/yum.repos.d/offline.repo"
  tags:
    - clonerepo
    - registry

- name: Execute docker registry role.
  include_role:
    name: registry
  when: "system_name == 'DIP' or system_name == 'GIP'"

- import_tasks: preload_rules.yml
  when: system_name == 'DIP'

- import_tasks: preload_scripts.yml
  when: system_name == 'DIP'

- import_tasks: helm.yml
  tags: helm
  when: "system_name == 'DIP' or system_name == 'GIP'"

- import_tasks: allow_shibd.yml
  when: system_name == 'MIP'

- import_role:
    name: cleanup

- import_tasks: offline_repos.yml

- name: Run dip tasks
  block:
    - import_tasks: max_log_size.yml
    - import_tasks: update_etc_hosts.yml
    - import_tasks: update_controller_interface.yml
      tags: setup_ctrl_interface
    - import_tasks: finish.yml
  when: "system_name == 'DIP' or system_name == 'GIP'"
