---

- name: Turn off network manager resolv.conf modifications
  ini_file:
    path: /etc/NetworkManager/NetworkManager.conf
    state: present
    no_extra_spaces: yes
    section: main
    option: dns
    value: none
    backup: yes
  notify:
    - "Restart NetworkManager"

- meta: flush_handlers

- name: Remove all nameservers from resolv conf
  lineinfile:
    path: "/etc/resolv.conf"
    regexp: '^nameserver'
    state: absent

- name: Update comment
  lineinfile:
    path: "/etc/resolv.conf"
    regexp: '# Generated by NetworkManager'
    line: "# Generated by tfplenum bootstrap"
    backrefs: yes

- name: Remove all nameservers from resolv conf
  lineinfile:
    path: "/etc/resolv.conf"
    line: "nameserver 127.0.0.1"
    state: present
    insertafter: "^search"
  notify:
    - "Restart Network"

- meta: flush_handlers

...
