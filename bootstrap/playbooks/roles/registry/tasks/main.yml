#######################################################
###########  Install Docker Distribution ##############
#######################################################
---

- name: Install Docker Dist
  dnf:
    name: docker-distribution
    state: installed

- name: docker-dist config template
  template:
    backup: yes
    src: config.yml.j2
    dest: "{{ registry_config }}"
    owner: root
    group: root
    mode: 0644
  register: docker_dist_config_result
  tags: pull-docker-images

- name: Enable docker distribution service
  systemd:
    name: docker-distribution
    enabled: yes
    state: started
    daemon_reload: yes
  tags: pull-docker-images

- name: Restart docker-dist # noqa 503
  service:
    name: docker-distribution
    state: restarted
    enabled: yes
  when: docker_dist_config_result.changed
  tags: pull-docker-images

- name: Install Docker
  shell: |
    dnf install -y docker-ce --nobest
  register: results
  changed_when: results.rc == 0
  args:
    warn: false

- name: Create directory docker directory
  file:
    path: /etc/docker
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Create Docker Certs Dir
  file:
    path: "/etc/docker/certs.d/sil.lab"
    state: directory
    owner: root
    group: root
    mode: 0755
  tags: pull-docker-images

- name: docker daemon conf
  template:
    backup: yes
    src: daemon.json.j2
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: 0644
  register: docker_config_result
  tags: pull-docker-images

- name: Add docker to trusted zone
  firewalld:
    interface: docker0
    zone: trusted
    state: enabled
    permanent: yes
    immediate: yes

- name: Add masquerade to trusted zone
  firewalld:
    zone: trusted
    masquerade: yes
    state: enabled
    permanent: yes
    immediate: yes

- name: Restart Docker
  systemd:
    name: docker
    enabled: yes
    state: restarted
  tags: pull-docker-images

- name: Download docker containers from nexus 10 at a time.
  vars:
    durations: "{{ item }}"
  include: pull_docker_batch.yml
  with_items:
    - "{{ kube_images | batch(10) | list }}"
  tags: pull-docker-images

- name: Tag local images for upload to registry
  command: "docker tag {{ item }} localhost:{{ firewall_port }}/{{ item[item.find('/')+1:] }}"
  register: docker_tag_results
  changed_when: docker_tag_results.rc == 0
  with_items:
    - "{{ kube_images }}"
  tags: pull-docker-images

- name: Push docker containers to docker registry in batch of ten items
  vars:
    durations: "{{ item }}"
  include: push_docker_batch.yml
  with_items:
    - "{{ kube_images | batch(10) | list }}"
  tags: pull-docker-images

...
