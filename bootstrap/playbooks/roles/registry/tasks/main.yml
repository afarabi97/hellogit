#######################################################
###########  Install Docker Distribution ##############
#######################################################
---
- name: Import tfplenum variables
  include_vars:
    file: "{{ dip_core_vars }}"
  tags: pull-docker-images

- name: Install Docker Dist
  yum:
    name: docker-distribution
    state: installed

- name: docker-dist config template
  template:
    backup: yes
    src: config.yml.j2
    dest: "{{registry_config}}"
    owner: root
    group: root
    mode: 0644
  register: docker_dist_config_result
  tags: pull-docker-images

- name: Enable docker distribution service
  systemd:
    name: docker-distribution
    enabled: yes
    state: started
    daemon_reload: yes
  tags: pull-docker-images

- name: Restart docker-dist
  service:
    name: docker-distribution
    state: restarted
    enabled: yes
  when: docker_dist_config_result.changed
  tags: pull-docker-images

- name: Install Docker
  yum:
    name: docker-ce
    state: installed

- name: Create directory docker directory
  file:
    path: /etc/docker
    state: directory
    owner: root
    group: root
    mode: 0755

- name: docker daemon conf
  template:
    backup: yes
    src: daemon.json.j2
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: 0644
  register: docker_config_result
  tags: pull-docker-images

- name: Restart Docker
  systemd:
    name: docker
    enabled: yes
    state: restarted
  tags: pull-docker-images

- set_fact:
    dockerio_images: []
    not_dockerio_images: []
    image_list: []
  tags: pull-docker-images

- set_fact:
    image_list: "{{ image_list }} + ['{{item.image}}']"
  with_items:
    - "{{ kube_images }}"
  when: (system_name == "GIP" and item.for_gip) or
        (system_name == "DIP" and item.for_dip) or
        (system_name == "MIP")
  tags: pull-docker-images

- set_fact:
    dockerio_images: "{{ dockerio_images }} + ['{{item}}']"
  with_items:
    - "{{ image_list }}"
  when: "'docker.io' in item"
  tags: pull-docker-images

- set_fact:
    not_dockerio_images: "{{ not_dockerio_images }} + ['{{item}}']"
  with_items:
    - "{{ image_list }}"
  when: "'docker.io' not in item"
  tags: pull-docker-images

- name: Download docker container images from docker hub
  shell: |
    docker pull {{ item }}
  with_items:
    - "{{ dockerio_images }}"
  async: 2500
  poll: 0
  register: dockerio_pull_results
  tags: pull-docker-images

- name: Waiting for docker hub images to download
  async_status:
    jid: "{{ async_result_item.ansible_job_id }}"
  loop: "{{ dockerio_pull_results.results }}"
  loop_control:
    loop_var: "async_result_item"
  register: job_results
  until: job_results.finished is defined and job_results.finished
  retries: 120
  tags: pull-docker-images

- name: Remove Proxy from docker registry
  lineinfile:
    path: "{{registry_config}}"
    state: absent
    line: "{{item}}"
  with_items:
    - "proxy:"
    - "  remoteurl: https://registry-1.docker.io"
  register: docker_dist_config_result
  tags: pull-docker-images

- name: Restart docker-dist
  service:
    name: docker-distribution
    state: restarted
    enabled: yes
  when: docker_dist_config_result.changed
  tags: pull-docker-images

- name: Download docker container images from internet
  shell: |
    docker pull {{ item }}
  with_items:
    - "{{ not_dockerio_images }}"
  async: 2500
  poll: 0
  register: docker_pull_results
  tags: pull-docker-images

- name: Waiting for docker images to download
  async_status:
    jid: "{{ async_result_item.ansible_job_id }}"
  loop: "{{ docker_pull_results.results }}"
  loop_control:
    loop_var: "async_result_item"
  register: job_results
  until: job_results.finished is defined and job_results.finished
  retries: 120
  tags: pull-docker-images

- name: Tag local images for upload to registry
  shell: "docker tag {{ item }} localhost:{{ firewall_port }}/{{ item[item.find('/')+1:] }}"
  with_items:
    - "{{ image_list }}"
  tags: pull-docker-images

- name: Upload local images to registry
  shell: |
    docker push localhost:{{ firewall_port }}/{{ item[item.find('/')+1:] }}
  with_items:
    - "{{ image_list }}"
  async: 2500
  poll: 0
  register: docker_push_results
  tags: pull-docker-images

- name: Waiting for docker images to push
  async_status:
    jid: "{{ async_result_item.ansible_job_id }}"
  loop: "{{ docker_push_results.results }}"
  loop_control:
    loop_var: "async_result_item"
  register: job_push_results
  until: job_push_results.finished is defined and job_push_results.finished
  retries: 120
  tags: pull-docker-images

...
