---

- name: Install Httpd
  dnf:
    name:
      - httpd
      - mod_ssl
      - shibboleth
    state: present

- name: Allow Httpd Selinux connection
  seboolean:
    name: httpd_can_network_connect
    state: yes
    persistent: yes

- name: Create Certificate Directory
  file:
    path: /etc/ssl/private
    state: directory
    mode: 0700

- name: Generate an OpenSSL private key.
  openssl_privatekey:
    path: "{{ private_key }}"

- name: Generate an OpenSSL CSR
  openssl_csr:
    path: "{{ certificate_request }}"
    privatekey_path: "{{ private_key }}"
    country_name: US
    state_or_province_name: Texas
    locality_name: Dallas
    organization_name: unknown
    common_name: tfplenum

- name: Generate a Self Signed OpenSSL certificate
  openssl_certificate:
    path: "{{ certificate }}"
    privatekey_path: "{{ private_key }}"
    csr_path: "{{ certificate_request }}"
    provider: selfsigned

- name: Create dod_certs Directory
  file:
    path: "{{ offline_cert_dir }}"
    state: directory
    mode: '0755'

- name: Download DOD Root CAs
  get_url:
    url: "{{ item }}"
    dest: "{{ offline_cert_dir }}/"
  with_items:
    - "{{ dod_nmil_download }}"
    - "{{ dod_smil_download }}"

- name: Apply NMIL Certs
  command: cp {{ offline_cert_dir }}/{{ dod_nmil_file }} /etc/httpd/conf.d/dod_root.pem

- name: Remove default httpd files
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/httpd/conf.d/ssl.conf
    - /etc/httpd/conf.d/welcome.conf

- name: Create tfplenum-backend service
  copy:
    src: files/tfplenum-backend.service
    dest: /etc/systemd/system/tfplenum-backend.service

- name: Reload systemd
  systemd:
    daemon-reload: yes

- name: Stop tfplenum-backend service
  systemd:
    name: tfplenum-backend
    enabled: yes
    state: stopped
  ignore_errors: yes

- name: Add tfplenum httpd config
  copy:
    src: files/tfplenum.conf
    dest: /etc/httpd/conf.d/tfplenum.conf

- name: Restart httpd
  systemd:
    name: httpd
    state: restarted
