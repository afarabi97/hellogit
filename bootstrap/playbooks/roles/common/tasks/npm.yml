---

- name: Check if npm is installed
  stat:
    path: /usr/local/bin/npm
  register: npm_stat_result

- name: Set npm registry
  set_fact:
    npm_registry: https://registry.npmjs.org/

- block:
  - name: Set npm to labrepo
    set_fact:
      npm_registry: "https://{{ nexus_url }}/repository/npm/"

  - name: Get Nexus Cert
    get_url:
      url: "{{ misc_server }}/{{ nexus_url }}.crt"
      dest: "/root/{{ nexus_url }}.crt"
  - name: Use labrepo nexus npm proxy
    command: "npm config set cafile /root/{{ nexus_url }}.crt"
    when: npm_stat_result.stat.exists
  when: labrepo_check

- name: Use labrepo nexus npm proxy
  command: "npm config set registry {{ npm_registry }}"
  when: npm_stat_result.stat.exists
