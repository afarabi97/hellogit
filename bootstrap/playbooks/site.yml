# site.yml is the overall playbook, but all it does is include the other playbooks that are part of the site. For more
# information about the structure see:
# http://docs.ansible.com/ansible/latest/playbooks_best_practices.html
# http://docs.ansible.com/ansible/latest/intro_inventory.html
# We follow the guidance to include naming conventions there.

---
- name: Set Variables
  hosts: localhost
  any_errors_fatal: true
  tasks:
    - block:
      - name: Set RHEL ISO To server for DIP bootstrap
        set_fact:
          iso_rhel_checksum: "{{ iso_rhel_server_checksum }}"
          iso_rhel_url_labrepo: "{{ iso_rhel_server_url_labrepo }}"
          iso_rhel_path: "{{ iso_rhel_server_path }}"
      - name: Import DIP/GIP variables
        include_vars:
          file: "{{ dip_core_vars }}"
      when:
        - "system_name == 'DIP' or system_name == 'GIP'"
    - name: Set RHEL ISO To workstation for MIP bootstrap
      set_fact:
        iso_rhel_checksum: "{{ iso_rhel_worstation_checksum }}"
        iso_rhel_url_labrepo: "{{ iso_rhel_workstation_url_labrepo }}"
        iso_rhel_path: "{{ iso_rhel_worstation_path }}"
      when:
        - "system_name == 'MIP'"

    - name: Check for labrepo
      uri:
        url: http://labrepo.sil.lab/check.html
        return_content: yes
        status_code: 201, 200
      register: labrepo_results
      ignore_errors: yes

    - name: Set labrepo variable
      set_fact:
        labrepo_check: "{{ labrepo_results.content|from_json }}"
        cacheable: yes
      ignore_errors: yes
  tags: always

- name: Execute Pre
  hosts: localhost
  any_errors_fatal: true
  roles:
    - execute_pre
  tags: execute_pre

- name: Setup Frontend
  hosts: localhost
  any_errors_fatal: true
  roles:
    - frontend
  tags: frontend

- name: Setup Single Sign On
  hosts: localhost
  any_errors_fatal: true
  roles:
    - sso
  tags: sso

- name: Bootstrap DIP/GIP Controller
  hosts: localhost
  any_errors_fatal: true
  roles:
    - dip_bootstrap
  tags:
    - dip_bootstrap

- name: Rerun docker pull
  hosts: localhost
  any_errors_fatal: true
  roles:
    - registry
  tags:
    - pull-docker-images

- name: Bootstrap MIP Controller
  hosts: localhost
  gather_facts: no
  roles:
    - mip_bootstrap
  tags:
    - mip_bootstrap
