# site.yml is the overall playbook, but all it does is include the other playbooks that are part of the site. For more
# information about the structure see:
# http://docs.ansible.com/ansible/latest/playbooks_best_practices.html
# http://docs.ansible.com/ansible/latest/intro_inventory.html
# We follow the guidance to include naming conventions there.

---
- name: Set Variables
  hosts: localhost
  any_errors_fatal: true
  tasks:
    - block:
      - name: Set RHEL ISO To server for Bootstrap
        set_fact:
          iso_rhel_checksum: "{{ iso_rhel_server_checksum }}"
          iso_rhel_url_labrepo: "{{ iso_rhel_server_url_labrepo }}"
          iso_rhel_path: "{{ iso_rhel_server_path }}"
      - name: Import DIP/GIP variables
        include_vars:
          file: "{{ dip_core_vars }}"
  tags: always

- name: Execute Pre
  hosts: localhost
  any_errors_fatal: true
  roles:
    - execute_pre
  tags: execute_pre

- name: Setup Frontend
  hosts: localhost
  any_errors_fatal: true
  roles:
    - frontend
  tags: frontend

- name: Setup Single Sign On
  hosts: localhost
  any_errors_fatal: true
  roles:
    - sso
  tags: sso

- name: Bootstrap Controller
  hosts: localhost
  any_errors_fatal: true
  roles:
    - bootstrap
  tags:
    - bootstrap

- name: Rerun docker pull
  hosts: localhost
  any_errors_fatal: true
  roles:
    - registry
  tags:
    - registry
    - pull-docker-images

- name: Setup chart museum
  hosts: localhost
  any_errors_fatal: true
  roles:
    - chartmuseum
  tags:
    - chartmuseum

- name: Run Stigs
  hosts: localhost
  gather_facts: no
  any_errors_fatal: true
  tasks:
    - name: Run Controller Stigs
      include_tasks: "{{ tfplenum_root_dir }}/rhel8-stigs/rhel8-playbook-stig.yml"
  tags:
    - stigs
