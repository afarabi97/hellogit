---

- set_fact:
    chartmuseum_deployed: false

- name: Check if chartmuseum rest api exists
  uri:
    url: https://chartmuseum.{{ fqdn }}:8080
    return_content: yes
    validate_certs: false
  register: chartmuseum_results
  ignore_errors: yes

- name: Check if chartmuseum release exists
  shell: |
    helm list --filter=chartmuseum --output json
  register: chartmuseum_helm_results

- set_fact:
    chartmuseum_helm_results_json: "{{chartmuseum_helm_results.stdout|from_json}}"
  when: chartmuseum_helm_results.stdout != ''

- debug:
    msg: "{{chartmuseum_helm_results_json}}"

- set_fact:
    chartmuseum_deployed: true
  when: chartmuseum_helm_results_json is defined and (item.status == 'DEPLOYED' or item.status == 'FAILED')
  with_items: "{{chartmuseum_helm_results_json}}"

- set_fact:
    chartmuseum_deployed: true
  when: chartmuseum_results.status == 200
