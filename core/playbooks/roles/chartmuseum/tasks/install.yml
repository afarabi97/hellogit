---
- name: Create install directory
  file:
    path: "{{ chartmuseum_install_dir }}"
    owner: root
    group: root
    mode: 0644
    state: directory

- name: Download chartmuseum chart
  get_url:
    url: "{{ offline_repo_base }}/charts/chartmuseum-{{ chartmuseum_version }}.tgz"
    dest: "{{ chartmuseum_install_dir }}/chartmuseum-{{ chartmuseum_version }}.tgz"

- name: Install Chartmuseum
  shell: |
    helm install chartmuseum chartmuseum-{{ chartmuseum_version }}.tgz --set domain={{ kit_domain }}
  args:
    chdir: "{{ chartmuseum_install_dir }}"
  changed_when: results.rc == 0
  register: results
  until: results.rc == 0
  retries: 10
  delay: 5

- name: Wait for chartmuseum to be ready
  wait_for:
    port: 443
    host: chartmuseum.{{ kit_domain }}
    connect_timeout: 3
    delay: 3
    timeout: 180
