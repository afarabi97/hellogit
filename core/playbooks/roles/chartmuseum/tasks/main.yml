---

- import_tasks: uninstall.yml
  when: inventory_hostname in groups['master_server']

- import_tasks: install.yml
  when: inventory_hostname in groups['master_server']

- name: Create directory
  file:
    path: "/root/.config/helm/"
    owner: "root"
    group: "root"
    mode: 0755
    state: directory

- name: Copy Repo Config
  template:
    src: templates/repositories.yaml
    dest: /root/.config/helm/repositories.yaml
    mode: 0644
    owner: root
    group: root

- block:
  - name: Copy Charts to master server
    copy:
      src: /var/www/html/offlinerepo/charts/
      dest: "{{ chartmuseum_install_dir }}/charts"
  - name: Get list of charts
    find:
      paths: "{{ chartmuseum_install_dir }}/charts"
    register: charts
  - name: Upload charts into Chartmuseum
    uri:
      url: "https://chartmuseum.{{ kit_domain }}/api/charts"
      src: "{{ item.path }}"
      method: POST
      status_code: 201, 200
      return_content: yes
      remote_src: 'yes'
    with_items: "{{ charts.files }}"
    register: results
    until: results.status == 201 and results.json.saved
    retries: 10
    delay: 5
  when: inventory_hostname in groups['master_server']

- name: update helm repo
  shell: |
    helm repo update
  register: results
  changed_when: results.rc == 0
