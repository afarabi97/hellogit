---

- name: Get list of custom helm charts
  find:
    paths: /opt/tfplenum/charts/
    file_type: directory
    recurse: no
  register: custom_charts
  tags: build-charts

- name: Build charts
  shell: |
    helm package {{ item.path }} -d {{ chart_dir }}
  register: results
  changed_when: results.rc == 0
  with_items: "{{ custom_charts.files }}"
  tags: build-charts

- name: Get Chartmuseum services ip
  shell: |
    set -o pipefail
    kubectl get svc chartmuseum --no-headers | awk '{ print $4 }'
  register: chartmusuem_ip
  changed_when: False
  tags: load-charts

- name: Get list of all helm charts
  find:
    paths: "{{ chart_dir }}"
  register: all_charts
  tags: load-charts

- name: Upload charts into Chartmuseum
  uri:
    url: "https://{{ chartmusuem_ip.stdout }}/api/charts"
    src: "{{ item.path }}"
    method: POST
    status_code: 201, 200
    return_content: yes
    validate_certs: no
  with_items: "{{ all_charts.files }}"
  register: results
  until: results.status == 201 and results.json.saved
  retries: 10
  delay: 5
  tags: load-charts
