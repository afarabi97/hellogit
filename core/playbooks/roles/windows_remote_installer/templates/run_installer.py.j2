#!/bin/python
"""Run the Ansible playbook to install/remove Windows monitoring agents

This script runs an ansible playbook for remotely installing/removing Windows
monitoring agents. Reads a file containing the return value of the Windows
script, prints out and returns that value.

:param: One positional parameter, the Windows password
"""

import subprocess
import sys
from sys import exit
from os.path import isfile

result_val = ~0
windows_password = sys.argv[1]
try:
    stdout, stderr = subprocess.Popen([
        'ansible-playbook',
            '-i','windows_inventory.yml',
            '--tags', '{{ docker_tags }}',
            '--extra-vars', str({ 'ansible_password': windows_password }),
            'install_agents.yml'],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE).communicate()


    result_filename = 'results.txt'
    if isfile(result_filename):
        with open(result_filename) as result_file:
            result_val = int(result_file.readline())
    else:
        print("Could not open {}".format(result_filename))
        result_val = 99
except:
    result_val = ~0


print(result_val)
if result_val != 0:
    print(stdout)
    print(stderr)

print(result_val)
exit(result_val)
