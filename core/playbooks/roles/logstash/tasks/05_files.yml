---

- name: Delete existing directory
  file:
    path: "{{ logstash_dir }}"
    state: absent

- name: "Create directory"
  file:
    path: "{{ logstash_dir }}/pipeline"
    mode: u+rw,g+rw
    owner: "{{ logstash_user }}"
    group: "{{ logstash_group }}"
    state: directory

- name: Setup templates
  template:
    src: "templates/{{ item }}.j2"
    dest: "{{ logstash_dir }}/{{ item }}"
    owner: "{{ logstash_user }}"
    group: "{{ logstash_group }}"
    mode: 0644
  with_items:
    - deploy.yml
    - logstash.yml
    - svc.yml
    - jvm.options

- name: Setup pipeline templates
  template:
    src: "{{ item }}"
    dest: "{{ logstash_dir }}/pipeline/{{ item | basename | regex_replace('\\.j2','') }}"
    owner: "{{ logstash_user }}"
    group: "{{ logstash_group }}"
    mode: 0644
  with_fileglob:
    - "templates/pipeline/*.j2"

- name: Copy additional files
  copy:
    src: "files/"
    dest: "{{ logstash_dir }}"
    owner: "{{ logstash_user }}"
    group: "{{ logstash_group }}"
    mode: 0644

- name: Create main configmap
  shell: |
    kubectl create configmap logstash \
    --from-file {{ logstash_dir }}/logstash-template.json \
    --from-file {{ logstash_dir }}/logstash.yml \
    --from-file {{ logstash_dir }}/log4j2.properties \
    --from-file {{ logstash_dir }}/jvm.options \
    --dry-run -o yaml | kubectl replace --force -f -

- name: Create pipeline configmap
  shell: |
    kubectl create configmap logstash-pipeline --from-file {{ logstash_dir }}/pipeline --dry-run -o yaml | kubectl replace --force -f -

...
