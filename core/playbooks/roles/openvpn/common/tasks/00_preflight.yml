---
- name: set existing pki
  set_fact:
    existing_pki: False

- name: Install net-tools
  yum:
    name:
      - bridge-utils
      - net-tools
    state: present

- name: Copy easy-rsa executable to /etc/openvpn
  shell: |
    cp -r /usr/share/easy-rsa/3/* /etc/openvpn/
  register: results
  changed_when: results.rc == 0

- name: Check for existing pki
  stat:
    path: "{{ ovpn_dir }}/pki/private/{{ inventory_hostname_short }}.key"
  register: existing_key
  delegate_to: "{{ groups['master_server'][0] }}"

- name: Check for server ca
  stat:
    path: "{{ ovpn_dir }}/pki/ca.crt"
  register: existing_ca
  when: inventory_hostname in groups['master_server']

- name: set existing pki
  set_fact:
    existing_pki: True
  when: existing_key.stat.exists

- name: set existing pki
  set_fact:
    existing_pki: True
  when:
    - inventory_hostname in groups['master_server']
    - (existing_ca.stat.exists or existing_pki)
