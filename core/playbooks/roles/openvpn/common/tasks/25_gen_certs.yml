---

- name: Generate a PKI request for all remote sensors
  shell: |
    ./easyrsa --batch gen-req {{ hostvars[item].inventory_hostname_short }} nopass
  args:
    chdir: "{{ ovpn_dir }}"
  when: not hostvars[item].existing_pki
  with_items: "{{ groups['sensors'] }}"
  environment:
    EASYRSA_REQ_CN: "{{ hostvars[item].inventory_hostname_short }}"
  register: results
  changed_when: results.rc == 0

- name: Sign pki request for remote sensors
  shell: |
    ./easyrsa --batch sign-req client {{ hostvars[item].inventory_hostname_short }}
  args:
    chdir: "{{ ovpn_dir }}"
  when: not hostvars[item].existing_pki
  with_items: "{{ groups['sensors'] }}"
  environment:
    EASYRSA_REQ_CN: "{{ hostvars[item].inventory_hostname_short }}"
  register: results
  changed_when: results.rc == 0

- name: Pull ca to sensor
  shell: |
    /usr/bin/scp {{ ovpn_dir }}/pki/ca.crt {{ item }}:{{ ovpn_dir }}/pki/
  with_items: "{{ groups['sensors'] }}"
  register: results
  changed_when: results.rc == 0

- name: Pull client certs to sensor
  shell: |
    /usr/bin/scp {{ ovpn_dir }}/pki/issued/{{ hostvars[item].inventory_hostname_short }}.crt {{ item }}:{{ ovpn_dir }}/
  with_items: "{{ groups['sensors'] }}"
  register: results
  changed_when: results.rc == 0

- name: Pull client key to local directory
  shell: |
    /usr/bin/scp {{ ovpn_dir }}/pki/private/{{ hostvars[item].inventory_hostname_short }}.key {{ item }}:{{ ovpn_dir }}/pki/private/
  with_items: "{{ groups['sensors'] }}"
  register: results
  changed_when: results.rc == 0
