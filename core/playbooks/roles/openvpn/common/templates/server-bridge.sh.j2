#!/bin/bash
GW_IP=$(ip route | grep default | cut -d ' ' -f3 | head -n1)
openvpn --mktun --dev tap0
ip link set br0 down
brctl delbr br0
rm /etc/sysconfig/network-scripts/ifcfg-br0
MANAGEMENT_IFACE={{ management_interface }}
brctl addbr br0
brctl addif br0 $MANAGEMENT_IFACE tap0
ifconfig tap0 0.0.0.0 promisc up
ifconfig $MANAGEMENT_IFACE 0.0.0.0 promisc up
ifconfig br0 {{ hostvars[groups['master_server'][0]].management_ipv4 }} netmask 255.255.255.0 up
ip route add default via $GW_IP dev br0
firewall-cmd --permanent --add-masquerade
firewall-cmd --add-masquerade
hash docker 2>/dev/null || exit 0
docker restart -t1 `docker ps | grep flanneld | awk '{print $1}'`
