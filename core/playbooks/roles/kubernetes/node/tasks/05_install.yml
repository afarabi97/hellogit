#######################################################
###################  Kubernetes Setup Nodes ###############
#######################################################
---
- block:
  - name: Install Api Mesh
    import_role:
      name: kubernetes/api-mesh
  when:
    - enable_kube_ha
    - inventory_hostname in groups['servers']
    - is_control_plane_node

- name: Kube | Retrieve generated credentials
  import_role:
    name: kubernetes/common
    tasks_from: creds

- name: Kube | Control Plane Join Script for Kube Masters
  set_fact:
    join_script_file: files/join-control-plane.sh
  when:
    - enable_kube_ha
    - inventory_hostname in groups['servers']
    - is_control_plane_node

- name: Kube | Copy join node cmd to nodes
  copy:
    src: "{{ join_script_file }}"
    dest: "{{ join_script_path }}"
    mode: 0755

- name: Kube | Join Kubernetes cluster
  shell: |
    "{{ join_script_path }}"
  register: join_results
  changed_when: join_results.rc == 0
  when:
    - enable_kube_ha
    - inventory_hostname in groups['servers']
    - is_control_plane_node

- name: Kube | Join Kubernetes cluster
  shell: |
    "{{ join_script_path }}"
  register: join_results
  changed_when: join_results.rc == 0
  when: inventory_hostname in groups['sensors'] or (inventory_hostname in groups['servers'] and is_control_plane_node == False)

- name: Kube | Wait for Nodes to Register
  pause:
    seconds: 10

- name: Wait for Calico CNI to be created
  wait_for:
    path: "{{item}}"
  with_items:
    - /etc/cni/net.d/calico-kubeconfig
    - /etc/cni/net.d/10-calico.conflist
    - /opt/cni/bin/calico

- name: Restart Crio and Kubelet
  service:
    state: restarted
    name: "{{item}}"
  with_items:
    - crio
    - kubelet

- name: Kube | Wait for Node to be ready
  import_role:
    name: kubernetes/common
    tasks_from: kube_wait
  vars:
    type: "node"
    namespace: ""
    resource_name: "{{ ansible_fqdn }}"
    label: ""

- name: Kube | Label sensors
  command: 'kubectl label nodes {{ ansible_fqdn }} role=sensor --overwrite=true'
  when: inventory_hostname in groups['sensors']

- name: Kube | Label secondary servers
  command: 'kubectl label nodes {{ ansible_fqdn }} role=server --overwrite=true'
  when: inventory_hostname in groups['servers']
  register: debug_output

- name: Kube | Remove NoSchedule Taint
  shell: |
    kubectl taint node {{ ansible_fqdn }} node-role.kubernetes.io/master-
  when:
    - enable_kube_ha
    - inventory_hostname in groups['servers']
    - is_control_plane_node
