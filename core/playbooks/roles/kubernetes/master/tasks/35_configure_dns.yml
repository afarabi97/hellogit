---

- name: Override DNS if not provided
  set_fact:
    dns_ip: "{{ hostvars[groups['master_server'][0]].management_ipv4 }}"
  when: dns_ip is not defined or dns_ip is none

- name: Kube | Get kube-dns IP
  shell: "kubectl get svc -n kube-system | grep kube-dns | awk '{print $3}'"
  register: kube_dns_ip

- name: Verify kube_dns is valid
  fail:
    msg: "We were not able to get kubedns with kubectl get svc -n kube-system | grep kube-dns | awk '{print $3}'. Kubedns value is {{ kube_dns_ip }}. This means we couldn't update resolv.conf with kubedns which would cause a failure so we are exiting. This means that for whatever reason Kubernetes' DNS service wasn't running."
  when: (kube_dns_ip.stdout | ipv4) != kube_dns_ip.stdout

- name: Kube | Insert kube-dns into dnsmasq
  lineinfile:
    path: /etc/dnsmasq.conf
    line: 'server=/cluster.local/{{ kube_dns_ip.stdout }}'
  when: inventory_hostname in groups['master_server']

- name: Bump the dnsmasq service
  systemd:
    name: dnsmasq
    daemon-reload: yes
    state: restarted

# DNS template must be copied after dns_ip variable is populated
- name: 'Install DNS template'
  template:
    src: "{{ item }}.yml.j2"
    dest: "{{ kube_dir }}/{{ item }}.yml"
    owner: root
    group: root
    mode: 0644
  with_items:
    - coredns_config_map

- name: Create DNS ConfigMap
  shell: |
    kubectl create configmap coredns --from-file Corefile={{ kube_dir }}/coredns_config_map.yml --dry-run -o yaml | kubectl replace --force --namespace=kube-system -f -

...
