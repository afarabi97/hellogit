---
- name: Wait for Calico to be ready
  import_role:
    name: kubernetes/common
    tasks_from: kube_wait
  vars:
    type: "pod"
    namespace: "kube-system"
    resource_name: ""
    label: "k8s-app=calico-kube-controllers"
  register: result
  until: result.rc == 0
  retries: 60
  delay: 10

- name: Install Calicoctl
  command: "kubectl apply -f calicoctl.yml"
  register: result
  changed_when: result.rc == 0
  args:
    chdir: "{{ kube_dir }}"

- name: Calicoctl Alias
  lineinfile:
    dest: "~/.bashrc"
    create: yes
    mode: 0644
    line: 'alias calicoctl="kubectl exec -i -n kube-system calicoctl /calicoctl -- "'
    regexp: "^alias calicoctl="
  delegate_to: "{{ item }}"
  loop: "{{ groups['servers'] }}"

- name: Update Calico IP Pool Config
  shell: |
    /bin/bash -i -c "calicoctl replace -f - < ipip.yml"
  args:
    chdir: "{{ kube_dir }}"
  register: result
  changed_when: True
  until: result.rc == 0
  retries: 60
  delay: 10

# - name: Update Felix Config
#   shell: |
#     /bin/bash -i -c "calicoctl replace -f - < felix.yml"
#   args:
#     chdir: "{{ kube_dir }}"
#   register: result
#   changed_when: True
#   until: result.rc == 0
#   retries: 60
#   delay: 10
