---

- name: Kube | Init Kubernetes cluster
  shell: "kubeadm init --config {{ kube_dir }}/kubeadm.conf"
  register: init_kube_cluster_result
  failed_when: "'ERROR' in init_kube_cluster_result.stderr"

- name: Create Join Script
  shell: |
    kubeadm token create --ttl 0 --print-join-command 2>/dev/null > /etc/kubernetes/join-node.sh

- name: Kube | Retrieve files
  fetch:
    src: "{{ item }}"
    dest: files/
    flat: yes
  with_items:
    - "{{ kubernetes_conf_file }}"
    - "/etc/kubernetes/join-node.sh"
  tags: pull_join_script

- name: Retrieve generated credentials
  import_role:
    name: kubernetes/common
    tasks_from: creds

- name: Install Calico
  command: "kubectl apply -f {{ kube_dir }}/calico.yml"

- name: Wait for Calico CNI to be created
  wait_for:
    path: "{{item}}"
  with_items:
    - /etc/cni/net.d/calico-kubeconfig
    - /etc/cni/net.d/10-calico.conflist
    - /opt/cni/bin/calico

- name: Restart Crio and Kubelet
  service:
    state: restarted
    name: "{{item}}"
  with_items:
    - crio
    - kubelet

- name: Kube | Wait for Master Node to be ready
  import_role:
    name: kubernetes/common
    tasks_from: kube_wait
  vars:
    type: "node"
    namespace: ""
    resource_name: "{{ ansible_fqdn }}"
    label: ""
