#######################################################
###################  Kubernetes Reset ###############
#######################################################
---
- name: Stop Kubelet
  systemd:
    name: "kubelet"
    state: stopped
  ignore_errors: yes

- name: Reset Kubernetes Node
  command: kubeadm reset --cri-socket=/var/run/crio/crio.sock -f
  register: kube_reset_result
  ignore_errors: yes

- name: Stop CRI-O
  systemd:
    name: "crio"
    state: stopped
  ignore_errors: yes

- name: Remove Kubernetes Packages to clear cache
  yum:
    name:
      - kubeadm
      - kubelet
      - kubectl
    state: absent
  ignore_errors: yes

- name: Remove Artifacts
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /var/lib/cni
    - /var/lib/kubelet
    - /etc/kubernetes
    - /var/lib/etcd
    - "{{kubeconfig_dir}}"
  register: remove_artifacts_result
  failed_when: "'Device or resource busy' in remove_artifacts_result"

- name: Delete Kubernetes directory
  file:
    path: "{{ kube_dir }}"
    state: absent

- name: Remove Interfaces
  shell: |
    ip link delete {{ item }};
  with_items:
    - cni0
  ignore_errors: yes
