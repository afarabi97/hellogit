#Make a Windows self-extracting archive for Sysmon and Winlogbeat
---
- name: Download Tools
  include: Download_Tools.yml

- name: Get Paths of Powershell Scripts and Config File Templates
  find: 
    path: "{{ role_path }}/templates"
    patterns: '*.md.j2,*.ps1.j2,*.yml.j2,*.yaml.j2'
  delegate_to: localhost
  run_once: true
  register: all_templates

- name: Get Path of Winlogbeat Installer
  find: 
    path: "{{ role_path }}/files"
    patterns: 'winlogbeat*.zip'
  delegate_to: localhost
  run_once: true
  register: winlogbeat_installer

- name: Get Endgame Agent Installer
  include: Download_Endgame.yml
  when: install_endgame | upper == 'TRUE'

- name: Build Powershell Scripts and Config Files
  template:
    src: "{{ item.path }}"
    dest: "{{ role_path }}/files/{{ item.path | basename | regex_replace('.j2', '') }}"
    newline_sequence: \r\n
  delegate_to: localhost
  loop: "{{ all_templates.files }}"
  run_once: true

- name: Find Local Powershell Scripts 
  find: 
    path: "{{ role_path }}/files"
    patterns: '*.ps1'
  delegate_to: localhost
  run_once: true
  register: powershell_scripts_found

- name: Get Paths of Powershell Scripts 
  set_fact:
    powershell_scripts: "{{ powershell_scripts | default([]) + [ item.path ] }}"
  with_items:
    "{{ powershell_scripts_found.files }}"

- name: Find Local YAML Config Files
  find: 
    path: "{{ role_path }}/files"
    patterns: '*.yml,*.yaml'
  delegate_to: localhost
  run_once: true
  register: config_files_found

- name: Get Paths of YAML Config Files
  set_fact:
    config_files: '{{ config_files | default([""]) + [ item.path ] }}'
  with_items:
    "{{ config_files_found.files }}"

- name: Remove Unneeded Config Files 
  set_fact: 
    needed_config_files: '{{ needed_config_files | default([""]) + [ item ] }}'
  when: not (item | basename == "winlogbeat.yml") or (install_winlogbeat | upper == "TRUE")
  with_items:
    "{{ config_files }}"

- name: Create Self-Extracting Zipfile
  script: 
    buildSelfExtractingArchive.py
      --destination "{{ installer_dir }}/{{ installer_name }}"
      --files
        {{ powershell_scripts | join( ' ' ) }}
        {{ 'Sysmon.zip' if install_sysmon | upper == 'TRUE' else '' }}
        {{ winlogbeat_installer.files.0.path if install_winlogbeat | upper == 'TRUE' else ''  }}
        {{ endgame_installer if install_endgame | upper == 'TRUE' else '' }}
        README.md
        {{ needed_config_files | join( ' ' ) }} 
  args:
    chdir: "{{ role_path }}/files"
    executable: python
  delegate_to: localhost
  run_once: true

- name : Remove Locally Constructed Files
  file:
    state: absent
    path: "{{ item }}"
  loop: "{{ powershell_scripts }} + {{ config_files }}"
  delegate_to: localhost
  run_once: true

- name: Remove Downloaded Files 
  file:
    state: absent
    path:  "{{ role_path }}/files/{{ item | basename }}"
  loop: "{{ tool_binaries + [ endgame_installer | default('unlikely_filename') ] + [ 'README.md' ] }}" 
  delegate_to: localhost
  run_once: true
