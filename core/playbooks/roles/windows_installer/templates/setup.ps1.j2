{% if install_winlogbeat | upper == 'TRUE' %}
Param (
  #Winlogbeat Params
  [string]$logstash_host = $null,
  [string]$logstash_port = $null,
  [switch]$help = $null
)

{% endif %}
if ( -not ([Security.Principal.WindowsPrincipal] `
            [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole( `
            [Security.Principal.WindowsBuiltInRole] "Administrator") ) {
 Write-Error "Must have administrator privileges to run this script."
 exit 1
}

{% if install_winlogbeat | upper == 'TRUE' %}
if ( $help ) {
  "Usage: setup.ps1 [ -logstash_host host_ip ] [ -logstash_port port_num ]"
  "`t-logstash_host host_ip`t`tUse host_ip as the LogstashSearch host"
  "`t-logstash_port port_num`tUse port_num as the LogstashSearch port"
  exit
}

function ReplaceInFile([string]$filename, [string]$old_text, [string]$new_text) {
  if($new_text -and $old_text -ne $new_text) {
    (Get-Content $filename -Raw).Replace($old_text, $new_text) | Set-Content $filename
  }
}

function RegexReplaceInFile([string]$filename, `
                            [string]$prefix, `
                            [string]$target, `
                            [string]$new_text) {
  $Matches.clear()
  $srch = ("(?ms)(?<pfx>" + $prefix + ")(?<tgt>" + $target + ")")
  (Get-Content $filename -Raw) -match $srch
  ReplaceInFile -filename $filename `
                -old_text ($Matches.pfx + $Matches.tgt) `
                -new_text ($Matches.pfx + $new_text)
}

#Install Winlogbeat
$wlb = "{{ winlogbeat_installer.files.0.path | win_basename | regex_replace('.zip', '') }}"
Expand-Archive .\$wlb.zip -Destination {{ target_dir }}\
Rename-Item -Path {{ target_dir }}\$wlb -NewName Winlogbeat
[string]$wlb_config = "{{ target_dir }}\Winlogbeat\winlogbeat.yml".Replace("'", "")
Copy-Item -Path .\winlogbeat.yml -Destination $wlb_config  -Force

{# Use a bunch of regular expression to find and replace text in winlogbeat.yml. REs are #}
{# based the default configuration file of version 6.5.2. If the file is changed up in #}
{# future releases, these REs might not work. #}
if($logstash_host) {
  RegexReplaceInFile -filename $wlb_config `
                     -prefix 'output.logstash:.*?hosts: \[\"' `
                     -target '[^:]*' `
                     -new_text $logstash_host
}
if($logstash_port) {
  RegexReplaceInFile -filename $wlb_config `
                     -prefix 'output.logstash:.*?hosts: \[[^:]*?:' `
                     -target '[^\"]*' `
                     -new_text $logstash_port
}

{{ target_dir }}\Winlogbeat\install-service-winlogbeat.ps1

$wlb_service = Get-WmiObject -Class Win32_Service -Filter "Name='winlogbeat'"
$wlb_service.StartService()
{% endif %}

{% if install_sysmon | upper == 'TRUE' %}
#Install Sysmon
Expand-Archive -Path .\Sysmon.zip -Destination {{ target_dir }}\Sysmon
{{ target_dir }}\Sysmon\Sysmon64.exe -i 2> $null
{% endif %}

{% if install_endgame | upper == 'TRUE' %}
#Install Endgame
{% set install_param = '' %}
{% include 'EndgameInstaller.j2' %}
{% endif %}