---

- name: Checking if kubeadm is Installed
  stat:
    path: /usr/bin/kubeadm
  register: kubeadm_installed

- name: Reset Kubernetes Node
  command: kubeadm reset -f -v1
  register: kube_reset_result
  when: kubeadm_installed.stat.exists
  ignore_errors: yes

- name: reload iptables
  import_role:
    name: common
    tasks_from: 50_setup_firewall

- name: Make sure crio is running
  service:
    name: "{{ item }}"
    state: started
    enabled: true
  with_items:
    - crio
    - crio-shutdown
  ignore_errors: yes
  register: crio_results

- name: Check if any pods are still running
  shell: |
    crictl ps -qa
  register: running_pods
  when: crio_results.rc == 0
  ignore_errors: yes

- name: Stop all running containers
  shell: |
    crictl stop $(crictl ps -qa)
    crictl rm $(crictl ps -qa)
  ignore_errors: yes
  when: running_pods is defined and running_pods.stdout != ""

- name: Uninstall CRI-O
  yum:
    name: [ buildah, cri-tools, runc, container-selinux, criu ]
    state: absent

- name: Install crio
  shell: |
    make uninstall
  args:
    chdir: "{{ crio_dir }}"

- name: Clean up directories
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "/etc/cni/net.d"
    - "/usr/bin/crictl"

- name: reload systemd
  systemd:
    daemon_reload: yes
