---

- name: Checking if kubeadm is Installed
  stat:
    path: /usr/bin/kubeadm
  register: kubeadm_installed

- name: Reset Kubernetes Node
  shell: |
    kubeadm reset -f -v1
  register: kube_reset_result
  changed_when: kube_reset_result.rc == 0
  ignore_errors: yes
  until: kube_reset_result.rc == 0
  retries: 15
  delay: 5
  when: kubeadm_installed.stat.exists

- name: reload iptables
  import_role:
    name: common
    tasks_from: 50_setup_firewall

- name: Uninstall CRI-O
  yum:
    name: [ buildah, cri-tools, runc, container-selinux, criu ]
    state: absent

- name: Install crio
  shell: |
    make uninstall
  args:
    chdir: "{{ crio_dir }}"

- name: Clean up directories
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "/etc/cni/net.d"
    - "/usr/bin/crictl"

- name: reload systemd
  systemd:
    daemon_reload: yes
