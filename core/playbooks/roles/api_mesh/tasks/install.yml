---
- name: Install KeepAlived and HAProxy
  dnf:
    name: [keepalived, haproxy]
    state: installed

- name: Set_fact management_interface ipv4
  set_fact:
    management_interface: "{{ ansible_default_ipv4.interface }}"

- name: Copy KeepAlived Template
  template:
    src: templates/keepalived.conf.j2
    dest: "/etc/keepalived/keepalived.conf"
  register: keepalive_conf

- name: Copy HAProxy Template
  template:
    src: templates/haproxy.cfg.j2
    dest: "/etc/haproxy/haproxy.cfg"
  register: haproxy_conf

- name: Create Override Systemd Dirs
  file:
    path: "/etc/systemd/system/{{ item }}"
    state: directory
  with_items:
    - "haproxy.service.d"
    - "keepalived.service.d"

- name: Copy Systemd Override Confs
  copy:
    src: "{{ item. src }}"
    dest: "/etc/systemd/system/{{ item.dest }}"
  with_items:
    - { src: "haproxy_override.conf", dest: "haproxy.service.d/override.conf" }
    - { src: "keepalived_override.conf", dest: "keepalived.service.d/override.conf" }

- name: Allow haproxy connection
  seboolean:
    name: haproxy_connect_any
    state: yes
    persistent: yes

- name: Enable and Start KeepAlived
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  with_items:
    - keepalived
    - haproxy

- name: Restart KeepAlived and HaProxy
  systemd:
    name: "{{ item }}"
    state: restarted
  with_items:
    - keepalived
    - haproxy
