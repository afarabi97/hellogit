---
- name: Install necessary packages.
  yum:
    name: "{{ item }}"
  loop:
    - gcc
    - python36
    - python36-devel

- name: Create a virtual environment.
  command: /usr/bin/python3 -m venv /root/metrics
  args:
    creates: /root/metrics

- name: Install necessary packages into the virtual environment.
  pip:
    name:
      - aniso8601
      - elasticsearch
      - kubernetes
      - psutil
      - requests
    virtualenv: /root/metrics

- name: Copy the metrics script.
  copy:
    src: metrics.py
    dest: /root/metrics.py

- name: Create a config file for the metrics script.
  template:
    src: metrics.ini.j2
    dest: /root/metrics.ini

- name: Create a cronjob.
  cron:
    name: node-health
    job: /root/metrics/bin/python /root/metrics.py
