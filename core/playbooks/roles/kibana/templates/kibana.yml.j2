{% if system_name == "DIP" %}
  {% set kibana_memory = 1 %}
  {% set kibana_cpu = "1000m" %}

  {% if kit_size > 1 %}
    {% set kibana_memory = 6 %}
    {% set kibana_cpu = "1000m" %}
  {% elif kit_size == 1 %}
    {% set kibana_memory = 1 %}
    {% set kibana_cpu = "1000m" %}
  {% elif kit_size == 0 %}
    {% set kibana_memory = 1 %}
    {% set kibana_cpu = "1000m" %}
  {% endif %}
{% endif %}

{% if system_name == "GIP" %}
  {% set kibana_memory = 1 %}
  {% set kibana_cpu = "1000m" %}
  {% if kit_size == 100 %}
    {% set kibana_memory = 6 %}
    {% set kibana_cpu = "1000m" %}
  {% endif %}
{% endif %}

---
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: tfplenum
spec:
  version: {{ elastic_7_version }}
  image: kibana/kibana:{{ elastic_7_version }}
  http:
    tls:
      certificate:
        secretName: kibana-certificate
  count: 1
  config:
    xpack.monitoring.ui.container.elasticsearch.enabled: true
    xpack.reporting.enabled: true
    elasticsearch.requestTimeout: 100000
    elasticsearch.shardTimeout: 0
    xpack.security.authc.providers: [saml,basic]
    xpack.security.authc.saml.realm: saml1
    xpack.security.public.protocol: https
    xpack.security.public.hostname: kibana.{{ kit_domain }}
    xpack.security.public.port: 443
    server.xsrf.whitelist: [/api/security/v1/saml]
  elasticsearchRef:
    name: "tfplenum"
  secureSettings:
  - secretName: kibana-key-secret-settings
  - secretName: kibana-alert-secret-settings
  podTemplate:
    spec:
      containers:
      - name: kibana
        resources:
          requests:
            memory: {{ kibana_memory }}Gi
            cpu: {{ kibana_cpu }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: role
                operator: In
                values:
                - server
---
apiVersion: v1
kind: Service
metadata:
  name: kibana
  labels:
    component: kibana
spec:
  selector:
    common.k8s.elastic.co/type: kibana
    kibana.k8s.elastic.co/name: tfplenum
  ports:
  - name: http
    port: {{ kibana_port }}
    targetPort: http
  type: LoadBalancer

...
