---

- name: Uninstall Kibana
  command: "{{ item }} --ignore-not-found"
  ignore_errors: true
  with_items:
    - "kubectl delete kibana.kibana.k8s.elastic.co/tfplenum"
    - "kubectl delete svc -l component=kibana"
    - "kubectl delete certificate kibana"
    - "kubectl delete secret kibana-certificate"

- name: Delete Additional ES Secrets
  command: "kubectl delete secret {{ item }} --ignore-not-found"
  with_items:
    - "-n default kibana-secret-settings"

- name: Wait for all kibana pods to die
  shell: |
    while [ $(kubectl get pods --no-headers | awk '{ print $1 }' | grep tfplenum-kb- | tail -n +0 | wc -l) != '0' ]; do
      echo -n .;
      sleep 1;
    done;
  ignore_errors: true
