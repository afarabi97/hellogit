---
- name: set_fact domain
  set_fact:
    domain: "{{ '.'.join(groups['servers'][0].split('.')[1:]) }}"
  tags: always

- debug:
    msg: "Domain : {{ domain }}"
  tags: always

- name: modify /etc/hosts
  lineinfile:
    dest: /etc/hosts
    regexp: '^127\.0\.0\.1[ \t]+localhost'
    line: '127.0.0.1 localhost controller.{{ domain }}'
    state: present
  tags: always

- name: set_fact ansible_controller hostname and ip
  set_fact:
    ansible_controller_hostname: "controller.{{ domain }}"
    ansible_controller_ip: "{{ hostvars.localhost.ansible_default_ipv4.address }}"
  tags: always

- name: Add Vars to Servers and Sensors
  set_fact:
    host_list: "{{ groups['servers'] + groups['sensors'] }}"
    ansible_controller_hostname: "{{ ansible_controller_hostname }}"
    ansible_controller_ip: "{{ ansible_controller_ip }}"
    domain: "{{ domain }}"
    offline_repo_base: "http://{{ ansible_controller_hostname }}/offlinerepo"
    docker_registry_repo: "{{ ansible_controller_hostname }}"
  delegate_to: "{{ item }}"
  delegate_facts: True
  with_items:
    - "{{ groups['servers'] }}"
    - "{{ groups['sensors'] }}"
  tags: always


