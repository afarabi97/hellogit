{
    "description": "Zeek Conn pipeline",
    "processors": [
        {
            "set": {
                "field": "event.category",
                "value": "network"
            }
        },
        {
            "pipeline": {
                "name": "zeek_general_network_pipeline"
            }
        },
        {
            "geoip": {
                "field": "destination.ip",
                "target_field": "destination.geo"
            }
        },
        {
            "geoip": {
                "field": "source.ip",
                "target_field": "source.geo"
            }
        },
        {
            "remove": {
                "field": [
                    "orig_bytes",
                    "resp_bytes"
                ],
                "ignore_missing": true
            }
        },
        {
            "geoip": {
                "database_file": "GeoLite2-ASN.mmdb",
                "field": "source.ip",
                "target_field": "source.as",
                "properties": [
                    "asn",
                    "organization_name"
                ],
                "ignore_missing": true
            }
        },
        {
            "geoip": {
                "database_file": "GeoLite2-ASN.mmdb",
                "field": "destination.ip",
                "target_field": "destination.as",
                "properties": [
                    "asn",
                    "organization_name"
                ],
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "source.as.asn",
                "target_field": "source.as.number",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "source.as.organization_name",
                "target_field": "source.as.organization.name",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "destination.as.asn",
                "target_field": "destination.as.number",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "destination.as.organization_name",
                "target_field": "destination.as.organization.name",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "proto",
                "target_field": "network.transport"
            }
        },
        {
            "rename": {
                "field": "vlan",
                "target_field": "vlan.outer.id",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "inner_vlan",
                "target_field": "vlan.inner.id",
                "ignore_missing": true
            }
        },
        {
            "remove": {
                "field": "tunnel_parents",
                "if": "(ctx.tunnel_parents == null) || (ctx.tunnel_parents == \"\")",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "tunnel_parents",
                "target_field": "log.id.tunnel_parents",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "orig_ip_bytes",
                "target_field": "source.bytes"
            }
        },
        {
            "rename": {
                "field": "resp_ip_bytes",
                "target_field": "destination.bytes"
            }
        },
        {
            "rename": {
                "field": "orig_l2_addr",
                "target_field": "source.mac",
                "ignore_missing": true
            }
        },
        {
            "script": {
                "source": "if (ctx.local_orig == true && ctx.local_resp == true) {ctx.network.direction = \"internal\"} else if (ctx.local_orig == true && ctx.local_resp == false) {ctx.network.direction = \"outbound\"} else if (ctx.local_orig == false && ctx.local_resp == true) {ctx.network.direction = \"inbound\"} else {ctx.network.direction = \"external\"}"
            }
        },
        {
            "rename": {
                "field": "local_orig",
                "target_field": "connection.local_orig"
            }
        },
        {
            "rename": {
                "field": "local_resp",
                "target_field": "connection.local_resp"
            }
        },
        {
            "convert": {
                "field": "duration",
                "type": "long",
                "ignore_failure": true
            }
        },
        {
            "rename": {
                "field": "duration",
                "target_field": "event.duration",
                "ignore_missing": true
            }
        },
        {
            "script": {
                "lang": "painless",
                "source": "ctx.network.bytes = ctx.source.bytes + ctx.destination.bytes",
                "ignore_failure": true
            }
        },
        {
            "rename": {
                "field": "history",
                "target_field": "network.connection.history",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "missed_bytes",
                "target_field": "network.missed_bytes"
            }
        },
        {
            "rename": {
                "field": "orig_pkts",
                "target_field": "source.packets"
            }
        },
        {
            "rename": {
                "field": "resp_pkts",
                "target_field": "destination.packets"
            }
        },
        {
            "script": {
                "lang": "painless",
                "source": "ctx.network.packets = ctx.source.packets + ctx.destination.packets",
                "ignore_failure": true
            }
        },
        {
            "rename": {
                "field": "service",
                "target_field": "network.protocol",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "resp_l2_addr",
                "target_field": "destination.mac",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "cache_add_rx_ev",
                "target_field": "connection.cache_add_rx_ev",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "cache_add_rx_mpg",
                "target_field": "connection.cache_add_rx_mpg",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "cache_add_rx_new",
                "target_field": "connection.cache_add_rx_new",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "cache_add_tx_ev",
                "target_field": "connection.cache_add_tx_ev",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "cache_add_tx_mpg",
                "target_field": "connection.cache_add_tx_mpg",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "cache_del_mpg",
                "target_field": "connection.cache_del_mpg",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "cache_entries",
                "target_field": "connection.cache_entries",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "community_id",
                "target_field": "network.community_id"
            }
        },
        {
            "rename": {
                "field": "zeek_shunted",
                "target_field": "connection.zeek_shunted",
                "ignore_missing": true
            }
        },
        {
            "dot_expander": {
                "field": "id.orig_h.name.src",
                "ignore_failure": true
            }
        },
        {
            "dot_expander": {
                "field": "id.orig_h.name.vals",
                "ignore_failure": true
            }
        },
        {
            "dot_expander": {
                "field": "id.resp_h.name.src",
                "ignore_failure": true
            }
        },
        {
            "dot_expander": {
                "field": "id.resp_h.name.vals",
                "ignore_failure": true
            }
        },
        {
            "rename": {
                "field": "id.orig_h.name.src",
                "target_field": "connection.id.orig_h.name.src",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "id.orig_h.name.vals",
                "target_field": "connection.id.orig_h.name.vals",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "id.resp_h.name.src",
                "target_field": "connection.id.resp_h.name.src",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "id.resp_h.name.vals",
                "target_field": "connection.id.resp_h.name.vals",
                "ignore_missing": true
            }
        },
        {
            "remove": {
                "field": "id",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "resp_cc",
                "target_field": "destination.geo.country_iso_code",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "orig_cc",
                "target_field": "source.geo.country_iso_code",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "conn_state",
                "target_field": "network.connection.state"
            }
        },
        {
            "script": {
                "source": "if (ctx.network.connection.state == \"S0\") {ctx.network.connection.state_message = \"connection attempt seen, no reply.\"} else if (ctx.network.connection.state == \"S1\") {ctx.network.connection.state_message = \"connection established, not terminated.\"} else if (ctx.network.connection.state == \"SF\") {ctx.network.connection.state_message = \"Normal establishment and termination.\"} else if (ctx.network.connection.state == \"REJ\") {ctx.network.connection.state_message = \"connection attempt rejected.\"} else if (ctx.network.connection.state == \"S2\") {ctx.network.connection.state_message = \" connection established and close attempt by originator seen (but no reply from responder).\"} else if (ctx.network.connection.state == \"S3\") {ctx.network.connection.state_message = \"connection established and close attempt by responder seen (but no reply from originator).\"} else if (ctx.network.connection.state == \"RSTO\") {ctx.network.connection.state_message = \"connection established, originator aborted (sent a RST).\"} else if (ctx.network.connection.state == \"RSTR\") {ctx.network.connection.state_message = \"Responder sent a RST.\"} else if (ctx.network.connection.state == \"RSTOS0\") {ctx.network.connection.state_message = \"Originator sent a SYN followed by a RST, we never saw a SYN-ACK from the responder.\"} else if (ctx.network.connection.state == \"RSTRH\") {ctx.network.connection.state_message = \"Responder sent a SYN ACK followed by a RST, we never saw a SYN from the (purported) originator.\"} else if (ctx.network.connection.state == \"SH\") {ctx.network.connection.state_message = \"Originator sent a SYN followed by a FIN, we never saw a SYN ACK from the responder (hence the connection was 'half' open).\"} else if (ctx.network.connection.state == \"SHR\") {ctx.network.connection.state_message = \"Responder sent a SYN ACK followed by a FIN, we never saw a SYN from the originator.\"} else if (ctx.network.connection.state == \"OTH\") {ctx.network.connection.state_message = \"No SYN seen, just midstream traffic (a 'partial connection' that was not later closed).\"}"
            }
        }
    ],
    "on_failure": [
        {
            "set": {
                "field": "error.message",
                "value": "{{ _ingest.on_failure_message }}"
            }
        }
    ]
}
