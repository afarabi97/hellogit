- name: "Create directories"
  file:
    group: "{{ elastic_group }}"
    owner: "{{ elastic_user }}"
    mode: u+rw,g+rw
    path: "{{ elastic_dir }}"
    state: directory

- name: Install Templates
  template:
    src: "templates/{{ item }}.j2"
    dest: "{{ elastic_dir }}/{{ item }}"
    group: "{{ elastic_group }}"
    owner: "{{ elastic_user }}"
    mode: u+rw,g+rw
  with_items:
    - es-master-svc.yml
    - es-master-deploy.yml
    - es-master-conf.yml
    - es-data-statefulset.yml
    - es-data-svc.yml
    - es-data-conf.yml
    # - es-ingest-deploy.yml
    # - es-ingest-svc.yml
    # - es-ingest-conf.yml
    # - es-search-deploy.yml
    # - es-search-svc.yml
    # - es-search-conf.yml
    - action_file.yml
    - config.yml
    - license.json

- name: Flush Deployments
  shell: |
    kubectl delete -f {{ elastic_dir }}/{{ item }} --ignore-not-found=true
    while [ $(kubectl get -f {{ elastic_dir }}/{{ item }} | tail -n +2 | wc -l) != '0' ]; do
      echo -n .;
      sleep 1;
    done;
    sleep 5;
  with_items:
    - es-master-deploy.yml
    - es-master-svc.yml
    - es-data-statefulset.yml
    - es-data-svc.yml
    # - es-ingest-deploy.yml
    # - es-ingest-svc.yml
    # - es-search-deploy.yml
    # - es-search-svc.yml

- name: Flush Config
  command: 'kubectl delete configmap {{ item }} --ignore-not-found=true'
  with_items:
    - elastic-master
    - elastic-data
    # - elastic-ingest
    # - elastic-search
