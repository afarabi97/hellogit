---

- name: Create install directory
  file:
    mode: u+rw,g+rw
    path: "{{ elastic_dir }}"
    state: directory

- name: Create elastic_snapshots directory if it does not exist
  file:
    path: /mnt/tfplenum_backup/elastic_snapshots
    state: directory
    mode: "0775"
    group: "{{ elastic_group }}"
    owner: "{{ elastic_user }}"
  delegate_to: "{{ item }}"
  loop: "{{ groups['servers'] }}"

- name: Copy Templates
  template:
    src: "templates/{{ item }}.j2"
    dest: "{{ elastic_dir }}/{{ item }}"
    mode: u+rw,g+rw
  with_items:
    - operator.yml
    - license.yml
    - certificate.yml

- name: Install Elasticsearch Certificate
  shell: |
    kubectl apply -f {{ elastic_dir }}/certificate.yml
  register: results
  changed_when: results.rc == 0

- name: Copy Deploy Template
  template:
    src: "templates/deploy_{{ system_name|lower }}.yml.j2"
    dest: "{{ elastic_dir }}/deploy.yml"
    mode: u+rw,g+rw

- name: Delete S3 repository secrets.
  shell: |
    kubectl delete secret {{ item.name }} --ignore-not-found=true
  ignore_errors: yes
  changed_when: results.rc == 0
  loop:
    - { name: "s3-access-key" }
    - { name: "s3-secret-key" }

- name: Create S3 repository secrets.
  shell: |
    kubectl create secret generic {{ item.name }} --from-literal={{ item.key }}={{ item.value }}
  register: results
  changed_when: results.rc == 0
  loop:
    - { name: "s3-access-key", key: "s3.client.default.access_key", value: "minioadmin"}
    - { name: "s3-secret-key", key: "s3.client.default.secret_key", value: "minioadmin"}

- name: Install ECK Operator
  shell: |
    kubectl apply -f {{ elastic_dir }}/operator.yml
  register: results
  changed_when: results.rc == 0

- name: Install Elasticsearch
  shell: |
    kubectl apply -f {{ elastic_dir }}/deploy.yml
  register: results
  changed_when: results.rc == 0

- name: Add Elastic License
  shell: |
    kubectl apply -f {{ elastic_dir }}/license.yml
  register: results
  changed_when: results.rc == 0


...
