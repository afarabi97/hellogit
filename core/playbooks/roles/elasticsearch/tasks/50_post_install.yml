---

- name: Wait for Elasticsearch to become healthy
  uri:
    url: "http://{{ elastic_fqdn }}:9200/_cluster/health"
    return_content: yes
  register: results_elastic
  until: (results_elastic.status == 200) and (results_elastic.json.status == 'green')
  retries: 30
  delay: 5

- name: Enable Monitoring
  uri:
    url: "http://{{ elastic_fqdn }}:9200/_cluster/settings"
    method: PUT
    body_format: json
    body:
      persistent:
        xpack.monitoring.collection.enabled: true
    status_code: 200, 201
  register: monitoring_results
  until: monitoring_results.status == 200
  retries: 30
  delay: 5

...
