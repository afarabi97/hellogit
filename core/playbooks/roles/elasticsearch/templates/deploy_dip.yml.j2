# DIP Defaults for minimal VM Setup
{% set es_mdi = true %}
{% set es_master_java_memory = 1 %}
{% set es_master_memory = 1 %}
{% set es_master_num_procs = "1000m" %}
{% set es_master_count = 3 %}
{% set es_data_java_memory = 1 %}
{% set es_data_memory = 1 %}
{% set es_data_num_procs = "1000m" %}
{% set es_data_count = 2 %}
{% set es_coordinating_java_memory = 1 %}
{% set es_coordinating_memory = 1 %}
{% set es_coordinating_num_procs = "1000m" %}
{% set es_coordinating_count = groups['servers']|length %}
{% set kibana_memory = 1 %}
{% set kibana_cpu = "1000m" %}
{% set kibana_count = 1 %}

# R440 Kit
{% if kit_size == 2 %}
  {% set es_mdi = false %}
  {% set es_master_java_memory = 15 %}
  {% set es_master_memory = 15 %}
  {% set es_master_num_procs = "3000m" %}
  {% set es_master_count = 3 %}
  {% set es_data_java_memory = 30 %}
  {% set es_data_memory = 64 %}
  {% set es_data_num_procs = "6000m" %}
  {% set es_data_count = 6 %}
  {% set es_coordinating_java_memory = 30 %}
  {% set es_coordinating_memory = 45 %}
  {% set es_coordinating_num_procs = "3000m" %}
  {% set es_coordinating_count = groups['servers']|length %}
  {% set kibana_memory = 6 %}
  {% set kibana_cpu = "1000m" %}
  {% set kibana_count = 2 %}
# Small DL160 Kit
{% elif kit_size == 1 %}
  {% set es_mdi = true %}
  {% set es_master_java_memory = 20 %}
  {% set es_master_memory = 30 %}
  {% set es_master_num_procs = "8000m" %}
  {% set es_master_count = 3 %}
  {% set es_coordinating_java_memory = 30 %}
  {% set es_coordinating_memory = 45 %}
  {% set es_coordinating_num_procs = "3000m" %}
  {% set es_coordinating_count = groups['servers']|length %}
  {% set kibana_memory = 1 %}
  {% set kibana_cpu = "1000m" %}
  {% set kibana_count = 1 %}
# Tiny DL160 Kit
{% elif kit_size == 0 %}
  {% set es_mdi = true %}
  {% set es_master_java_memory = 20 %}
  {% set es_master_memory = 20 %}
  {% set es_master_num_procs = "8000m" %}
  {% set es_master_count = 3 %}
  {% set es_coordinating_java_memory = 8 %}
  {% set es_coordinating_memory = 9 %}
  {% set es_coordinating_num_procs = "4000m" %}
  {% set es_coordinating_count = groups['servers']|length %}
  {% set kibana_memory = 1 %}
  {% set kibana_cpu = "1000m" %}
  {% set kibana_count = 1 %}
{% endif %}

{% import 'templates/node_set.yml.j2' as node_set %}
---
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: tfplenum
spec:
  version: {{elastic_7_version}}
  image: elasticsearch/elasticsearch:{{elastic_7_version}}
  http:
    tls:
      certificate:
        secretName: elasticsearch-certificate
  secureSettings:
  - secretName: s3-access-key
  - secretName: s3-secret-key
  nodeSets:
  - {{ node_set.dip_master(es_mdi, es_master_count, es_master_memory, es_master_num_procs, es_master_java_memory, elasticsearch_plugins) | indent(width=4) }}
  {%- if es_mdi == false %}
  - {{ node_set.dip_data(es_data_count, es_data_memory, es_data_num_procs, es_data_java_memory, elasticsearch_plugins) | indent(width=4) }}
  {% endif %}
  - {{ node_set.dip_coordinating(es_coordinating_count, es_coordinating_memory, es_coordinating_num_procs, es_coordinating_java_memory, elasticsearch_plugins) | indent(width=4) }}
---
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch
  labels:
    component: elasticsearch
spec:
  selector:
    common.k8s.elastic.co/type: elasticsearch
    elasticsearch.k8s.elastic.co/cluster-name: tfplenum
    elasticsearch.k8s.elastic.co/statefulset-name: tfplenum-es-coordinating
  ports:
  - name: http
    port: {{elastic_port}}
    targetPort: http
  type: LoadBalancer

---
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch-headless
  labels:
    component: elasticsearch-headless
spec:
  selector:
    common.k8s.elastic.co/type: elasticsearch
    elasticsearch.k8s.elastic.co/cluster-name: tfplenum
    elasticsearch.k8s.elastic.co/statefulset-name: tfplenum-es-coordinating
  ports:
  - name: http
    port: {{elastic_port}}
    targetPort: http
  clusterIP: None

...
