# Configure tftp service
---

- name: Install {{ tftp_pkgs }}
  yum:
    name: "{{ tftp_pkgs }}"
    state: present

- name: Create pxelinux.cfg
  file:
    state: directory
    owner: root
    group: root
    mode: 0755
    setype: cobbler_var_lib_t
    path: "{{ tftp_dir }}/pxelinux.cfg"

- name: Create uefi dir
  file:
    state: directory
    owner: root
    group: root
    mode: 0755
    setype: cobbler_var_lib_t
    path: "{{ tftp_dir }}/uefi"

- name: Place rhel pxe files
  copy:
    src: "{{ item }}"
    dest: "{{ tftp_dir }}"
    setype: cobbler_var_lib_t
  register: tftp
  with_items:
    - "{{ tftp_pxe }}"

- name: Place uefi pxe files
  copy:
    src: "{{ item }}"
    dest: "{{ tftp_dir }}/uefi"
    setype: cobbler_var_lib_t
  register: tftp
  with_items:
    - "{{ tftp_uefi }}"

# - name: Default pxe menu
#   template:
#     src: "{{ item.src }}"
#     dest: "{{ item.dest }}"
#     owner: root
#     group: root
#     mode: 0644
#     setype: "{{ item.setype }}"
#   register: tftp
#   with_items:
#   - { src: 'tftp.j2', dest: '/etc/xinetd.d/tftp', setype: 'etc_t'}

- name: TFTP Services # noqa 503
  service:
    name: tftp.socket
    state: started
    enabled: yes
  when: tftp.changed

- name: TFTP Firewall
  firewalld:
    zone: public
    service: tftp
    state: enabled
    immediate: yes
    permanent: yes
  notify: "Restart Docker"
