- name: Checking Current Helm Version
  shell: helm version -c | grep '^Client' | cut -d'"' -f2
  register: OLD_VERSION
- block:
  - debug:
      msg: "Nothing to Upgrade, exiting."
  - meta: end_play
  when:
    - OLD_VERSION.stdout | version(helm_version,'>=')
    - inventory_hostname in groups['master_server']

- name: Downloading and Unpacking Helm
  unarchive:
    src: "{{ offline_repo_base }}/helm-{{ helm_version }}-linux-amd64.tar.gz"
    dest: /usr/local/bin/
    remote_src: yes
    extra_opts:
      - linux-amd64/helm

- name: Initializing Tiller
  command: helm init --service-account tiller --tiller-image kubernetes-helm/tiller:{{ helm_version }} --upgrade --node-selectors "role"="server" --history-max 200
  when: inventory_hostname in groups['master_server']
