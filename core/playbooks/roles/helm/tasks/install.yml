- name: Downloading and Unpacking Helm
  unarchive:
    src: "{{ offline_repo_base }}/helm-{{ helm_version }}-linux-amd64.tar.gz"
    dest: /usr/local/bin/
    creates: /usr/local/bin/helm
    remote_src: yes
    extra_opts: [--strip-components=1]

- name: Initializing Helm Client
  command: helm init --client-only --skip-refresh

- name: Creating Tiller Service Account
  command: kubectl -n kube-system create serviceaccount tiller
  when: inventory_hostname in groups['master_server']

- name: Creating Kube Cluster Role Binding
  command: kubectl create clusterrolebinding tiller --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
  when: inventory_hostname in groups['master_server']

- name: Initiallizing Tiller
  command: helm init --service-account tiller --tiller-image kubernetes-helm/tiller:{{ helm_version }} --upgrade --node-selectors "role"="server" --history-max 200 --replicas 2 --wait
  when: inventory_hostname in groups['master_server']

- name: Patching Tiller
  command: kubectl patch svc tiller-deploy -n kube-system -p '{"spec":{"type":"LoadBalancer"}}'
  when: inventory_hostname in groups['master_server']

- name: Wait for service to be ready
  wait_for:
    port: 44134
    host: tiller-deploy
    connect_timeout: 3
    delay: 3
    timeout: 180

- name: Removing Default Helm Repo
  shell: helm repo remove stable

- name: Copy Helm Plugins
  synchronize:
    src: /root/.helm/plugins
    dest: /root/.helm/
  ignore_errors: true

- name: Copy Helm Plugin Cache
  synchronize:
    src: /root/.helm/cache/plugins
    dest: /root/.helm/cache/
  ignore_errors: true
