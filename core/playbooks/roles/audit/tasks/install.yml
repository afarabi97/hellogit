---

- name: Stop auditd service
  shell: |
    service auditd stop
  register: result
  changed_when: result.rc == 0
  args:
    warn: false

- name: Disable auditd service
  service:
    name: auditd
    enabled: no

- name: Mask Journald-Auditd
  systemd:
    name: systemd-journald-audit.socket
    masked: yes

- name: Create Auditbeat Config Dir
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - /etc/auditbeat
    - /etc/auditbeat/audit.rules.d

- name: install auditbeat
  dnf:
    name: auditbeat-{{ elastic_7_version }}
    state: installed

- name: Get ES Password
  shell: set -o pipefail && kubectl get secret tfplenum-es-elastic-user -o=jsonpath='{.data.elastic}' | base64 --decode
  register: es_password
  changed_when: es_password.rc == 0

- name: set_fact domain
  set_fact:
    domain: "{{ '.'.join(groups['servers'][0].split('.')[1:]) }}"

- name: Copy Audit External Template
  template:
    src: "templates/auditbeat-external.yml.j2"
    dest: "{{ audit_dir }}/auditbeat.yml"
    owner: root
    group: root
    mode: 0600
  delegate_to: localhost
  run_once: true

- name: Run Audit Beat External Setup
  command: "/usr/bin/auditbeat setup -e"
  delegate_to: localhost
  register: ret_val
  changed_when: ret_val.rc == 0
  run_once: true
  retries: 3
  until: ret_val.rc == 0
  delay: 10

- name: Copy Audit Template
  template:
    src: "templates/auditbeat.yml.j2"
    dest: "{{ audit_dir }}/auditbeat.yml"
    owner: root
    group: root
    mode: 0600

- name: Copy Repo Config
  copy:
    src: templates/audit.rules
    dest: "{{ audit_dir }}/audit.rules.d/audit.rules"
    mode: 0600
    owner: root
    group: root

- name: Enable and Start Auditbeat
  service:
    name: auditbeat
    state: started
    enabled: yes

- name: Load Index Policies
  uri:
    url: "{{ elastic_url }}/_ilm/policy/{{ item }}"
    method: PUT
    validate_certs: no
    user: "{{ default_elastic_user }}"
    password: "{{ es_password.stdout }}"
    force_basic_auth: yes
    body_format: json
    body: "{{ lookup('template', 'templates/ilm_policy.json.j2') }}"
    status_code: 200, 201
  with_items:
    - auditbeat-internal
    - auditbeat-external
  register: policy_results
  until: policy_results.status == 200
  retries: 10
  delay: 5
  when: inventory_hostname != "localhost"
...