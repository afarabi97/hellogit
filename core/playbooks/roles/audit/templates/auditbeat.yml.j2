#==========================  Modules configuration =============================
auditbeat.config.modules:
  path: ${path.config}/auditbeat.yml
  reload.enabled: true
  reload.period: 10s

auditbeat.modules:

- module: auditd
  # Load audit rules from separate files. Same format as audit.rules(7).
  audit_rule_files: [ '${path.config}/audit.rules.d/*.rules' ]
  resolve_ids: true
  failure_mode: silent
  backlog_limit: 8192
  rate_limit: 0
  include_raw_message: false
  include_warnings: false
  backpressure_strategy: auto

- module: file_integrity
  paths:
  - /bin
  - /usr/bin
  - /sbin
  - /usr/sbin
  - /etc
  exclude_files:
  - '(?i)\.sw[nop]$'
  - '~$'
  - '/\.git($|/)'
  scan_at_start: true
  scan_rate_per_sec: 50 MiB
  max_file_size: 100 MiB
  hash_types: [sha1]
- module: system
  datasets:
    - host    # General host information, e.g. uptime, IPs
    - user    # User information
    - package # Installed, updated, and removed packages
    - login   # User logins, logouts, and system boots.
  period: 1m
  user.detect_password_changes: true
  # File patterns of the login record files.
  login.wtmp_file_pattern: /var/log/wtmp*
  login.btmp_file_pattern: /var/log/btmp*
  state.period: 12h

- module: system
  datasets:
    - process # Started and stopped processes
    - socket  # Opened and closed sockets
  period: 2s
  state.period: 12h

#==================== Elasticsearch template setting ==========================
setup.template.pattern: "auditbeat-internal-*"
setup.template.settings:
  index.number_of_shards: 1
  #index.codec: best_compression
  #_source.enabled: false

setup.ilm:
  policy_name: auditbeat-internal
  rollover_alias: auditbeat-internal

#============================== Dashboards =====================================
setup.dashboards.enabled: true
setup.dashboards.index: "auditbeat-internal-*"

#============================== Kibana =====================================
setup.kibana:
    space.id: "audit"
{% if "localhost" in inventory_hostname  %}
    host: "https://kibana.{{ domain }}:{{ kibana_port }}"
{% else %}
    host: "https://{{ kibana_fqdn }}:{{ kibana_port }}"
{% endif %}
    ssl.enabled: true
    ssl.certificate_authorities: ["/etc/pki/ca-trust/source/anchors/webCA.crt"]
    username: {{ default_elastic_user }}
    password: {{ es_password.stdout }}
#================================ Outputs =====================================

# Configure what output to use when sending the data collected by the beat.

#-------------------------- Elasticsearch output ------------------------------
output.elasticsearch:
  # Array of hosts to connect to.
{% if "localhost" in inventory_hostname  %}
    hosts: ['elasticsearch.{{ domain }}:{{ elastic_port }}']
{% else %}
    hosts: ['{{ elastic_fqdn }}:{{ elastic_port }}']
{% endif %}
    protocol: "https"
    username: {{ default_elastic_user }}
    password: {{ es_password.stdout }}
    ssl.certificate_authorities: ["/etc/pki/ca-trust/source/anchors/webCA.crt"]
#================================ Processors =====================================

# Configure processors to enhance or manipulate events generated by the beat.

processors:
  - add_host_metadata: ~
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
