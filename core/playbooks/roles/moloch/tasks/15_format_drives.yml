---

- name: Install lsof
  yum:
    name: lsof
    state: present

- name: Check if {{ moloch_pcap_folder }}
  stat:
    path: "{{ moloch_pcap_folder }}"
  register: pcap_dir

- name: Get all processes using {{ moloch_pcap_folder }}
  shell: |
    /usr/sbin/lsof +D {{ moloch_pcap_folder }} | awk '{ print $2 }' | grep -v PID | tr '\n' ' '
  register: process_list
  ignore_errors: yes
  when: pcap_dir.stat.exists

- name: Kill processes using {{ moloch_pcap_folder }}
  shell: |
    kill -9 {{ process_list.stdout }}
  when: pcap_dir.stat.exists and process_list is defined and process_list.stdout != ''

- name: Unmount the drive if it was already mounted
  mount:
    path: "{{ moloch_pcap_folder }}"
    src: "{{ pcap_disk }}"
    fstype: xfs
    state: "unmounted"

- name: Format PCAP drive
  filesystem:
    fstype: xfs
    dev: "{{ pcap_disk }}"
    force: yes

- name: Mount PCAP drive
  mount:
    path: "{{ moloch_pcap_folder }}"
    src: "{{ pcap_disk }}"
    state: mounted
    fstype: xfs
    opts: "noatime,logbsize=256k,swalloc,allocsize=131072k,nobarrier,largeio,inode64"

...
