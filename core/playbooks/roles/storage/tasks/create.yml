---

- name: Check if data is mounted
  shell: |
    mountpoint -q {{ data_path }}
  register: mount_results
  changed_when: false
  failed_when: false

- name: Create data mount
  block:
  - name: Create data directory
    file:
      path: "{{ data_path }}"
      group: "root"
      owner: "root"
      mode: u+rw,g+rw
      state: directory

  - name: Unmount and remove {{ data_path }}
    mount:
      path: "{{ data_path }}"
      state: "{{ item }}"
    with_items:
      - unmounted
      - absent

  - name: Get mpath info
    parted:
      device: "{{ dev_mpath }}"
      unit: MiB
    register: sdb_info

  - debug:
      msg: "{{ sdb_info }}"

  # Remove all partitions from disk
  - name: Remove all partitions from mpath
    parted:
      device: "{{ dev_mpath }}"
      number: "{{ item.num }}"
      state: absent
    with_items:
    - "{{ sdb_info.partitions }}"

  - name: Create a new primary partition
    parted:
      device: "{{ dev_mpath }}"
      number: 1
      state: present
      label: gpt
      name: data
      part_start: 4096KiB
      part_end: 100%
      flags: [ lvm ]

  - name: Create the vg_data Volume group.
    lvg:
      pvs: "{{ dev_mpath }}1"
      vg: "{{ vg_name }}"

  - name: Create Data LVM
    lvol:
      vg: "{{ vg_name }}"
      lv: "{{ lv_name }}"
      size: 100%FREE

  - name: Format mpath to xfs
    filesystem:
      fstype: xfs
      dev: "/dev/mapper/{{ vg_name }}-{{ lv_name }}"

  - name: "Mount mpath to {{ data_path }}"
    mount:
      fstype: xfs
      src: "/dev/mapper/{{ vg_name }}-{{ lv_name }}"
      path: "{{ data_path }}"
      state: mounted
  when: mount_results.rc == 1
