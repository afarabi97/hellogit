---
- name: Generate full rpm list of kit
  hosts:
    - localhost
    - servers
    - sensors
  vars:
     rpm_list_path: "/root/rpm_export_list"
     curr_repo_path: "/var/www/html/offlinerepo/tfplenum-{{ ansible_distribution }}"

  any_errors_fatal: true
  tasks:
    - name: remove old rpm export list
      file:
        path: /root/rpm_export_list
        state: absent
    - name: install reqoquery
      yum:
        name: yum-utils
        state: installed

    - name: Get Rpms
      shell: |
        rpm -qa
      register: rpmlist
      changed_when: rpmlist.rc == 0
      args:
        warn: false

    - name: get repo for each rpm
      shell: |
        set -o pipefail && repoquery -i {{ item }} | grep "Repository" | awk '{ print $3 }'
      with_items: "{{ rpmlist.stdout_lines }}"
      register: repo
      changed_when: repo.rc == 0

    - name: delete existing files
      delegate_to: localhost
      file:
        path {{ rpm_list_path }}
      state: absent
      with_items: "{{ repo.results }}"
      register: result
      changed_when: result.rc == 0
      when: '"anaconda" not in item.stdout'

    - name: write to file
      delegate_to: localhost
      command: echo "{{ item.item }}" >> {{ rpm_list_path }}
      with_items: "{{ repo.results }}"
      register: result
      changed_when: result.rc == 0
      when: '"anaconda" not in item.stdout'

    - name: sort file
      delegate_to: localhost
      command: sort -o {{ rpm_list_path }} {{ rpm_list_path }}
      register: result
      changed_when: result.rc == 0
      args:
        warn: false

    - name: remove duplicates
      delegate_to: localhost
      command: sed -i '$!N; /^\(.*\)\n\1$/!P; D' {{ rpm_list_path }}
      register: result
      changed_when: result.rc == 0
      args:
        warn: false

- name: Build tfplenum repo
  hosts:
    - localhost
  vars:
     rpm_list_path: "/root/rpm_export_list"
     curr_repo_path: "/var/www/html/offlinerepo/tfplenum-{{ ansible_distribution }}"

  any_errors_fatal: true
  tasks:
    - name: remove repo
      file:
        path: "{{ curr_repo_path }}"
        state: absent

    - name: create directory
      file:
        path: "{{ curr_repo_path }}"
        state: directory

    - name: remove lines starting with gpg-pubkey
      lineinfile:
        path: "{{ rpm_list_path }}"
        state: absent
        regexp: '^gpg-pubkey-'

    - name: download rpms
      shell: |
        yumdownloader {{ item }} --destdir {{ curr_repo_path }}
      with_lines:  '{{ cat {{ rpm_list_path }}}}'
      register: result
      changed_when: result.rc == 0
