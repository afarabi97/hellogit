# site.yml is the overall playbook, but all it does is include the other playbooks that are part of the site. For more
# information about the structure see:
# http://docs.ansible.com/ansible/latest/playbooks_best_practices.html
# http://docs.ansible.com/ansible/latest/intro_inventory.html
# We follow the guidance to include naming conventions there.

---

- name: Tag master server
  hosts: all
  tags: always
  tasks:
    - add_host:
        hostname: "{{ item }}"
        groups: master_server
      when: hostvars[item].is_master | default(false)
      with_items: "{{ groups['all'] }}"

- name: Tag remote sensors
  hosts: all
  tags: always
  tasks:
    - add_host:
        hostname: "{{ item }}"
        groups: remote_sensors
      when: hostvars[item].is_remote | default(false)
      with_items: "{{ groups['all'] }}"

- name: Setup Repos
  hosts:
    - servers
    - sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - repos
  tags: repos

- name: Install Controller Dependencies
  hosts:
    - servers
    - sensors
  tasks:
  - name: Install NetworkManager packages
    yum:
      name: "NetworkManager-glib"
      state: installed
    register: network_manager_result
  - name: 'Bump the NetworkManager service in case of https://access.redhat.com/solutions/3416301'
    systemd:
      name: NetworkManager
      state: restarted
    when: network_manager_result.changed
  tags:
    - dnsmasq
    - update-networkmanager

- name: Verify Ansible meets version requirements
  hosts: localhost
  any_errors_fatal: true
  tasks:
  - fail:
      msg: "You must update Ansible to at least 2.5.0 to use this code. Verify you have the EPEL repository enabled and then update Ansible."
    when: "ansible_version.full is version('2.5', '<=')"
  tags: preflight

- name: dnsmasq
  hosts:
    - servers
    - sensors
  gather_facts: yes
  any_errors_fatal: true
  pre_tasks:
    - setup:
    - name: Disable possible existing OpenVPN
      systemd:
        name: openvpn-client.service
        enabled: no
        state: stopped
      when: inventory_hostname in groups['remote_sensors']
      ignore_errors: yes
  roles:
    - dnsmasq
  tags: dnsmasq

- name: Remove existing SSH keys
  hosts:
    - localhost
    - servers
    - sensors
  connection: ssh
  any_errors_fatal: true
  tasks:
    - import_tasks: remove_ssh_info.yml
  tags: genkeys

- name: Generate SSH keys
  hosts:
    - localhost
    - servers
    - sensors
  connection: ssh
  any_errors_fatal: true
  vars:
    ssh_known_hosts: "{{ groups['servers'] }} + {{ groups['sensors'] }}"

    # This takes each group list, which is every host (do not use groups['all'] this will pick up nodes in nodes_to_remove group which will break stuff),
    # feeds it into map, which then
    # performs a regex_replace on each element. The regex_replace replaces .lan in each
    # element to nothing or ''. Finally, we feed that back into list because Ansible
    # expects the final product to be a list.
    ssh_short_known_hosts: "{{ ssh_known_hosts | map('regex_replace','(\\.lan$)','' ) | list }}"
  tasks:
    - import_tasks: generate_ssh_keys.yml
  tags: genkeys

- name: Perform preflight checks
  any_errors_fatal: true
  hosts:
    - servers
    - sensors
  roles:
    - preflight_checks
  tags: preflight

- name: Common Setup
  hosts:
    - servers
    - sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - common
    - chrony
  tags:
    - common

- name: Setup chrony on ctrl
  hosts:
    - localhost
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - chrony
  tags:
    - common

- name: OpenVPN
  hosts:
    - master_server
    - remote_sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - openvpn/common
  tags:
    - openvpn

- name: Setup CRI-O
  hosts:
    - servers
    - sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - crio
  tags:
    - crio

- name: Configure kube master
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - kubernetes/common
    - kubernetes/master
  tags:
    - kube-master

- name: Configure kube nodes
  hosts:
    - "!master_server"
    - servers
    - sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - kubernetes/common
    - kubernetes/node
  tags:
    - kube-node

- name: helm
  any_errors_fatal: true
  hosts:
    - all
  roles:
    - helm
  tags: helm

- name: chartmuseum
  any_errors_fatal: true
  hosts:
    - all
  roles:
    - chartmuseum
  tags: chartmuseum

- name: Deploy Elasticsearch
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - elasticsearch
  tags:
    - elasticsearch

- name: Deploy Kibana
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - kibana
  tags:
    - kibana

- name: Deploy metric services
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - metrics
  tags:
    - metrics

- name: Deploy Moloch
  hosts:
    - master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - moloch
  tags:
    - moloch

- name: Setup Log Management
  hosts:
    - sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - logs
  tags:
    - logs

- name: Enable janitor script on master server
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - setup:
  roles:
    - janitor
  tags:
    - janitor
    - enable-sensor-monitor-interface
