# site.yml is the overall playbook, but all it does is include the other playbooks that are part of the site. For more
# information about the structure see:
# http://docs.ansible.com/ansible/latest/playbooks_best_practices.html
# http://docs.ansible.com/ansible/latest/intro_inventory.html
# We follow the guidance to include naming conventions there.

---

- name: Set System Name and Node Groups
  hosts:
    - all
    - localhost
  gather_facts: no
  pre_tasks:
    - name: Run gather facts
      setup:
  roles:
    - system_info
  tags:
    - always
    - system-info

- name: Setup Disks
  hosts:
    - servers
    - sensors
  gather_facts: yes
  any_errors_fatal: true
  pre_tasks:
    - name: Run gather facts
      setup:
  tasks:
    - import_role:
        name: storage
        tasks_from: create
  tags: disks

- name: Set controller domain
  hosts: localhost
  gather_facts: yes
  roles:
    - domain
  tags:
    - always
    - domain

- name: Set Kit Size
  hosts: master_server
  tags: always
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Set kit size pre_tasks
      setup:
  tasks:
    - name: Set Kit Size
      set_fact:
        kit_size: >-
          {%
          if system_name == "GIP" %}{%
            if ansible_processor_vcpus >= 55 and (ansible_memtotal_mb/1024)|round|int >= 90 %}100{%
            else %}99{%
            endif %}{%
          else %}{%
            if (groups['servers']|length) >= 2 %}{%
              if ansible_processor_vcpus >= 45 and (ansible_memtotal_mb/1024)|round|int >= 999 %}3{%
              elif ansible_processor_vcpus >= 45 and (ansible_memtotal_mb/1024)|round|int >= 500 %}2{%
              elif ansible_processor_vcpus >= 30 and (ansible_memtotal_mb/1024)|round|int >= 500 %}1{%
              elif ansible_processor_vcpus >= 30 and (ansible_memtotal_mb/1024)|round|int >= 60 %}0{%
              else %}-1{%
              endif %}{%
            endif %}{%
          endif
          %}
        cacheable: yes
    - debug:
        msg: "Kit size: {{ kit_size }}"

- name: Setup Repos
  hosts:
    - servers
    - sensors
  gather_facts: yes
  any_errors_fatal: true
  pre_tasks:
    - name: Setup repos pre_tasks
      setup:
  roles:
    - repos
  tags: repos

- name: Install Controller Dependencies
  hosts:
    - servers
    - sensors
  tasks:
    - name: Install NetworkManager packages
      yum:
        name: "NetworkManager-glib"
        state: installed
      register: network_manager_result

    - name: "Bump the NetworkManager service in case of https://access.redhat.com/solutions/3416301"
      systemd:
        name: NetworkManager
        state: restarted
  tags:
    - dnsmasq
    - update-networkmanager

- name: Verify Ansible meets version requirements
  hosts: localhost
  any_errors_fatal: true
  tasks:
    - name: Ansible reqs failure
      fail:
        msg: "You must update Ansible to at least 2.5.0 to use this code. Verify you have the EPEL repository enabled and then update Ansible."
      when: "ansible_version.full is version('2.5', '<=')"
  tags: preflight

- name: dnsmasq
  hosts:
    - all
  gather_facts: yes
  any_errors_fatal: true
  pre_tasks:
    - name: dnsmasq pre_tasks
      setup:
    - name: Disable possible existing OpenVPN
      systemd:
        name: openvpn-client.service
        enabled: no
        state: stopped
      when: inventory_hostname in groups['remote_sensors']
      ignore_errors: yes
  roles:
    - dnsmasq
  tags: dnsmasq

- name: Update controller interface dns
  hosts:
    - localhost
  gather_facts: yes
  any_errors_fatal: true
  pre_tasks:
    - name: Update controller interface dns pre_tasks
      setup:
  tasks:
    - import_role:
        name: dnsmasq
        tasks_from: 11_set_controller_dns
  tags: update_ctrl_dns

- name: Remove existing SSH keys
  hosts:
    - localhost
    - servers
    - sensors
  connection: ssh
  any_errors_fatal: true
  tasks:
    - import_tasks: remove_ssh_info.yml
  tags: genkeys

- name: Generate SSH keys
  hosts:
    - localhost
    - servers
    - sensors
  connection: ssh
  any_errors_fatal: true
  vars:
    ssh_known_hosts: "{{ groups['servers'] + groups['sensors'] }}"

    # This takes each group list, which is every host (do not use groups['all'] this will pick up nodes in nodes_to_remove group which will break stuff),
    # feeds it into map, which then
    # performs a regex_replace on each element. The regex_replace replaces .lan in each
    # element to nothing or ''. Finally, we feed that back into list because Ansible
    # expects the final product to be a list.
    ssh_short_known_hosts: "{{ ssh_known_hosts | map('regex_replace','(\\.lan$)','' ) | list }}"
  tasks:
    - import_tasks: generate_ssh_keys.yml
  tags: genkeys

- name: Perform preflight checks
  any_errors_fatal: true
  hosts:
    - servers
    - sensors
  roles:
    - preflight_checks
  tags: preflight

- name: Common Setup
  hosts:
    - servers
    - sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Common setup pre_tasks
      setup:
  roles:
    - common
    - chrony
  tags:
    - common

- name: Setup chrony on ctrl
  hosts:
    - localhost
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Setup chrony on ctrl pre_tasks
      setup:
  roles:
    - chrony
  tags:
    - common

- name: Create Certificate Authority
  hosts: localhost
  any_errors_fatal: true
  pre_tasks:
    - name: Create cert authority pre_tasks
      setup:
  tasks:
    - import_role:
        name: certificate_authority/localhost
        tasks_from: create_ca
    - import_role:
        name: certificate_authority/localhost
        tasks_from: create_controller_cert
  tags:
    - certificate_authority

- name: Configure CA on all systems
  hosts:
    - localhost
    - servers
    - sensors
  any_errors_fatal: true
  pre_tasks:
    - name: Configure CA on all systems pre_tasks
      setup:
  roles:
    - certificate_authority/common
  tags:
    - certificate_authority

- name: OpenVPN
  hosts:
    - master_server
    - remote_sensors
  gather_facts: yes
  any_errors_fatal: true
  pre_tasks:
    - name: OpenVPN pre_tasks
      setup:
  tasks:
    - import_role:
        name: openvpn/common
      when: system_name == "DIP"
  tags:
    - openvpn

- name: API Mesh
  hosts:
    - servers
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Run gather facts
      setup:
  tasks:
    - import_role:
        name: api_mesh
      when: enable_kube_ha
  tags:
    - api-mesh
    - kubernetes

- name: Setup CRI-O
  hosts:
    - servers
    - sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Setup CRI-O pre_tasks
      setup:
  roles:
    - crio
  tags:
    - crio
    - kubernetes

- name: Configure kube master
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Configure kube master pre_tasks
      setup:
  roles:
    - kubernetes/master
  tags:
    - kube-master
    - kubernetes

- name: Configure kube nodes
  hosts:
    - "!master_server"
    - servers
    - sensors
  serial: 1
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Configure kube nodes pre_tasks
      setup:
  roles:
    - kubernetes/node
  tags:
    - kube-node
    - kubernetes

- name: Install Cert Manager
  hosts: localhost
  any_errors_fatal: true
  pre_tasks:
    - name: Install cert manager pre_tasks
      setup:
  tasks:
    - import_role:
        name: certificate_authority/localhost
        tasks_from: cert_manager
  tags:
    - certificate_authority

- name: helm
  any_errors_fatal: true
  hosts:
    - all
  roles:
    - helm
  tags: helm

- name: Setup Storage
  hosts:
    - servers
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Run gather facts
      setup:
  roles:
    - storage
  tags:
    - storage

- name: chartmuseum
  any_errors_fatal: true
  hosts:
    - master_server
    - localhost
  roles:
    - chartmuseum
  tags: chartmuseum

- name: Setup Controller API Key
  hosts:
    - localhost
  tasks:
    - name: generate Admin API key
      script: /opt/sso-idp/gen_api_token.py --roles "controller-admin,controller-maintainer,operator" --exp 1.0
      args:
        executable: /opt/tfplenum/web/tfp-env/bin/python3
      register: admin_api_key
    - name: generate Metrics API key
      script: /opt/sso-idp/gen_api_token.py --roles "metrics" --exp 87600
      args:
        executable: /opt/tfplenum/web/tfp-env/bin/python3
      register: metrics_api_key
    - name: Trim output
      set_fact:
        admin_api_key: "{{ admin_api_key.stdout | replace('\n', '') }}"
        metrics_api_key: "{{ metrics_api_key.stdout | replace('\n', '') }}"
    # - debug:
    #     msg: "{{ admin_api_key }}"
    - name: Remove API Key Secret
      shell: |
        kubectl delete secret metrics-api-key --ignore-not-found=true
      register: api_key_sec
      changed_when: api_key_sec.rc == 0
    - name: Create API Key Secret
      shell: |
        kubectl create secret generic metrics-api-key --from-literal=api-key={{ metrics_api_key }}
      register: api_key_sec
      changed_when: api_key_sec.rc == 0
  tags:
    - elasticsearch
    - node-health

- name: Deploy Elasticsearch
  hosts: servers
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Deploy elasticsearch pre_tasks
      setup:
  roles:
    - elasticsearch
  tags:
    - elasticsearch

- name: Deploy kibana
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Deploy kibana pre_tasks
      setup:
  roles:
    - kibana
  tags:
    - kibana

- name: Deploy Auditbeat
  hosts:
    - localhost
    - servers
    - sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Deploy Auditbeat pre_tasks
      setup:
  roles:
    - audit
  tags:
    - audit

- name: Deploy metric services
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Deploy metric services pre_tasks
      setup:
  roles:
    - metrics
  tags:
    - metrics

- name: Deploy Moloch
  hosts:
    - master_server
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Deploy Moloch pre_tasks
      setup:
  tasks:
    - import_role:
        name: moloch
      when: system_name == "DIP"
  tags:
    - moloch

- name: Setup Log Management
  hosts:
    - sensors
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
    - name: Setup Log Management pre_tasks
      setup:
  roles:
    - logs
  tags:
    - logs

- name: Schedule a cron job to gather health metrics.
  hosts:
    - servers
    - sensors
  gather_facts: no
  any_errors_fatal: true
  roles:
    - node-health
  tags:
    - node-health

- name: Run Filebeat Setup
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  tasks:
    - import_role:
        name: elasticsearch
        tasks_from: filebeat_setup
  tags:
    - run-filebeat-setup

- name: Run Winlogbeat Setup
  hosts: master_server
  gather_facts: no
  any_errors_fatal: true
  tasks:
    - import_role:
        name: elasticsearch
        tasks_from: winlogbeat_setup
  tags:
    - run-winlogbeat-setup
