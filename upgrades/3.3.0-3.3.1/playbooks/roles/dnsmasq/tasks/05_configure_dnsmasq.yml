---

- name: Copy over dnsmasq host template
  template:
    src: templates/dns_hosts.j2
    dest: "{{ host_file }}"
  tags:
    - update-dnsmasq-hosts

- name: Start dnsmasq and enable it
  systemd:
    name: dnsmasq
    state: restarted
    enabled: yes
    daemon-reload: yes
  tags:
    - update-dnsmasq-hosts

- name: Check if dnsmasq is running
  command: systemctl status dnsmasq
  ignore_errors: yes
  changed_when: false
  register: service_dnsmasq_status
  tags:
    - update-dnsmasq-hosts

- name: Confirm dnsmasq is running
  fail:
    msg: "dnsmasq is not running for some reason. Log into {{ inventory_hostname }} and check status with 'systemctl status dnsmasq'"
  when: service_dnsmasq_status is failed
  tags:
    - update-dnsmasq-hosts
...
