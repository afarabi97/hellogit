# DISA-STIG-RHEL-07-030360
- name: Search for privileged commands
  shell: find / -xdev -type f -perm -4000 -o -type f -perm -2000 2>/dev/null
  args:
    warn: false
    executable: /bin/bash
  check_mode: false
  register: find_result
  changed_when: false

- name: "Search {{ audit_directory }} for audit rule entries"
  find:
    paths: "{{ audit_directory }}"
    recurse: false
    contains: ^.*path={{ item }} .*$
    patterns: '*.rules'
  with_items:
  - '{{ find_result.stdout_lines }}'
  register: files_result

- name: "Overwrites the rule in {{ audit_directory }}"
  lineinfile:
    path: '{{ item.1.path }}'
    line: -a always,exit -F path={{ item.0.item }} -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
    create: false
    regexp: ^.*path={{ item.0.item }} .*$
  with_subelements:
  - '{{ files_result.results }}'
  - files

- name: Adds the rule in rules.d
  lineinfile:
    path: "{{ audit_directory }}/privileged.rules"
    line: -a always,exit -F path={{ item.item }} -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
    create: true
  with_items:
  - '{{ files_result.results }}'
  when:
  - files_result.results is defined and item.matched == 0
