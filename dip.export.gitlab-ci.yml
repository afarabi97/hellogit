Create DIP artifacts folder:
  stage: pre-build
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    rm -f "$DIP_EXPORT_LOC"/*
    mkdir -p "$DIP_EXPORT_LOC/"

    rm -f "$DIP_DOC_EXPORT_LOC"/*
    mkdir -p "$DIP_DOC_EXPORT_LOC/"
  only:
    variables:
      - $PIPELINE == "export-dip"
      - $PIPELINE == "export-all"

Build DIP Offline Documentation:
  stage: build
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/pipeline.py \
    --system-name "DIP" \
    run-export export-html-docs \
    --username "$CONFLUENCE_USERNAME" \
    --password "$CONFLUENCE_PASSWORD" \
    --export-path "$DIP_DOC_EXPORT_LOC" \
    --export-version "$TFPLENUM_EXPORT_VERSION" \
    --page-title "$TFPLENUM_CONFLUENCE_PAGE"

    python3 testing/pipeline/pipeline.py \
    --system-name "DIP" \
    run-export export-single-page-pdf \
    --username "$CONFLUENCE_USERNAME" \
    --password "$CONFLUENCE_PASSWORD" \
    --export-path "$DIP_DOC_EXPORT_LOC" \
    --export-version "$TFPLENUM_EXPORT_VERSION" \
    --page-titles "6.8.1.2 DIP System Setup" "6.8.2.1 DIP System Operation" "6.8.9.4 Windows Agent Plugin Guide" "6.8.9.5 Helm Integration" "6.8.9.2 Setup Controller"
  retry: 2
  only:
    variables:
      - $PIPELINE == "export-dip"
      - $PIPELINE == "export-all"

Ship Phyical Stack Build:
  stage: build
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    zip -r physical-stack-build-$TFPLENUM_EXPORT_VERSION.zip infrastucture/
    cp physical-stack-build-$TFPLENUM_EXPORT_VERSION.zip "$DIP_EXPORT_LOC"
  only:
    variables:
      - $PIPELINE == "export-dip"
      - $PIPELINE == "export-all"

Add Docs to DIP Controller:
  stage: docs
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/pipeline.py \
    --system-name "DIP" \
    run-export add-docs-to-controller \
    --username "$CONFLUENCE_USERNAME" \
    --password "$CONFLUENCE_PASSWORD" \
    --export-path "$DIP_DOC_EXPORT_LOC" \
    --export-version "$TFPLENUM_EXPORT_VERSION" \
    --page-title "$TFPLENUM_CONFLUENCE_PAGE"
  cache:
    key: tfplenum-dip-cache-${CI_PIPELINE_ID}
    paths:
      - controllersetupsettings_dip.yml
    policy: pull
  only:
    variables:
      - $PIPELINE == "export-dip"
      - $PIPELINE == "export-all"
  retry: 2
  artifacts:
    paths:
      - "htmlcov.zip"

Export DIP Controller:
  stage: export
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/pipeline.py \
    --system-name "DIP" \
    run-export export-ctrl \
    --export-path "$DIP_EXPORT_LOC" \
    --export-version "$TFPLENUM_EXPORT_VERSION"
  cache:
    key: tfplenum-dip-cache-${CI_PIPELINE_ID}
    paths:
      - controllersetupsettings_dip.yml
    policy: pull
  only:
    variables:
      - $PIPELINE == "export-dip"
      - $PIPELINE == "export-all"

Generate DIP Versions File:
  stage: hashfiles
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/pipeline.py \
    --system-name "DIP" \
    run-export generate-versions-file \
    --export-path "$DIP_EXPORT_LOC" \
    --export-version "$TFPLENUM_EXPORT_VERSION"
  only:
    variables:
      - $PIPELINE == "export-dip"
      - $PIPELINE == "export-all"
