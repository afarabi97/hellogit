<div class="main-content2">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Page Instructions</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="pageInstructions">
        <p>
          This page allows you to build and download a self-extracting archive for installing various monitoring
          agents on Windows 7, 8 and 10.
          <br><br>
          Before filling out the form, make sure you have configured your Kit's PFSense firewall as well as installed logstash.
          When all inputs are valid, the "Build Agent" button will be enabled.
          <br><br>
          Note: The checks on this page are only for <i>valid</i> data, not <i>correct</i> data. For example, any
          valid IP address will work for the "PF Sense Firewall IP", even if it not your actual firewall IP.
        </p>
      </div>
    </mat-card-content>
  </mat-card>
  <br>
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        Step 1: Create a Windows installer configuration.
        <button mat-raised-button color="primary" [disabled]="appConfigs ? false : true" (click)="addNewConfiguration()">Add Installer Config</button>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="configs">

        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>Select</th>
          <td mat-cell *matCellDef="let config; index as i">
              <mat-radio-button (change)="updateSelectedConfig(config)" [value]="i" name="configGroup"></mat-radio-button>
          </td>
        </ng-container>

        <ng-container matColumnDef="config_name">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let config">{{ config.config_name }}</td>
        </ng-container>

        <ng-container matColumnDef="install_custom">
          <th mat-header-cell *matHeaderCellDef>Custom</th>
          <td mat-cell *matCellDef="let cfg">
            <div *ngIf="cfg?.customPackages; else customNo">
              <i class="material-icons" style="color:lightgreen;">check_circle</i>
            </div>
            <ng-template #customNo>
              <i class="material-icons" style="color:lightgreen;">panorama_fish_eye</i>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="install_endgame">
          <th mat-header-cell *matHeaderCellDef>Endgame</th>
          <td mat-cell *matCellDef="let cfg">
            <div *ngIf="cfg.install_endgame; else sysNo">
              <i class="material-icons" style="color:lightgreen;">check_circle</i>
            </div>
            <ng-template #sysNo>
              <i class="material-icons" style="color:lightgreen;">panorama_fish_eye</i>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="endgame_sensor_name">
          <th mat-header-cell *matHeaderCellDef>Endgame Sensor</th>
          <td mat-cell *matCellDef="let config">{{ config.endgame_sensor_name }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Action</th>
          <td mat-cell *matCellDef="let config">
            <button mat-button (click)="openConfirmDeleteConfig(config)">
              <i class="material-icons" style="color:red;">delete</i>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnsForInstallerConfigs"></tr>
        <tr mat-row *matRowDef="let row; columns: columnsForInstallerConfigs;"></tr>
      </table>
      <mat-paginator #installerConfigPaginator [pageSize]="5"
                      [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
    </mat-card-content>
    <mat-card-actions>
        <button mat-raised-button color="primary" (click)="downloadInstaller(config_selection)"
                [disabled]="config_selection ? is_downloading : true">
        <i class="material-icons">cloud_download</i> Download Installer
      </button>
      <button mat-raised-button color="primary" [disabled]="config_selection ? false : true" (click)="showConfig(config_selection)">Details</button>
    </mat-card-actions>
  </mat-card>
  <br>
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        Step 2 (optional): Add remote targets
        <button mat-raised-button color="primary" (click)="openAddNewTargetConfigModal()">Add Target Config</button>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table #targetTable [dataSource]="targetConfigs" multiTemplateDataRows>
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>Select</th>
          <td mat-cell *matCellDef="let target; dataIndex as i">
            <mat-radio-button (change)="updateSelectedTarget(target)" [value]="i" name="targetGroup"></mat-radio-button>
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let target; dataIndex as i">
            <a (click)="toggleHostListExpansion(target, i)">
              <i class="material-icons">{{ target['state'].expanded ? 'expand_more' : 'chevron_right'}}</i>
              <span style="vertical-align: super;">{{ target['config'].name }}</span>
            </a>
          </td>
        </ng-container>

        <ng-container matColumnDef="protocol">
          <th mat-header-cell *matHeaderCellDef>Protocol</th>
          <td mat-cell *matCellDef="let target">{{ target['config'].protocol }}</td>
        </ng-container>

        <ng-container matColumnDef="port">
          <th mat-header-cell *matHeaderCellDef>Port</th>
          <td mat-cell *matCellDef="let target">{{ getPort(target['config']) }}</td>
        </ng-container>

        <ng-container matColumnDef="domain_name">
          <th mat-header-cell *matHeaderCellDef>DNS Suffix</th>
          <td mat-cell *matCellDef="let target">{{ getDomainSuffix(target['config']) }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Action</th>
          <td mat-cell *matCellDef="let target; dataIndex as i">
            <button mat-button (click)="openConfirmDeleteTarget(target['config'], i)">
              <i class="material-icons" style="color:red;">delete</i>
            </button>
          </td>
        </ng-container>

        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let target; dataIndex as i" [attr.colspan]="columnsForTargetConfigs.length">
            <div>
              <button mat-raised-button color="primary" style="margin-top: 10px;"
                      (click)="openAddWindowsHostModal(target['config'], target['state']['hostList'])">Add Windows Hosts</button>

              <table mat-table #hostTable [dataSource]="getHostList(target['state']['hostList'], hostListPaginator)">

                <ng-container matColumnDef="hostname">
                  <th mat-header-cell *matHeaderCellDef>Hostname</th>
                  <td mat-cell *matCellDef="let host">{{ host.hostname }}</td>
                </ng-container>

                <ng-container matColumnDef="state">
                  <th mat-header-cell *matHeaderCellDef>State</th>
                  <td mat-cell *matCellDef="let host">{{ host.state }}</td>
                </ng-container>

                <ng-container matColumnDef="last_state_change">
                  <th mat-header-cell *matHeaderCellDef>Last State Change</th>
                  <td mat-cell *matCellDef="let host">{{ host.last_state_change }}</td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Actions</th>
                  <td mat-cell *matCellDef="let host; index as host_index">
                      <!-- The menu for this button is defined at the bottom of this html page. -->
                      <button mat-icon-button
                        (click)="$event.stopPropagation()"
                        [matMenuTriggerFor]="menu"
                        [matMenuTriggerData]="{ config: config_selection, target_config: target['config'], host_table: hostTable, host_list: target['state']['hostList'], host: host, host_index: host_index }">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="columnsForHosts"></tr>
                <tr mat-row *matRowDef="let row; columns: columnsForHosts;"></tr>

              </table>

              <mat-paginator #hostListPaginator [pageSize]="10"
                             [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>

            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnsForTargetConfigs"></tr>
        <tr mat-row *matRowDef="let row; columns: columnsForTargetConfigs;"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']; dataIndex as i" [hidden]="!isHostListExpanded(row, i)"></tr>
      </table>
      <mat-paginator #targetConfigPaginator [pageSize]="5"
                     [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>

    </mat-card-content>

    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="installAgents(config_selection, target_selection)"
                         [disabled]="!(config_selection && target_selection)">
        <i class="material-icons">cloud_upload</i> Deploy Installer
      </button>
      <button mat-raised-button color="warn" style="float: right;"
        [disabled]="!(config_selection && target_selection)" (click)="uninstallAgents(config_selection, target_selection)">
        <i class="material-icons">delete_sweep</i> Batch Uninstall
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<mat-menu #menu="matMenu">
  <ng-template matMenuContent let-config="config" let-target_config="target_config" let-host_table="host_table" let-host_list="host_list" let-host="host" let-host_index="host_index">
    <button mat-menu-item
            [disabled]="config ? false : true"
            (click)="reinstallAgent(config, target_config, host)">
      <mat-icon>sync</mat-icon><span>Reinstall Agent</span>
    </button>

    <button mat-menu-item
            [disabled]="config ? false : true"
            (click)="uninstallAgent(config, target_config, host)">
      <mat-icon>delete</mat-icon><span>Uninstall Agent</span>
    </button>

    <button mat-menu-item
            (click)="openRemoveHostModal(target_config, host_table, host_list, host, host_index)">
      <mat-icon>delete_forever</mat-icon><span>Remove Agent entry</span>
    </button>
  </ng-template>
</mat-menu>
