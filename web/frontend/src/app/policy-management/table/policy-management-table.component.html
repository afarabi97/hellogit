<mat-card>
  <mat-card-header>
    <mat-card-title>
      <button mat-raised-button id="policy-management-table-mat-card-mat-card-header-mat-card-title-button-rule-sync"
              matTooltip="Synchronize RuleSets" color="primary" (click)="ruleSync()">
        <em id="policy-management-table-mat-card-mat-card-header-mat-card-title-button-rule-sync-em-swap-horiz"
            class="material-icons">swap_horiz</em>Rule Sync</button>
      <button mat-raised-button id="policy-management-table-mat-card-mat-card-header-mat-card-title-button-add-ruleset"
              matTooltip="Add RuleSet" color="primary" style="margin-right: 10px;" (click)="addRuleSet()">
        <em id="policy-management-table-mat-card-mat-card-header-mat-card-title-button-add-ruleset-em-add-circle-outline"
            class="material-icons">add_circle_outline</em>Add RuleSet</button>
    </mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <div fxLayout="column" fxLayoutAlign="start stretch">
      <!-- Filter -->
      <mat-form-field id="policy-management-table-mat-card-mat-card-content-div-mat-form-field-filter" color="accent">
        <input matInput id="policy-management-table-mat-card-mat-card-content-div-mat-form-field-filter-input"
               placeholder="Filter" (keyup)="applyFilter($event.target.value)">
      </mat-form-field>
    </div>
    <table mat-table multiTemplateDataRows [dataSource]="ruleSetsDataSource"
           class="table" aria-describedby="Ruleset table">
      <!-- Is Enabled -->
      <ng-container matColumnDef="Enabled">
        <th scope="col" mat-header-cell *matHeaderCellDef>Is Enabled?</th>
        <td mat-cell *matCellDef="let ruleSet; dataIndex as z;"
            id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-is-enabled' }}" class="mat-header-cell">
          <mat-checkbox id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-is-enabled-mat-checkbox' }}"
                        class="mat-checkbox-inner-container" [checked]="ruleSet.isEnabled" (change)="enableRuleSet(ruleSet)"></mat-checkbox>
        </td>
      </ng-container>
      <!-- Rule Set Name -->
      <ng-container matColumnDef="name">
        <th scope="col" mat-header-cell *matHeaderCellDef>Rule Set Name</th>
        <td mat-cell *matCellDef="let ruleSet; dataIndex as z;"
            id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-rule-set-name' }}" class="mat-header-cell">
          <a id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-rule-set-name-a' }}" (click)="getRules(ruleSet)">
            <em *ngIf="!isRulesVisibleFn(ruleSet)"
                id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-rule-set-name-a-em-chevron-right' }}"
                class="material-icons">chevron_right</em>
            <em *ngIf="isRulesVisibleFn(ruleSet)"
                id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-rule-set-name-a-em-expand-more' }}"
                class="material-icons">expand_more</em>
            <span id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-rule-set-name-a-span-name' }}"
                  style="vertical-align: super;">{{ ruleSet.name }}</span>
          </a>
        </td>
      </ng-container>
      <!-- Type -->
      <ng-container matColumnDef="appType">
        <th scope="col" mat-header-cell *matHeaderCellDef>Type</th>
        <td mat-cell *matCellDef="let ruleSet; dataIndex as z;"
            id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-type' }}" class="mat-header-cell">
          {{ ruleSet.appType }}
        </td>
      </ng-container>
      <!-- Classification -->
      <ng-container matColumnDef="clearance">
        <th scope="col" mat-header-cell *matHeaderCellDef>Classification</th>
        <td mat-cell *matCellDef="let ruleSet; dataIndex as z;"
            id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-classification' }}" class="mat-header-cell">
          {{ ruleSet.clearance }}
        </td>
      </ng-container>
      <!-- State -->
      <ng-container matColumnDef="state">
        <th scope="col" mat-header-cell *matHeaderCellDef>State</th>
        <td mat-cell *matCellDef="let ruleSet; dataIndex as z;"
            id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-state' }}" class="mat-header-cell">
          <ng-container *ngIf="!isInstanceOfArray(ruleSet.state)">
            {{ ruleSet.state }}
          </ng-container>
          <ng-container *ngIf="isInstanceOfArray(ruleSet.state)">
            <dl>
              <ng-container *ngFor="let state of ruleSet.state">
                <dt id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-classification-dl-dt-hostname' }}">{{ state.hostname }}</dt>
                <dd id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-classification-dl-dt-state' }}">- {{ state.state }}</dd>
              </ng-container>
            </dl>
          </ng-container>
        </td>
      </ng-container>
      <!-- Assigned Sensors -->
      <ng-container matColumnDef="sensors">
        <th scope="col" mat-header-cell *matHeaderCellDef>Assigned Sensors</th>
        <td mat-cell *matCellDef="let ruleSet; dataIndex as z;"
            id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-assigned-sensors' }}" class="mat-header-cell">
          <ng-container *ngIf="!isInstanceOfArray(ruleSet.sensors)">
              {{ ruleSet.sensors }}
          </ng-container>
          <ng-container *ngIf="isInstanceOfArray(ruleSet.sensors)">
            <div *ngFor="let sensor of ruleSet.sensors; let i = index;"
                 id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-assigned-sensors-div-' + i + '-hostname' }}">
              <ng-container *ngIf="sensor">{{ sensor.hostname }}</ng-container></div>
          </ng-container>
        </td>
      </ng-container>
      <!-- Actions -->
      <ng-container matColumnDef="Actions">
        <th scope="col" mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let ruleSet; dataIndex as z;"
            id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-actions' }}" class="mat-header-cell">
          <button mat-button id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-actions-button-cloud-upload' }}"
                  matTooltip="Upload Rules File" (click)="uploadRulesFile(ruleSet)">
            <em id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-actions-button-cloud-upload-em' }}"
                class="material-icons">cloud_upload</em>
          </button>
          <button mat-button id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-actions-button-edit' }}"
                  matTooltip="Edit RuleSet" (click)="editRuleSet(ruleSet)">
            <em id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-actions-button-edit-em' }}"
                class="material-icons">edit</em>
          </button>
          <button mat-button id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-actions-button-delete' }}"
                  matTooltip="Remove RuleSet" (click)="openRemoveRuleSetConfirmModal(ruleSet)">
            <em id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-actions-button-delete-em' }}"
                class="material-icons" style="color: red">delete</em>
          </button>
        </td>
      </ng-container>

      <ng-container class="mat-row" matColumnDef="expandedDetail">
        <!-- Expanded Detail -->
        <td mat-cell *matCellDef="let ruleSet; dataIndex as z;"
            id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail' }}"
            [attr.colspan]="columnsToDisplay.length">
          <div style="margin-top: 10px;">
            <button mat-raised-button id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-button-add-rule' }}"
                    matTooltip="Add Rules" color="primary" (click)="addRule(ruleSet)">
              <em id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-button-add-rule-em-add-circle-outline' }}"
                  class="material-icons">add_circle_outline</em>Add Rule</button>

            <table mat-table multiTemplateDataRows [dataSource]="rulesDataSource" aria-describedby="Rules sub table">
              <!-- Is Enabled -->
              <ng-container matColumnDef="Enabled">
                <th scope="row" mat-header-cell *matHeaderCellDef>Is Enabled?</th>
                <td mat-cell *matCellDef="let rule; dataIndex as i;"
                    id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-td-' + i + '-is-enabled' }}">
                  <mat-checkbox id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-td-' + i + '-is-enabled-mat-checkbox' }}"
                                class="mat-checkbox-inner-container" [checked]="isRuleChecked(rule)" (change)="enableRule(rule, ruleSet)"></mat-checkbox>
                </td>
              </ng-container>
              <!-- Rule Name -->
              <ng-container matColumnDef="ruleName">
                <th scope="row" mat-header-cell *matHeaderCellDef>Rule Name</th>
                <td mat-cell *matCellDef="let rule; dataIndex as i;"
                    id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-td-' + i + '-rule-name' }}"
                    class="rule-padding">{{ rule.ruleName }}</td>
              </ng-container>
              <!-- Last Modified -->
              <ng-container matColumnDef="lastModifiedDate">
                <th scope="row" mat-header-cell *matHeaderCellDef>Last Modified</th>
                <td mat-cell *matCellDef="let rule; dataIndex as i;"
                    id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-td-' + i + '-last-modified' }}">{{ rule.lastModifiedDate }}</td>
              </ng-container>
              <!-- Actions -->
              <ng-container matColumnDef="Actions">
                <th scope="row" mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let rule; dataIndex as i;"
                    id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-td-' + i + '-actions' }}">
                  <button mat-button id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-td-' + i + '-actions-button-edit' }}"
                          matTooltip="Edit Rule" (click)="editRule(ruleSet, rule)">
                    <em id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-td-' + i + '-actions-button-edit-em' }}"
                        class="material-icons">edit</em>
                  </button>
                  <button mat-button id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-td-' + i + '-actions-button-delete' }}"
                          matTooltip="Remove Rule" (click)="openRemoveRuleConfirmModal(rule, ruleSet)">
                    <em id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-td-' + i + '-actions-button-delete-em' }}"
                        class="material-icons" style="color: red">delete</em>
                  </button>
                </td>
              </ng-container>
              <!-- Table Rows -->
              <tr mat-header-row *matHeaderRowDef="innerColumnsToDisplay"></tr>
              <tr mat-row *matRowDef="let row; columns: innerColumnsToDisplay; let j = index;"
                  id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-table-tr-mat-row-' + j }}"></tr>
            </table>
            <mat-paginator #paginatorInner id="{{ 'policy-management-table-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-mat-paginator' }}"
                           [pageSize]="20" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
          </div>
        </td>
      </ng-container>
      <!-- Table Rows -->
      <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
      <tr mat-row *matRowDef="let rules; columns: columnsToDisplay; let k = index;"
          id="{{ 'policy-management-table-mat-card-mat-card-content-table-tr-mat-row-' + k }}"
          class="example-element-row" [class.example-expanded-row]="expandedElement === rules"
          (click)="expandedElement = expandedElement === rules ? null : rules">
      </tr>
      <tr mat-row *matRowDef="let row; columns: ['expandedDetail']; let l = index;"
          id="{{ 'policy-management-table-mat-card-mat-card-content-table-tr-mat-row-expanded-detail-' + l }}"  [hidden]="!isRulesVisibleFn(row)"></tr>
    </table>
    <mat-paginator #paginator showFirstLastButtons
                   id="policy-management-table-mat-card-mat-card-content-mat-paginator"
                   class="feature_desc" [pageSize]="20" [pageSizeOptions]="[5, 10, 20]"></mat-paginator>
  </mat-card-content>
</mat-card>
