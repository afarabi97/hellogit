<app-modal-dialog [modal]="removeRuleModal" (primaryButtonClick)="removeRule()"></app-modal-dialog>
<app-modal-dialog [modal]="removeRuleSetModal" (primaryButtonClick)="removeRuleSet()"></app-modal-dialog>
<app-modal-dialog [modal]="messageModal"></app-modal-dialog>
<mat-form-field color="accent">
  <input matInput placeholder="filter" (keyup)="applyFilter($event.target.value)">
</mat-form-field>

<mat-form-field style="margin-top: 10px;">
  <mat-label>Rule Set Group</mat-label>
  <mat-select (selectionChange)="filterByRuleSetGroup($event)">
    <mat-option *ngFor="let group of ruleSetGroups" [value]="group">
      {{ group }}
    </mat-option>
  </mat-select>
</mat-form-field>

<table mat-table
      [dataSource]="_PolicyManagementService.dataSource"
      multiTemplateDataRows
      class="table">

  <ng-container matColumnDef="Enabled">
    <th mat-header-cell *matHeaderCellDef>Is Enabled?</th>
    <td mat-cell class="mat-header-cell" *matCellDef="let ruleSet" fxLayout="column" fxLayoutGap="10px" fxLayoutAlign="space-evenly center">
      <mat-checkbox class="mat-checkbox-inner-container" [checked]="ruleSet.isEnabled" (change)="enableRuleSet(ruleSet)"></mat-checkbox>
    </td>
  </ng-container>

  <ng-container matColumnDef="name">
    <th mat-header-cell *matHeaderCellDef>Rule Set Name</th>
    <td mat-cell class="mat-header-cell" *matCellDef="let ruleSet" fxLayout="column" fxLayoutGap="10px" fxLayoutAlign="space-evenly center">
      <a class="dropdown-toggle" (click)="getRules(ruleSet)">{{ ruleSet.name }}</a>
    </td>
  </ng-container>

  <ng-container matColumnDef="clearance">
    <th mat-header-cell *matHeaderCellDef>Classification</th>
    <td mat-cell class="mat-header-cell" *matCellDef="let ruleSet" fxLayout="column" fxLayoutGap="10px" fxLayoutAlign="space-evenly center">
      {{ ruleSet.clearance }}
    </td>
  </ng-container>

  <ng-container matColumnDef="state">
    <th mat-header-cell *matHeaderCellDef>State</th>
    <td mat-cell class="mat-header-cell" *matCellDef="let ruleSet" fxLayout="column" fxLayoutGap="10px" fxLayoutAlign="space-evenly center">
      <ng-container *ngIf="!isInstanceOfArray(ruleSet.state)">
        {{ ruleSet.state }}
      </ng-container>
      <ng-container *ngIf="isInstanceOfArray(ruleSet.state)">
        <dl>
          <ng-container *ngFor="let state of ruleSet.state">
            <dt>{{ state.hostname }}</dt>
            <dd>- {{ state.state }}</dd>
          </ng-container>          
        </dl>
      </ng-container>
    </td>
  </ng-container>

  <ng-container matColumnDef="sensors">
    <th mat-header-cell *matHeaderCellDef>Assigned Sensors</th>
    <td mat-cell class="mat-header-cell" *matCellDef="let ruleSet" fxLayout="column" fxLayoutGap="10px" fxLayoutAlign="space-evenly center">
      <ng-container *ngIf="!isInstanceOfArray(ruleSet.sensors)">
          {{ ruleSet.sensors }}
      </ng-container>
      <ng-container *ngIf="isInstanceOfArray(ruleSet.sensors)">
        <div *ngFor="let sensor of ruleSet.sensors"><ng-container *ngIf="sensor">{{ sensor.hostname }}</ng-container></div>        
      </ng-container>
    </td>
  </ng-container>

  <ng-container matColumnDef="Actions">
    <th mat-header-cell *matHeaderCellDef>Actions</th>
    <td mat-cell class="mat-header-cell" *matCellDef="let ruleSet" fxLayout="column" fxLayoutGap="10px" fxLayoutAlign="space-evenly center">
        <button title="Edit Rule" class="btn btn-primary" (click)="editRuleSet(ruleSet)"><i class="icon_pencil"></i></button>
        <button title="Remove Rule" class="btn btn-danger" (click)="openRemoveRuleSetConfirmModal(ruleSet)"><i class="icon_close_alt2"></i></button>
    </td>
  </ng-container>

  <ng-container class="mat-row" matColumnDef="expandedDetail" >
    <td mat-cell *matCellDef="let ruleSet" [attr.colspan]="columnsToDisplay.length" >
      <div *ngIf="isRulesVisibleFn(ruleSet)" class="example-element-detail row">
        <div class="col-12" style="margin-top: 7px;">
          <button title="Add Rules" class="btn btn-primary" (click)="addRule(ruleSet)"><i class="icon_plus_alt2"></i> Add Rule</button>
        </div>
        <div class="col-12">
          <table mat-table [dataSource]="_PolicyManagementService.innerDataSource" class="table custom-mat-inner-table" multiTemplateDataRows>
            <ng-container matColumnDef="Enabled">
              <th mat-header-cell *matHeaderCellDef>Is Enabled?</th>
              <td mat-cell *matCellDef="let rule">
                  <mat-checkbox class="mat-checkbox-inner-container" [checked]="isRuleChecked(rule)" (change)="enableRule(rule, ruleSet)"></mat-checkbox>
              </td>
            </ng-container>
            <ng-container matColumnDef="ruleName">
              <th mat-header-cell *matHeaderCellDef>Rule Name</th>
              <td mat-cell *matCellDef="let rule" class="rule-padding">{{ rule.ruleName }}</td>
            </ng-container>
            <ng-container matColumnDef="lastModifiedDate">
              <th mat-header-cell *matHeaderCellDef>Last Modified</th>
              <td mat-cell *matCellDef="let rule">{{ rule.lastModifiedDate }}</td>
            </ng-container>
            <ng-container matColumnDef="Actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let rule">
                  <button title="Edit Rule" class="btn btn-primary" (click)="editRule(ruleSet, rule)"><i class="icon_pencil"></i></button>
                  <button title="Remove Rule" class="btn btn-danger" (click)="openRemoveRuleConfirmModal(rule, ruleSet)"><i class="icon_close_alt2"></i></button>
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="innerColumnsToDisplay"></tr>
            <tr mat-row *matRowDef="let row; columns: innerColumnsToDisplay;"></tr>
          </table>
        </div>
      </div>
      <mat-paginator *ngIf="isRulesVisibleFn(ruleSet)"
                     class="feature_desc"
                     style="background: #222;"
                     #paginatorInner
                     [pageSize]="20"
                     [pageSizeOptions]="[5, 10, 20]"
                     showFirstLastButtons></mat-paginator>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
  <tr mat-row *matRowDef="let rules; columns: columnsToDisplay;"
      class="example-element-row"
      [class.example-expanded-row]="expandedElement === rules"
      (click)="expandedElement = expandedElement === rules ? null : rules">
  </tr>  
  <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr> 
</table>
<mat-paginator class="feature_desc" #paginator [pageSize]="20" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>