<div class="main-content2">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Node Health</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <table mat-table [dataSource]="nodes" multiTemplateDataRows aria-describedby="Node table">
        <!-- Name -->
        <ng-container matColumnDef="name">
          <th scope="col" mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let node; let z = index;"
              id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-name' }}">
            <a id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-name-a' }}" (click)="toggleNodeResources(node.metadata.name)">
              <em *ngIf="!is_node_expanded[node.metadata.name]"
                  id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-name-a-em-chevron-right' }}"
                  class="material-icons">chevron_right</em>
              <em *ngIf="is_node_expanded[node.metadata.name]"
                  id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-name-a-em-expand-more' }}"
                  class="material-icons">expand_more</em>
              <span id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-name-a-span-metadata-name' }}" style="vertical-align: super;">{{ node.metadata.name }}</span>
            </a>
          </td>
        </ng-container>

        <!-- Type -->
        <ng-container matColumnDef="type">
          <th scope="col" mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let node; let z = index;"
              id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-type' }}">
            {{ node.metadata.labels.role | titlecase}}
          </td>
        </ng-container>

        <!-- IP Address -->
        <ng-container matColumnDef="ip_address">
          <th scope="col" mat-header-cell *matHeaderCellDef>IP Address</th>
          <td mat-cell *matCellDef="let node; let z = index;"
              id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-ip-address' }}">
            <a id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-ip-address-a' }}"
               (click)="openNodeInfo(node.metadata.name, node.status.node_info)">{{ node.status.addresses[0].address }}</a>
          </td>
        </ng-container>

        <!-- Ready -->
        <ng-container matColumnDef="ready">
          <th scope="col" mat-header-cell *matHeaderCellDef>Ready</th>
          <td mat-cell *matCellDef="let node; let z = index;"
              id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-ready' }}">
            <a id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-ready-a' }}" matTooltip="{{ node.status.conditions[4].message }}">
              <div *ngIf="node.status.conditions[4].status === 'True'; else notworking">
                <em id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-ready-a-div-em-check-circle' }}"
                    class="material-icons" style="color:lightgreen;">check_circle</em>
              </div>
              <ng-template #notworking>
                <em id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-ready-a-em-cancel' }}"
                    class="material-icons" style="color:darkred;">cancel</em>
              </ng-template>
            </a>
          </td>
        </ng-container>

        <!-- Storage -->
        <ng-container matColumnDef="storage">
          <th scope="col" mat-header-cell *matHeaderCellDef>Storage</th>
          <td mat-cell *matCellDef="let node; let z = index;"
              id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-storage' }}">
            <div *ngIf="utilization_info[node.metadata.name]?.root_usage">
              <span id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-storage-span-root-percentage' }}"
                    matTooltip="{{ utilization_info[node.metadata.name].root_usage['free'] / 1073741824 | number : '.2-2' }} GiB free">root: {{ utilization_info[node.metadata.name].root_usage['percent'] }}%</span>
            </div>
            <div *ngIf="utilization_info[node.metadata.name]?.data_usage">
              <span id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-storage-span-data-percentage' }}"
                    matTooltip="{{ utilization_info[node.metadata.name].data_usage['free'] / 1073741824 | number : '.2-2' }} GiB free">data: {{ utilization_info[node.metadata.name].data_usage['percent'] }}%</span>
            </div>
          </td>
        </ng-container>

        <!-- Memory -->
        <ng-container matColumnDef="memory">
          <th scope="col" mat-header-cell *matHeaderCellDef>Memory</th>
          <td mat-cell *matCellDef="let node; let z = index;"
              id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-memory' }}">
            <div *ngIf="utilization_info[node.metadata.name]?.memory">
              <span id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-memory-span-percentage' }}"
                    matTooltip="{{ utilization_info[node.metadata.name].memory['available'] / 1073741824 | number : '.2-2' }} GiB available">{{ utilization_info[node.metadata.name].memory['percent'] }}%</span>
            </div>
          </td>
        </ng-container>

        <!-- CPU -->
        <ng-container matColumnDef="cpu">
          <th scope="col" mat-header-cell *matHeaderCellDef>CPU</th>
          <td mat-cell *matCellDef="let node; let z = index;"
              id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-cpu' }}">
            <div *ngIf="utilization_info[node.metadata.name]?.cpu_percent">
              <span id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-cpu-span-percentage' }}">{{ utilization_info[node.metadata.name].cpu_percent }}%</span>
            </div>
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th scope="col" mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let node; let z = index;"
              id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-actions' }}">
            <button mat-button id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-actions-button' }}"
                    matTooltip="Click to run describe node." color="primary" (click)="describeNode(node.metadata.name)">
              <em id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-actions-button-em-info' }}"
                  class="material-icons">info</em>
            </button>
          </td>
        </ng-container>

        <!-- Expanded Detail -->
        <ng-container matColumnDef="expanded_detail">
          <td mat-cell *matCellDef="let node; let z = index;"
              id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail' }}"
              [attr.colspan]="columns_for_node_table.length">
            <div fxLayout="row" fxLayoutAlign="start none">
              <div fxFlex="33">
                Total Capacity
                <dl fxLayout="column" fxLayoutAlign="start none">
                  <dt>CPUs:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-total-capacity-dl-dd-cpu' }}">{{ node_info[node.metadata.name]['status.capacity.cpu'] }}</dd>
                  <dt>Ephemeral storage:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-total-capacity-dl-dd-ephemeral-storage' }}">{{ node_info[node.metadata.name]['status.capacity.ephemeral-storage'] }}</dd>
                  <dt>Memory:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-total-capacity-dl-dd-memory' }}">{{ node_info[node.metadata.name]['status.capacity.memory'] }}</dd>
                  <dt>Max Pods:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-total-capacity-dl-dd-max-pods' }}">{{ node.status.capacity.pods }}</dd>
                </dl>
              </div>
              <div fxFlex="33">
                Kubernetes Capacity
                <dl>
                  <dt>CPUs:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-kubernetes-capacity-dl-dd-cpu' }}">{{ node_info[node.metadata.name]['status.allocatable.cpu'] }}</dd>
                  <dt>Ephemeral storage:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-kubernetes-capacity-dl-dd-ephemeral-storage' }}">{{ node_info[node.metadata.name]['status.allocatable.ephemeral-storage'] }}</dd>
                  <dt>Memory:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-kubernetes-capacity-dl-dd-memory' }}">{{ node_info[node.metadata.name]['status.allocatable.memory'] }}</dd>
                  <dt>Max Pods:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-kubernetes-capacity-dl-dd-max-pods' }}">{{ node.status.allocatable.pods }}</dd>
                </dl>
              </div>
              <div fxFlex="33">
                Other
                <dl>
                  <dt>CPUs requested from pods:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-other-dl-dd-cpus-requested-from-pods' }}">{{ totals[node.metadata.name]['cpus_requested_str'] }}</dd>
                  <dt>Remaining allocatable CPUs:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-other-dl-dd-remaining-allocatable-cpus' }}">{{ totals[node.metadata.name]['remaining_allocatable_cpu'] }}</dd>
                  <dt>Memory requested from pods:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-other-dl-dd-memory-requested-from-pods' }}">{{ totals[node.metadata.name]['mem_requested_str'] }}</dd>
                  <dt>Remaining allocatable memory:</dt>
                  <dd id="{{ 'app-system-health-div-mat-card-mat-card-content-table-td-' + z + '-expanded-detail-div-div-other-dl-dd-remaining-allocatable-memory' }}">{{ totals[node.metadata.name]['remaining_allocatable_mem'] }}</dd>
                </dl>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Table Rows -->
        <tr mat-header-row *matHeaderRowDef="columns_for_node_table"></tr>
        <tr mat-row *matRowDef="let node; columns: columns_for_node_table; let i = index;"
            id="{{ 'app-system-health-div-mat-card-mat-card-content-table-tr-mat-row-' + i }}"></tr>
        <tr mat-row *matRowDef="let node; columns: ['expanded_detail']; let j = index;"
            id="{{ 'app-system-health-div-mat-card-mat-card-content-table-tr-mat-row-expanded-detail-' + j }}"
            [hidden]="!is_node_expanded[node.metadata.name]"></tr>
      </table>
    </mat-card-content>
  </mat-card>

  <br>

  <ng-container *ngIf="pod_errors && pod_errors.data.length > 0">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Pod Errors</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <ng-container [ngTemplateOutlet]="podTableTemplate"
                      [ngTemplateOutletContext]="{pods:pod_errors, pod_element_id: 'app-system-health-div-mat-card-mat-card-content-pod-errors-pod-status'}"></ng-container>
      </mat-card-content>
    </mat-card>
  </ng-container>

  <br>

  <mat-card>
    <mat-card-header>
      <mat-card-title>Pod Health</mat-card-title>
    </mat-card-header>

    <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

    <mat-card-content *ngIf="pod_health?.scheduled">
      <mat-tab-group dynamicHeight>
        <mat-tab *ngFor="let tab of tabs; let m = index;"
                  id="{{ 'app-system-health-div-mat-card-mat-card-content-pod-health-mat-tab-group-mat-tab-' + m }}"
                  label="{{ tab }}">
          <ng-container [ngTemplateOutlet]="piplineStatus"
                        [ngTemplateOutletContext]="{displayedPipeline: pipeline_status[tab], pipeline_element_id: 'app-system-health-div-mat-card-mat-card-content-pod-health-mat-tab-group-mat-tab-' + m + '-pipeline-status'}"></ng-container>

          <ng-container [ngTemplateOutlet]="podTableTemplate"
                        [ngTemplateOutletContext]="{pods:pod_health.scheduled[tab], isVisible:true, pod_element_id: 'app-system-health-div-mat-card-mat-card-content-pod-health-mat-tab-group-mat-tab-' + m + '-pod-status'}"></ng-container>
        </mat-tab>

        <mat-tab label="Unassigned Pods">
          <ng-container [ngTemplateOutlet]="podTableTemplate"
                        [ngTemplateOutletContext]="{pods:pod_health.unscheduled, isVisible:true, pod_element_id: 'app-system-health-div-mat-card-mat-card-content-pod-health-mat-tab-group-mat-tab-unassigned-pods-pod-status'}"></ng-container>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>

<ng-template #podTableTemplate let-pods='pods' let-isVisible='isVisible' let-pod_element_id='pod_element_id'>
  <table mat-table [dataSource]="pods" multiTemplateDataRows aria-describedby="Pod table">
    <!-- Namespace -->
    <ng-container matColumnDef="namespace">
      <th scope="col" mat-header-cell *matHeaderCellDef>Namespace</th>
      <td mat-cell *matCellDef="let pod; let z = index;"
          id="{{ pod_element_id + '-table-td-' + z + '-namespace' }}">
        <a id="{{ pod_element_id + '-table-td-' + z + '-namespace-a' }}" (click)="openPodDialog(pod)">
          <span id="{{ pod_element_id + '-table-td-' + z + '-namespace-a-span-namespace' }}"
                style="vertical-align: super;">{{ pod.metadata.namespace }}</span>
        </a>
      </td>
    </ng-container>

    <!-- Pod Name -->
    <ng-container matColumnDef="pod_name">
      <th scope="col" mat-header-cell *matHeaderCellDef>Pod Name</th>
      <td mat-cell *matCellDef="let pod; let z = index;"
          id="{{ pod_element_id + '-table-td-' + z + '-pod-name' }}">
        <a id="{{ pod_element_id + '-table-td-' + z + '-pod-name-a' }}"
           matTooltip="Click me" (click)="openPodInfo(pod.metadata.name, pod.status)">{{ pod.metadata.name }}</a>
      </td>
    </ng-container>

    <!-- Container States -->
    <ng-container matColumnDef="container_states">
      <th scope="col" mat-header-cell *matHeaderCellDef>Container States</th>
      <td mat-cell *matCellDef="let pod; let z = index;"
          id="{{ pod_element_id + '-table-td-' + z + '-container-states' }}">
        <div *ngIf="pod.status?.message">
          <span id="{{ pod_element_id + '-table-td-' + z + '-span-pod-status-message' }}" class="podStatus">{{ pod.status.message }}</span>
        </div>
        <div *ngFor="let container_status of pod.status.container_statuses; let k = index;">
          <span id="{{ pod_element_id + '-table-td-' + z + '-container-states-div-' + k + '-span-container-name' }}">{{ container_status.name }}: </span>

          <span id="{{ pod_element_id + '-table-td-' + z + '-container-states-div-' + k + '-span-container-status' }}"
                class="containerStatus" style="font-weight: bold;">{{ getContainerStatus(container_status) }}</span>
        </div>
      </td>
    </ng-container>

    <!-- Restart Count -->
    <ng-container matColumnDef="restart_count">
      <th scope="col" mat-header-cell *matHeaderCellDef>Restart Count</th>
      <td mat-cell *matCellDef="let pod; let z = index;"
          id="{{ pod_element_id + '-table-td-' + z + '-restart-count' }}">
        {{ getPodRestartCount(pod) }}
      </td>
    </ng-container>

    <!-- Actions -->
    <ng-container matColumnDef="actions">
      <th scope="col" mat-header-cell *matHeaderCellDef>Actions</th>
      <td mat-cell *matCellDef="let pod; let z = index;"
          id="{{ pod_element_id + '-table-td-' + z + '-actions' }}">
          <button mat-button id="{{ pod_element_id + '-table-td-' + z + '-actions-button-info' }}"
                  matTooltip="Click to run describe pod." color="primary" (click)="describePod(pod.metadata.name, pod.metadata.namespace)">
            <em id="{{ pod_element_id + '-table-td-' + z + '-actions-button-info-em' }}" class="material-icons">info</em>
          </button>
          <button mat-button id="{{ pod_element_id + '-table-td-' + z + '-actions-button-help' }}"
                  matTooltip="Click to view pod logs." color="primary" (click)="podLogs(pod.metadata.name, pod.metadata.namespace)">
            <em id="{{ pod_element_id + '-table-td-' + z + '-actions-button-help-em' }}" class="material-icons">help</em>
          </button>
      </td>
    </ng-container>

    <!-- Table Rows -->
    <tr mat-header-row *matHeaderRowDef="columns_for_pod_table"></tr>
    <tr mat-row *matRowDef="let pod; columns: columns_for_pod_table; let l = index;"
        id="{{ pod_element_id + '-table-tr-mat-row-' + l }}"
        [ngClass]="{'podErrors': podHasAnError(pod)}"></tr>
  </table>
</ng-template>

<ng-template #piplineStatus let-displayedPipeline='displayedPipeline' let-pipeline_element_id='pipeline_element_id'>
  <ng-container *ngIf="displayedPipeline">
    <div fxLayout="row" fxLayoutAlign="start none">
      <dl fxFlex="20">
        <dt matTooltip="The last Suricata event that occurred on this sensor's disk drive.">Last Suricata Log Event</dt>
        <dd id="{{ pipeline_element_id + '-div-dl-dd-suricata-log-event' }}">{{ displayedPipeline?.last_suricata_log_event ? displayedPipeline?.last_suricata_log_event : 'No events'  }}</dd>
      </dl>
      <dl>
        <dt matTooltip="The last Suricata event that was received by Elasticsearch on the server cluster.">Last Suricata Elastic Event</dt>
        <dd id="{{ pipeline_element_id + '-div-dl-dd-suricata-elastic-event' }}">{{ displayedPipeline?.last_suricata_elastic_events ? displayedPipeline?.last_suricata_elastic_events : 'No events' }}</dd>
      </dl>
    </div>
    <div fxLayout="row" fxLayoutAlign="start none">
      <dl fxFlex="20">
        <dt matTooltip="The last Zeek event that occurred on this sensor's disk drive.">Last Zeek Log Event</dt>
        <dd id="{{ pipeline_element_id + '-div-dl-dd-zeek-log-event' }}">{{ displayedPipeline?.last_zeek_log_event ? displayedPipeline?.last_zeek_log_event : 'No events' }}</dd>
      </dl>
      <dl>
        <dt matTooltip="The last Zeek event that was received by Elasticsearch on the server cluster.">Last Zeek Elastic Event</dt>
        <dd id="{{ pipeline_element_id + '-div-dl-dd-zeek-elastic-event' }}">{{ displayedPipeline.last_zeek_elastic_events ? displayedPipeline.last_zeek_elastic_events : 'No events' }}</dd>
      </dl>
    </div>
    <div fxLayout="row" fxLayoutAlign="start none">
      <dl fxFlex="20">
        <dt matTooltip="The last PCAP capture event that occurred on this sensor's disk drive.">Last PCAP Log Event</dt>
        <dd id="{{ pipeline_element_id + '-div-dl-dd-pcap-log-event' }}">{{ displayedPipeline.last_pcap_log_event ? displayedPipeline.last_pcap_log_event : 'No events' }}</dd>
      </dl>
      <dl>
        <dt matTooltip="The last Arkime event that was received by Elasticsearch on the server cluster.">Last Arkime Elastic Event</dt>
        <dd id="{{ pipeline_element_id + '-div-dl-dd-arkime-elastic-event' }}">{{ displayedPipeline.last_arkime_elastic_events ? displayedPipeline.last_moloch_elastic_events : 'No events' }}</dd>
      </dl>
    </div>
  </ng-container>
</ng-template>
