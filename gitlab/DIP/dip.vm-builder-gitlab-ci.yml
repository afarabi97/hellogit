Create a Kali OVA:
  stage: build
  tags:
    - tfplenum-buildv2
  script: |
    args=(
      setup-kali
      --commit-hash "$CI_COMMIT_SHORT_SHA"
      --cpu "0"
      --disk-size "0"
      --dns-servers $DNS_SERVERS
      --domain "lan"
      --export-password "$OVA_EXPORT_PASSWORD"
      --gateway "$VM_GATEWAY"
      --hostname "Kali"
      --memory "0"
      --network-block-index 0
      --network-id "$NETWORK_ID"
      --pipeline "$PIPELINE"
      --portgroup "$VCENTER_PORTGROUP"
      --storage-disk-size "0"
      --vcenter-cluster "$VCENTER_CLUSTER"
      --vcenter-datacenter "$VCENTER_DATACENTER"
      --vcenter-ipaddress "$VCENTER_IPADDRESS"
      --vcenter-password "$VCENTER_PASSWORD"
      --vcenter-username "$VCENTER_USERNAME"
      --vm-datastore "$VCENTER_DATASTORE"
      --vm-folder "$VMWARE_FOLDER"
      --vm-name "Kali"
      --vm-password "$DEFAULT_TEMPLATE_PASSWORD"
      --vm-template "$KALI_TEMPLATE_TO_CLONE"
    )
    echo "${args[@]}"
    python3 testing/pipeline/pipeline.py "${args[@]}"
  only:
    variables:
      - $PIPELINE == "export-kali"
  artifacts:
    untracked: true

Create a REMnux OVA:
  stage: build
  tags:
    - tfplenum-buildv2
  script: |
    args=(
      setup-remnux
      --commit-hash "$CI_COMMIT_SHORT_SHA"
      --cpu "0"
      --disk-size "0"
      --dns-servers $DNS_SERVERS
      --domain "lan"
      --export-password "$OVA_EXPORT_PASSWORD"
      --gateway "$VM_GATEWAY"
      --hostname "remnux"
      --memory "0"
      --network-block-index 0
      --network-id "$NETWORK_ID"
      --pipeline "$PIPELINE"
      --portgroup "$VCENTER_PORTGROUP"
      --storage-disk-size "0"
      --vcenter-cluster "$VCENTER_CLUSTER"
      --vcenter-datacenter "$VCENTER_DATACENTER"
      --vcenter-ipaddress "$VCENTER_IPADDRESS"
      --vcenter-password "$VCENTER_PASSWORD"
      --vcenter-username "$VCENTER_USERNAME"
      --vm-datastore "$VCENTER_DATASTORE"
      --vm-folder "$VMWARE_FOLDER"
      --vm-name "REMnux"
      --vm-password "$DEFAULT_TEMPLATE_PASSWORD"
      --vm-template "$REMNUX_TEMPLATE_TO_CLONE"
    )
    echo "${args[@]}"
    python3 testing/pipeline/pipeline.py "${args[@]}"
  only:
    variables:
      - $PIPELINE == "export-remnux"
  artifacts:
    untracked: true

Create a standalone MinIO server:
  stage: build
  tags:
    - tfplenum-buildv2
  script: |
    args=(
      setup-minio
      --commit-hash "$CI_COMMIT_SHORT_SHA"
      --cpu $MINIO_CPU
      --disk-size "$MINIO_DISK_SIZE"
      --dns-servers $DNS_SERVERS
      --domain "$KIT_DOMAIN"
      --export-password "$OVA_EXPORT_PASSWORD"
      --gateway "$VM_GATEWAY"
      --hostname "minio"
      --memory $MINIO_MEMORY
      --network-block-index "$MINIO_NETWORK_BLOCK_INDEX"
      --network-id "$NETWORK_ID"
      --pipeline "$PIPELINE"
      --portgroup "$VCENTER_PORTGROUP"
      --storage-disk-size "$MINIO_STORAGE_SIZE"
      --vcenter-cluster "$VCENTER_CLUSTER"
      --vcenter-datacenter "$VCENTER_DATACENTER"
      --vcenter-ipaddress "$VCENTER_IPADDRESS"
      --vcenter-password "$VCENTER_PASSWORD"
      --vcenter-username "$VCENTER_USERNAME"
      --vm-datastore "$VCENTER_DATASTORE"
      --vm-folder "$VMWARE_FOLDER"
      --vm-name "$VM_PREFIX-minio.$KIT_DOMAIN"
      --vm-password "$DEFAULT_TEMPLATE_PASSWORD"
      --vm-template "$MINIO_TEMPLATE_TO_CLONE"
    )
    echo "${args[@]}"
    python3 testing/pipeline/pipeline.py "${args[@]}"
  only:
    variables:
      - $PIPELINE == "export-minio"
      - $PIPELINE == "export-all"
      - $PIPELINE == "export-gip"
      - $MINIO_VM == "yes" && $PIPELINE == "developer-all"
  artifacts:
    untracked: true
