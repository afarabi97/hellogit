---
Setup Hardware DIP Controller:
  stage: build
  tags:
    - tfplenum-buildv2
  script: |
    echo "Setup Baremetal DIP Controller"
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py \
    --system-name "DIP" \
    setup-baremetal-controller \
    --run-type "$BUILD_TYPE" \
    --esxi-ipaddress "$ESXI_IPADDRESS" \
    --esxi-username "$ESXI_USERNAME" \
    --esxi-password "$ESXI_PASSWORD" \
    --node-password "$DEFAULT_TEMPLATE_PASSWORD" \
    --vm-datastore "$ESXI_DATASTORE" \
    --ctrl-path "$DIP_CONTROLLER_PATH" \
    --ctrl-name "$CONTROLLER_OVA" \
    --template-path "$TEMPLATE_PATH" \
    --template "$TEMPLATE_OVA" \
    --gateway "$CONTROLLER_GATEWAY" \
    --ipaddress "$CONTROLLER_IPADDRESS" \
    --dns-servers $CONTROLLER_DNS_SERVERS \
    --repo-username "$REPO_USERNAME" \
    --repo-password "$REPO_PASSWORD" \
    --repo-url "$REPO_URL" \
    --branch-name "$CI_COMMIT_REF_NAME" \
    --domain "$KIT_DOMAIN" \
    --redfish-user "$REDFISH_USER" \
    --redfish-password "$REDFISH_PASSWORD" \
    --monitoring-interface "$MONITORING_INTERFACE"
  artifacts:
    untracked: true
  only:
    variables:
      - $PIPELINE == "hw-developer-dip"

Hardware DIP Kickstart:
  stage: kickstart
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py \
    --system-name "DIP" \
    run-kickstart \
    --node-password "$DEFAULT_VM_PASSWORD" \
    --vm-datastore "$ESXI_DATASTORE" \
    --ctrl-path "$DIP_CONTROLLER_PATH" \
    --ctrl-name "$CONTROLLER_OVA" \
    --template-path "$TEMPLATE_PATH" \
    --template "$DIP_TEMPLATE_OVA" \
    --gateway "$CONTROLLER_GATEWAY" \
    --ipaddress "$CONTROLLER_IPADDRESS" \
    --dns-servers $CONTROLLER_DNS_SERVERS \
    --server-oob $SERVER_OOB \
    --sensor-oob $SENSOR_OOB \
    --domain "$KIT_DOMAIN" \
    --redfish-user "$REDFISH_USER" \
    --redfish-password "$REDFISH_PASSWORD" \
    --upstream-dns "$UPSTREAM_DNS" \
    --upstream-ntp "$UPSTREAM_NTP" \
    --management-password "$MANAGEMENT_PASSWORD" \
    --mp-external-ip "$MP_EXTERNAL_IP" \
    --pfsense-ip "$PFSENSE_IP" \
    --switch-ip "$SWITCH_IP" \
    --monitoring-interface "$MONITORING_INTERFACE" \
    --run-remote-node "$RUN_REMOTE_NODE"
  artifacts:
    untracked: true
  retry: 2
  only:
    variables:
      - $PIPELINE == "hw-developer-dip"

Hardware DIP Kit:
  stage: kit
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-kit
  retry: 2
  artifacts:
    untracked: true
  only:
    variables:
      - $PIPELINE == "hw-developer-dip"

Remote Node Automation:
  stage: remote-node
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py \
    --system-name "DIP" run-remote-node
  only:
    variables:
      - $RUN_REMOTE_NODE == "yes" && $PIPELINE == "hw-developer-dip"

Hardware System Function Testing:
  stage: integration-test
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-integration-tests
  only:
    variables:
      - $RUN_INTEGRATION == "yes" && $PIPELINE == "hw-developer-dip"
  artifacts:
    paths:
      - "./*.xml"
    reports:
      junit: "./*.xml"

Hardware Simulate Power Failure:
  stage: test-powerfailure
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" simulate-power-failure
  only:
    variables:
      - $RUN_POWER_FAILURE == "yes" && $PIPELINE == "hw-developer-dip"

Hardware CVAH Catalog PMO Apps:
  stage: catalog
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog suricata
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog arkime-viewer
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog arkime-capture
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog zeek
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog logstash
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog wikijs
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog cortex
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog misp
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog hive
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog rocketchat
  only:
    variables:
      - $RUN_CATALOG == "yes" && $PIPELINE == "hw-developer-dip"

Hardware CVAH Catalog Community Apps:
  stage: catalog
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog mattermost
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog nifi
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog redmine
    python3 testing/pipeline/baremetal_pipeline.py --system-name "DIP" run-catalog netflow-filebeat
  only:
    variables:
      - $RUN_CATALOG == "yes" && $COMMUNITY_APPS == "yes" && $PIPELINE == "hw-developer-dip"

Verodin Automation:
  stage: verodin-test
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py \
    --system-name "DIP" run-verodin \
    --verodin-ipaddress "$VERODIN_IPADDRESS" \
    --verodin-username "$VERODIN_USERNAME" \
    --verodin-password "$VERODIN_PASSWORD" \
    --sequence-name "$SEQUENCE_NAME" \
    --num-of-actions $NUM_OF_ACTIONS \
    --run-action-sample "$ACTION_SAMPLE"
  retry: 2
  only:
    variables:
      - $RUN_CATALOG == "yes" && $RUN_VERODIN == "yes" && $PIPELINE == "hw-developer-dip"

BreakingPoint Automation:
  stage: breakingpoint-test
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/baremetal_pipeline.py \
    --system-name "DIP" run-bp \
    --bp-host $BREAKINGPOINT_IP \
    --bp-pass $BREAKINGPOINT_PASSWORD \
    --bp-test $BREAKINGPOINT_TEST_NAME
  only:
    variables:
      - $RUN_BREAKINGPOINT == "yes" && $PIPELINE == "hw-developer-dip"
      - $RUN_BREAKINGPOINT == "yes" && $PIPELINE == "hw-bp-test"
...
