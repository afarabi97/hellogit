Clear Staging Environment:
  stage: clean-staging-env
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    echo "Clear Staging Environment: $DRIVE_STAGING_FOLDER/"
    rm -fr "$DRIVE_STAGING_FOLDER/"
    mkdir -p "$DRIVE_STAGING_FOLDER/"
  retry: 2
  only:
    variables:
      - $PIPELINE == "export-docs"
      - $PIPELINE == "export-all"
      - $PIPELINE == "minor-release"

Clear GIP Staging Environment:
  stage: clean-staging-env
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    echo "Clear Staging Environment"
    rm -fr "$DRIVE_GIP_STAGING_FOLDER/"
    mkdir -p "$DRIVE_GIP_STAGING_FOLDER/"
  retry: 2
  only:
    variables:
      - $PIPELINE == "export-gip"

Hash Master GIP Drive:
  stage: hashfiles
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py run-export create-master-drive-hashes \
    --drive-type "GIP" \
    --drive-creation-version "$TFPLENUM_EXPORT_VERSION" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS" \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_GIP_DRIVE"
  only:
    variables:
      - $PIPELINE == "export-gip" && $CREATE_GIP_DRIVE == "yes"

Hash Check Master GIP Drive:
  stage: checkhash
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py run-export check-master-drive-hashes \
    --drive-type "GIP" \
    --drive-creation-version "$TFPLENUM_EXPORT_VERSION" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS" \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_GIP_DRIVE"
  only:
    variables:
      - $PIPELINE == "export-gip" && $CREATE_GIP_DRIVE == "yes"

Hash Master CPT Drive:
  stage: hashfiles
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py run-export create-master-drive-hashes \
    --drive-type "CPT" \
    --drive-creation-version "$TFPLENUM_EXPORT_VERSION" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS" \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_CPT_DRIVE"
  only:
    variables:
      - $PIPELINE == "export-all" && $CREATE_CPT_DRIVE == "yes"
      - $PIPELINE == "minor-release" && $CREATE_CPT_DRIVE == "yes"
      - $PIPELINE == "drive-only" && $CREATE_CPT_DRIVE == "yes" && $EXPORT_PERFORM_CHECKSUM == "yes"
      - $PIPELINE == "export-controller-only" && $CREATE_CPT_DRIVE == "yes"

Hash Master MDT Drive:
  stage: hashfiles
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py run-export create-master-drive-hashes \
    --drive-type "MDT" \
    --drive-creation-version "$TFPLENUM_EXPORT_VERSION" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS" \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_MDT_DRIVE"
  only:
    variables:
      - $PIPELINE == "export-all" && $CREATE_MDT_DRIVE == "yes"
      - $PIPELINE == "minor-release" && $CREATE_MDT_DRIVE == "yes"
      - $PIPELINE == "drive-only" && $CREATE_MDT_DRIVE == "yes" && $EXPORT_PERFORM_CHECKSUM == "yes"
      - $PIPELINE == "export-controller-only" && $CREATE_MDT_DRIVE == "yes"

Hash Check Master CPT Drive:
  stage: checkhash
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py run-export check-master-drive-hashes \
    --drive-type "CPT" \
    --drive-creation-version "$TFPLENUM_EXPORT_VERSION" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS" \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_CPT_DRIVE"
  only:
    variables:
      - $PIPELINE == "export-all" && $CREATE_CPT_DRIVE == "yes"
      - $PIPELINE == "minor-release" && $CREATE_CPT_DRIVE == "yes"
      - $PIPELINE == "drive-only" && $CREATE_CPT_DRIVE == "yes"
      - $PIPELINE == "export-controller-only" && $CREATE_CPT_DRIVE == "yes"

Hash Check Master MDT Drive:
  stage: checkhash
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py run-export check-master-drive-hashes \
    --drive-type "MDT" \
    --drive-creation-version "$TFPLENUM_EXPORT_VERSION" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS" \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_MDT_DRIVE"
  only:
    variables:
      - $PIPELINE == "export-all" && $CREATE_MDT_DRIVE == "yes"
      - $PIPELINE == "minor-release" && $CREATE_MDT_DRIVE == "yes"
      - $PIPELINE == "drive-only" && $CREATE_MDT_DRIVE == "yes"
      - $PIPELINE == "export-controller-only" && $CREATE_MDT_DRIVE == "yes"

Create Master CPT Drive:
  stage: publish
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py run-export create-master-drive \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_CPT_DRIVE" \
    --drive-type "CPT" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS" \
    --drive-creation-version "$TFPLENUM_EXPORT_VERSION" \
    --burn-multiboot $CREATE_MULTIBOOT
  only:
    variables:
      - $PIPELINE == "export-all" && $CREATE_CPT_DRIVE == "yes"
      - $PIPELINE == "minor-release" && $CREATE_CPT_DRIVE == "yes"
      - $PIPELINE == "drive-only" && $CREATE_CPT_DRIVE == "yes"
      - $PIPELINE == "export-controller-only" && $CREATE_CPT_DRIVE == "yes"

Create Master MDT Drive:
  stage: publish
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py run-export create-master-drive \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_MDT_DRIVE" \
    --drive-type "MDT" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS" \
    --drive-creation-version "$TFPLENUM_EXPORT_VERSION" \
    --burn-multiboot $CREATE_MULTIBOOT
  only:
    variables:
      - $PIPELINE == "export-all" && $CREATE_MDT_DRIVE == "yes"
      - $PIPELINE == "minor-release" && $CREATE_MDT_DRIVE == "yes"
      - $PIPELINE == "drive-only" && $CREATE_MDT_DRIVE == "yes"
      - $PIPELINE == "export-controller-only" && $CREATE_MDT_DRIVE == "yes"

Create Master GIP Drive:
  stage: publish
  tags:
    - tfplenum-buildv2
  script: |
    python3 testing/pipeline/pipeline.py run-export create-master-drive \
    --external-drive "$MASTER_DRIVE_CREATION_EXTERNAL_GIP_DRIVE" \
    --drive-type "GIP" \
    --username "$MASTER_DRIVE_CREATION_USERNAME" \
    --password "$MASTER_DRIVE_CREATION_PASSWORD" \
    --ipaddress "$MASTER_DRIVE_CREATION_IPADDRESS" \
    --drive-creation-version "$TFPLENUM_EXPORT_VERSION" \
    --burn-multiboot "no"
  only:
    variables:
      - $PIPELINE == "export-gip" && $CREATE_GIP_DRIVE == "yes"
