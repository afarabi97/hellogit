Test Reposync Server VM:
  stage: build
  timeout: 24 hours
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"

    python3 testing/pipeline/pipeline.py --system-name REPO test-server-repository-vm \
    --vcenter-ipaddress "$VCENTER_IPADDRESS" \
    --vcenter-username "$VCENTER_USERNAME" \
    --vcenter-password "$VCENTER_PASSWORD" \
    --vcenter-datacenter "$VCENTER_DATACENTER" \
    --vm-folder "$VMWARE_FOLDER" \
    --vm-password "$DEFAULT_TEMPLATE_PASSWORD" \
    --portgroup "$VCENTER_PORTGROUP" \
    --network-block-index $RHEL_NETWORK_BLOCK_INDEX \
    --gateway "$VM_GATEWAY" \
    --dns-servers $DNS_SERVERS \
    --vm-datastore "$VCENTER_DATASTORE" \
    --network-id "$NETWORK_ID" \
    --vm-prefix "$VM_PREFIX" \
    --disk-size "1100" \
    --vm-template "$REPO_SERVER_TEMPLATE_TO_CLONE" \
    --subscription "$RHEL_SUB_METHOD" \
    --orgnumber "$RHEL_ORGANIZATION" \
    --activationkey "$RHEL_ACTIVATIONKEY"
  only:
    variables:
      - $PIPELINE == "test-reposync-server"

Build Server Reposync VM for Export:
  stage: build
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"

    python3 testing/pipeline/pipeline.py --system-name REPO build-server-for-export \
    --vcenter-ipaddress "$VCENTER_IPADDRESS" \
    --vcenter-username "$VCENTER_USERNAME" \
    --vcenter-password "$VCENTER_PASSWORD" \
    --vcenter-datacenter "$VCENTER_DATACENTER" \
    --vm-folder "$VMWARE_FOLDER" \
    --vm-password "$DEFAULT_TEMPLATE_PASSWORD" \
    --portgroup "$VCENTER_PORTGROUP" \
    --network-block-index $RHEL_NETWORK_BLOCK_INDEX \
    --gateway "$VM_GATEWAY" \
    --dns-servers $DNS_SERVERS \
    --vm-datastore "$VCENTER_DATASTORE" \
    --network-id "$NETWORK_ID" \
    --vm-prefix "$VM_PREFIX" \
    --disk-size "$REPO_SERVER_DISK_SIZE" \
    --vm-template "$REPO_SERVER_TEMPLATE_TO_CLONE"
  retry: 2
  artifacts:
    untracked: true
  only:
    variables:
      - $PIPELINE == "export-reposync"
      - $PIPELINE == "export-all"

Perform Reposync Server STIGs:
  stage: stig-kit
  needs: ["Build Server Reposync VM for Export"]
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/pipeline.py --system-name "REPO" run-stigs --sub-system-name "SERVER"
  artifacts:
    untracked: true
  only:
    variables:
      - $RUN_STIGS == "yes" && $PIPELINE == "export-reposync"
      - $RUN_STIGS == "yes" && $PIPELINE == "export-all"
