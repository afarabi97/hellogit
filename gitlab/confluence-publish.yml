publish sonarqube results pipeline:
  tags:
    - tfplenum-buildv2
  stage: publish-to-confluence
  only:
    changes:
      - testing/pipeline/*
      - testing/pipeline/**/*
  except:
    - tags
    - schedules
  dependencies:
    - sonar-scan testing pipeline
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    PATH_PWD=$(pwd)
    echo "TASK [sonar-scanner: Gathering Sonar Scan Artifacts] ***************************"
    if [[ $PATH_PWD/testing/pipeline/testing-sonarlink.txt && $PATH_PWD/testing/pipeline/testing-scantime.txt ]]
      then
        export TFPLENUM_SONAR_SCAN_LINK="$(cut -d' ' -f10 $PATH_PWD/testing/pipeline/testing-sonarlink.txt)"
        export TFPLENUM_QUALITY_GATE_STATUS="$(cut -d' ' -f5 $PATH_PWD/testing/pipeline/testing-sonarlink.txt)"
        export TFPLENUM_TOTAL_SCAN_TIME="$(cut -d' ' -f5 $PATH_PWD/testing/pipeline/testing-scantime.txt)"
        docker run -e PATH_PWD=$PATH_PWD -e $TFPLENUM_SONAR_SCAN_LINK --rm --mount type=bind,source=$PATH_PWD/testing/pipeline/,target=$PATH_PWD/testing/pipeline/ $LATEST_CODE_CHECKER_IMAGE \
          google-chrome --no-sandbox --headless --hide-scrollbars --disable-gpu --screenshot=$PATH_PWD/testing/pipeline/tfplenum-screenshot-$CI_COMMIT_SHORT_SHA.png \
          --virtual-time-budget=9000000 --run-all-compositor-stages-before-draw --window-size=1440,900
        echo "TASK [sonar-scanner: Exporting Testing results to Confluence] ******************"
        python3 $PATH_PWD/testing/confluence-update-scripts/sonar-confluence.py -u $CONFLUENCE_USERNAME \
        -pw $CONFLUENCE_PASSWORD -b $CI_COMMIT_REF_NAME -l $TFPLENUM_SONAR_SCAN_LINK -gs $TFPLENUM_QUALITY_GATE_STATUS \
        -tt $TFPLENUM_TOTAL_SCAN_TIME -pk "tfplenum-test" -ss $PATH_PWD/testing/pipeline/tfplenum-screenshot-$CI_COMMIT_SHORT_SHA.png
      else
        echo "sonar-scan files for backend-end not passed correctly"
    fi
  allow_failure: true

publish sonarqube results back-end:
  tags:
    - tfplenum-buildv2
  stage: publish-to-confluence
  only:
    changes:
      - web/backend/*
      - web/backend/**/*
  except:
    - tags
    - schedules
  dependencies:
    - sonar-scan back-end code base
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    PATH_PWD=$(pwd)
    echo "TASK [sonar-scanner: Gathering Sonar Scan Artifacts] ***************************"
    if [[ $PATH_PWD/web/backend/backend-sonarlink.txt && $PATH_PWD/web/backend/backend-scantime.txt ]]
      then
        export TFPLENUM_BACKEND_SONAR_SCAN_LINK="$(cut -d ' ' -f10 $PATH_PWD/web/backend/backend-sonarlink.txt)"
        export TFPLENUM_BACKEND_QUALITY_GATE_STATUS="$(cut -d ' ' -f5 $PATH_PWD/web/backend/backend-sonarlink.txt)"
        export TFPLENUM_BACKEND_TOTAL_SCAN_TIME="$(cut -d ' ' -f5 $PATH_PWD/web/backend/backend-scantime.txt)"
        docker run -e PATH_PWD=$PATH_PWD -e $TFPLENUM_BACKEND_SONAR_SCAN_LINK --rm --mount type=bind,source=$PATH_PWD/web/backend/,target=$PATH_PWD/web/backend/ $LATEST_CODE_CHECKER_IMAGE \
          google-chrome --no-sandbox --headless --hide-scrollbars --disable-gpu --screenshot=$PATH_PWD/web/backend/backend-screenshot-$CI_COMMIT_SHORT_SHA.png \
          --virtual-time-budget=9000000 --run-all-compositor-stages-before-draw --window-size=1440,900
        echo "TASK [sonar-scanner: Exporting Testing results to Confluence] ******************"
        python3 $PATH_PWD/testing/confluence-update-scripts/sonar-confluence.py -u $CONFLUENCE_USERNAME \
        -pw $CONFLUENCE_PASSWORD -b $CI_COMMIT_REF_NAME -l $TFPLENUM_BACKEND_SONAR_SCAN_LINK -gs $TFPLENUM_BACKEND_QUALITY_GATE_STATUS \
        -tt $TFPLENUM_BACKEND_TOTAL_SCAN_TIME -pk "tfplenum-backend" -ss $PATH_PWD/web/backend/backend-screenshot-$CI_COMMIT_SHORT_SHA.png
      else
        echo "sonar-scan files for backend-end not passed correctly"
    fi
  allow_failure: true

publish sonarqube results front-end:
  tags:
    - tfplenum-buildv2
  stage: publish-to-confluence
  only:
    changes:
      - web/frontend/*
      - web/frontend/**/*
  except:
    - tags
    - schedules
  dependencies:
    - sonar-scan front-end code base
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    PATH_PWD=$(pwd)
    echo "TASK [sonar-scanner: Gathering Sonar Scan Artifacts] ***************************"
    if [[ $PATH_PWD/web/frontend/frontend-sonarlink.txt && $PATH_PWD/web/frontend/frontend-scantime.txt ]]
      then
        export TFPLENUM_FRONTEND_SONAR_SCAN_LINK="$(cut -d ' ' -f10 $PATH_PWD/web/frontend/frontend-sonarlink.txt)"
        export TFPLENUM_FRONTEND_QUALITY_GATE_STATUS="$(cut -d ' ' -f5 $PATH_PWD/web/frontend/frontend-sonarlink.txt)"
        export TFPLENUM_FRONTEND_TOTAL_SCAN_TIME="$(cut -d ' ' -f5 $PATH_PWD/web/frontend/frontend-scantime.txt)"
        docker run -e PATH_PWD=$PATH_PWD -e $TFPLENUM_FRONTEND_SONAR_SCAN_LINK --rm --mount type=bind,source=$PATH_PWD/web/frontend/,target=$PATH_PWD/web/frontend/ $LATEST_CODE_CHECKER_IMAGE \
          google-chrome --no-sandbox --headless --hide-scrollbars --disable-gpu --screenshot=$PATH_PWD/web/frontend/frontend-screenshot-$CI_COMMIT_SHORT_SHA.png \
          --virtual-time-budget=9000000 --run-all-compositor-stages-before-draw --window-size=1440,900
        echo "TASK [sonar-scanner: Exporting Testing results to Confluence] ******************"
        python3 $PATH_PWD/testing/confluence-update-scripts/sonar-confluence.py -u $CONFLUENCE_USERNAME \
        -pw $CONFLUENCE_PASSWORD -b $CI_COMMIT_REF_NAME -l $TFPLENUM_FRONTEND_SONAR_SCAN_LINK -gs $TFPLENUM_FRONTEND_QUALITY_GATE_STATUS \
        -tt $TFPLENUM_FRONTEND_TOTAL_SCAN_TIME -pk "tfplenum-frontend" -ss $PATH_PWD/web/frontend/frontend-screenshot-$CI_COMMIT_SHORT_SHA.png
      else
        echo "sonar-scan files for front-end not passed correctly"
    fi
  allow_failure: true
