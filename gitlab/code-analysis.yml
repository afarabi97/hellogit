analyze ansible test playbooks:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    ansible-lint testing/playbooks/site.yml
  allow_failure: true
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-mip"

analyze ansible bootstrap playbooks:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    ansible-lint bootstrap/playbooks/site.yml
  allow_failure: true
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-mip"

analyze ansible core playbooks:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    ansible-lint core/playbooks/site.yml
    ansible-lint core/playbooks/remove-node.yml
  allow_failure: true
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"

analyze ansible deployer playbooks:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    ansible-lint deployer/playbooks/site.yml
  allow_failure: true
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"

analyze ansible stigs playbooks:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    ansible-lint stigs/playbooks/site.yml
  allow_failure: true
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"

analyze ansible mip playbooks:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    ansible-lint mip/mip-core/site.yml
    ansible-lint mip/mip-deployer/site.yml
  allow_failure: true
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-mip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"

compile front-end:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    docker run --rm -v $(pwd):/opt/tfplenum nexus.sil.lab/tfplenum/code-checker:1.1 /opt/tfplenum/web/setup/compile_frontend.sh
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-mip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"

environment setup backend:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    docker run --rm -v $(pwd):/opt/tfplenum nexus.sil.lab/tfplenum/code-checker:1.1 /opt/tfplenum/web/setup/setup_backend.sh
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-mip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"

sonarqube front-end code base:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    PATH_PWD=$(pwd)
    echo "TASK [setup: front-end] ********************************************************"
    docker run --rm -v $(pwd):/opt/tfplenum nexus.sil.lab/tfplenum/code-checker:1.1 /opt/tfplenum/web/setup/setup_frontend.sh
    echo "TASK [unit-test / coverage: front-end] *****************************************"
    docker run --rm --mount type=bind,source="$(pwd)",target=$PATH_PWD nexus.sil.lab/tfplenum/code-checker:1.1 $PATH_PWD/web/setup/eslint_test_coverage_frontend.sh
    echo "TASK [sonar-scanner: code-base ingestion] **************************************"
    sonar-scanner\
      -Dsonar.qualitygate.wait=true\
      -Dsonar.eslint.reportPaths=$PATH_PWD/web/frontend/report.json\
      -Dsonar.javascript.lcov.reportPaths=$PATH_PWD/web/frontend/test-coverage/lcov.info\
      -Dsonar.typescript.tsconfigPath=$PATH_PWD/web/frontend/src/tsconfig.app.json\
      -Dsonar.projectKey=tfplenum-frontend\
      -Dsonar.sources=web/frontend/src/app/> >(tee $PATH_PWD/web/frontend/sonar-report.txt) 2> >(tee $PATH_PWD/web/frontend/sonar-report.txt >&2)
    echo "TASK [sonar-scanner: Gathering Sonar Scan Artifacts] **************************"
    cat $PATH_PWD/web/frontend/sonar-report.txt | grep QUALITY >> $PATH_PWD/web/frontend/frontend-sonarlink.txt
    cat $PATH_PWD/web/frontend/sonar-report.txt | grep -i "total time" >> $PATH_PWD/web/frontend/frontend-scantime.txt
    export TFPLENUM_FRONTEND_SONAR_SCAN_LINK="$(cut -d ' ' -f10 $PATH_PWD/web/frontend/frontend-sonarlink.txt)"
    docker run -e PATH_PWD=$PATH_PWD --rm --mount type=bind,source=$PATH_PWD/web/frontend/,target=$PATH_PWD/web/frontend/ tfplenum/code-checker:1.1 \
      google-chrome --no-sandbox --headless --hide-scrollbars --disable-gpu --screenshot=$PATH_PWD/web/frontend/frontend-screenshot-$CI_COMMIT_SHORT_SHA.png -e $TFPLENUM_FRONTEND_SONAR_SCAN_LINK \
      --virtual-time-budget=9000000  --run-all-compositor-stages-before-draw --window-size=1440,900
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-mip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"
  artifacts:
    paths:
      - web/frontend/frontend-sonarlink.txt
      - web/frontend/frontend-scantime.txt
      - web/frontend/*.png
    expire_in: 12h
  allow_failure: true


sonarqube back-end code base:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    PATH_PWD=$(pwd)
    echo "TASK [pylint / pytest-cov: back-end] *******************************************"
    docker run -e PATH_PWD=$PATH_PWD --rm --mount type=bind,source="$(pwd)",target=$PATH_PWD nexus.sil.lab/tfplenum/code-checker:1.1 $PATH_PWD/web/setup/pylint_pytest_backend.sh
    echo "TASK [sonar-scanner: code-base ingestion] **************************************"
    sonar-scanner\
      -Dsonar.qualitygate.wait=true\
      -Dsonar.python.pylint.reportPath=$PATH_PWD/web/backend/pylint-backend.txt\
      -Dsonar.projectKey=tfplenum-backend\
      -Dsonar.sources=web/backend/> >(tee $PATH_PWD/web/backend/sonar-report.txt) 2> >(tee $PATH_PWD/web/backend/sonar-report.txt >&2)
    echo "TASK [sonar-scanner: Gathering Sonar Scan Artifacts] **************************"
    cat $PATH_PWD/web/backend/sonar-report.txt | grep QUALITY >> $PATH_PWD/web/backend/backend-sonarlink.txt
    cat $PATH_PWD/web/backend/sonar-report.txt | grep -i "total time" >> $PATH_PWD/web/backend/backend-scantime.txt
    export TFPLENUM_BACKEND_SONAR_SCAN_LINK="$(cut -d ' ' -f10 $PATH_PWD/web/backend/backend-sonarlink.txt)"
    docker run -e PATH_PWD=$PATH_PWD --rm --mount type=bind,source=$PATH_PWD/web/backend/,target=$PATH_PWD/web/backend/ tfplenum/code-checker:1.1 \
      google-chrome --no-sandbox --headless --hide-scrollbars --disable-gpu --screenshot=$PATH_PWD/web/backend/backend-screenshot-$CI_COMMIT_SHORT_SHA.png -e $TFPLENUM_BACKEND_SONAR_SCAN_LINK \
      --virtual-time-budget=9000000  --run-all-compositor-stages-before-draw --window-size=1440,900
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-mip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"
  artifacts:
    paths:
      - web/backend/backend-sonarlink.txt
      - web/backend/backend-scantime.txt
      - web/backend/*.png
    expire_in: 12h


sonarqube testing pipeline:
  tags:
    - tfplenum-buildv2
  stage: code-analysis
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    PATH_PWD=$(pwd)
    echo "TASK [pylint: pipeline] ********************************************************"
    docker run -e PATH_PWD=$PATH_PWD --rm --mount type=bind,source="$(pwd)",target=$PATH_PWD nexus.sil.lab/tfplenum/code-checker:1.1 $PATH_PWD/testing/pipeline/pylint_pipeline.sh
    echo "TASK [sonar-scanner: pipeline ingestion] ***************************************"
    sonar-scanner\
      -Dsonar.qualitygate.wait=true\
      -Dsonar.python.pylint.reportPath=$PATH_PWD/testing/pipeline/pylint-pipeline.txt\
      -Dsonar.projectKey=tfplenum-test\
      -Dsonar.sources=testing/pipeline/> >(tee $PATH_PWD/testing/pipeline/sonar-report.txt) 2> >(tee $PATH_PWD/testing/pipeline/sonar-report.txt >&2)
    echo "TASK [sonar-scanner: Gathering Sonar Scan Artifacts] **************************"
    cat $PATH_PWD/testing/pipeline/sonar-report.txt | grep QUALITY >> $PATH_PWD/testing/pipeline/testing-sonarlink.txt
    cat $PATH_PWD/testing/pipeline/sonar-report.txt | grep -i "total time" >> $PATH_PWD/testing/pipeline/testing-scantime.txt
    export TFPLENUM_SONAR_SCAN_LINK="$(cut -d' ' -f10 $PATH_PWD/testing/pipeline/testing-sonarlink.txt)"
    docker run -e PATH_PWD=$PATH_PWD --rm --mount type=bind,source=$PATH_PWD/testing/pipeline/,target=$PATH_PWD/testing/pipeline/ tfplenum/code-checker:1.1 \
      google-chrome --no-sandbox --headless --hide-scrollbars --disable-gpu --screenshot=$PATH_PWD/testing/pipeline/tfplenum-screenshot-$CI_COMMIT_SHORT_SHA.png -e $TFPLENUM_SONAR_SCAN_LINK \
      --virtual-time-budget=9000000  --run-all-compositor-stages-before-draw --window-size=1440,900
  only:
    variables:
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "static_analysis_only"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-mip"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-all"
      - $RUN_CODE_CHECKS == "yes" && $PIPELINE == "developer-dip-mip"
  artifacts:
    paths:
      - testing/pipeline/testing-sonarlink.txt
      - testing/pipeline/testing-scantime.txt
      - testing/pipeline/*.png
    expire_in: 12h
