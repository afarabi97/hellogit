Setup GIP Services VM:
  stage: build
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    echo "VM_PREFIX is $VM_PREFIX"

    echo "Zipping up services Ansible code."
    zip -r playbooks.zip gip/services/

    python3 testing/pipeline/pipeline.py \
    --system-name "GIP" \
    gip-setup create-gip-service-vm \
    --vcenter-ipaddress "$VCENTER_IPADDRESS" \
    --vcenter-datacenter "$VCENTER_DATACENTER" \
    --vcenter-username "$VCENTER_USERNAME" \
    --vcenter-password "$VCENTER_PASSWORD" \
    --vm-folder "$VMWARE_FOLDER" \
    --vm-password "$DEFAULT_TEMPLATE_PASSWORD" \
    --portgroup "$VCENTER_PORTGROUP" \
    --gateway "$VM_GATEWAY" \
    --dns-servers $DNS_SERVERS \
    --vm-datastore "$VCENTER_DATASTORE" \
    --network-id "$NETWORK_ID" \
    --vm-prefix "$VM_PREFIX-gip" \
    --network-block-index $GIP_SERVICES_NETWORK_BLOCK_INDEX \
    --vm-template "$GIP_SVC_TEMPLATE_TO_CLONE"
  artifacts:
    untracked: true
  only:
    variables:
      - $PIPELINE == "developer-gip-service"
      - $PIPELINE == "export-gip-service"

Perform GIP Servives STIGs:
  stage: stig-kit
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/pipeline.py --system-name "GIP" run-stigs \
    --sub-system-name "SERVICES"
  only:
    variables:
      - $PIPELINE == "developer-gip-service" && $RUN_GIPSVC_STIGS == "yes"


GIP Create Nightly:
  stage: publish-nightly
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/pipeline.py --system-name "GIP" run-publish-nightly --nightly-prefix "$NIGHTLY_PREFIX"
  only:
    variables:
      - $CREATE_NIGHTLY == "yes" && $PIPELINE == "developer-gip"
      - $CREATE_NIGHTLY == "yes" && $PIPELINE == "developer-all"


GIP Cleanup:
  stage: cleanup
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/pipeline.py --system-name "GIP" run-cleanup
  only:
    variables:
      - $IS_CLEANUP == "yes" && $PIPELINE == "developer-gip"
      - $IS_CLEANUP == "yes" && $PIPELINE == "export-gip-service"
      - $IS_CLEANUP == "yes" && $PIPELINE == "export-gip"


Setup GIP Controller:
  stage: build
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    echo "tfplenum-gip-cache-${CI_PIPELINE_ID}"
    echo "VM_PREFIX is $VM_PREFIX"
    python3 testing/pipeline/pipeline.py \
    --system-name "GIP" \
    setup-controller \
    --vcenter-ipaddress "$VCENTER_IPADDRESS" \
    --vcenter-username "$VCENTER_USERNAME" \
    --vcenter-password "$VCENTER_PASSWORD" \
    --vcenter-datacenter "$VCENTER_DATACENTER" \
    --repo-username "$REPO_USERNAME" \
    --repo-password "$REPO_PASSWORD" \
    --repo-url "$REPO_URL" \
    --portgroup "$VCENTER_PORTGROUP" \
    --network-id "$NETWORK_ID" \
    --network-block-index $GIP_NETWORK_BLOCK_INDEX \
    --dns-servers $DNS_SERVERS \
    --vm-folder "$VMWARE_FOLDER" \
    --vm-password "$DEFAULT_TEMPLATE_PASSWORD" \
    --vm-template "$GIP_TEMPLATE_TO_CLONE" \
    --gateway "$VM_GATEWAY" \
    --vm-prefix "$VM_PREFIX-gip" \
    --domain "$KIT_DOMAIN" \
    --branch-name "$CI_COMMIT_REF_NAME" \
    --run-type "$BUILD_TYPE" \
    --vm-datastore "$VCENTER_DATASTORE"
  artifacts:
    untracked: true
  only:
    variables:
      - $PIPELINE == "nightly_build"
      - $PIPELINE == "developer-gip"

GIP Kickstart:
  stage: kickstart
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    echo "VM_PREFIX is $VM_PREFIX"
    python3 testing/pipeline/pipeline.py \
    --system-name "GIP" \
    gip-setup run-gip-kickstart \
    --vcenter-ipaddress "$VCENTER_IPADDRESS" \
    --vcenter-username "$VCENTER_USERNAME" \
    --vcenter-password "$VCENTER_PASSWORD" \
    --vcenter-datacenter "$VCENTER_DATACENTER" \
    --portgroup "$VCENTER_PORTGROUP" \
    --network-id "$NETWORK_ID" \
    --network-block-index $GIP_NETWORK_BLOCK_INDEX \
    --dns-servers $DNS_SERVERS \
    --vm-folder "$VMWARE_FOLDER" \
    --vm-password "$DEFAULT_VM_PASSWORD" \
    --vm-prefix "$VM_PREFIX-gip" \
    --domain "$KIT_DOMAIN" \
    --gateway "$VM_GATEWAY" \
    --num-servers $GIP_NUM_SERVERS \
    --server-cpu $GIP_SERVER_CPU \
    --server-mem $GIP_SERVER_MEM \
    --vm-datastore "$VCENTER_DATASTORE"
  artifacts:
    untracked: true
  retry: 2
  only:
    variables:
      - $PIPELINE == "developer-gip"

GIP Kit:
  stage: kit
  tags:
    - tfplenum-buildv2
  script: |
    echo "IP of runner is $(hostname -I | cut -d " " -f1)"
    echo "Current working directory is $(pwd)"
    python3 testing/pipeline/pipeline.py --system-name "GIP" gip-setup run-gip-kit
  artifacts:
    untracked: true
  only:
    variables:
      - $PIPELINE == "developer-gip"
