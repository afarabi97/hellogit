---
- name: Import tfplenum variables
  include_vars:
    file: "{{ mip_core_vars }}"

- name: "remove tfplenum repo directory"
  file:
    path: "{{ tfplenum_repo_dir }}"
    state: absent
  with_items:
    - "{{ tfplenum_repo_dir }}"
    - "/tmp/var/"

- name: "Create tfplenum repo directory"
  file:
    path: "{{ tfplenum_repo_dir }}/Packages"
    state: directory
    recurse: yes

- name: Add local iso repo
  yum_repository:
    description: "RedHat ISO Repo"
    enabled: "true"
    file: local
    baseurl: "file:///mnt/"
    name: "local_rhel_7"
    gpgcheck: true
    gpgkey: "file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release"

- name: Download Main Packages
  shell: |
    yumdownloader --installroot=/tmp/ --releasever=/ --destdir={{ tfplenum_repo_dir }}/Packages --resolve --archlist=x86_64 {{ packages | join(' ') }}

- name: Download CPT packages
  shell: |
    yumdownloader --installroot=/tmp/ --releasever=/ --destdir={{ tfplenum_repo_dir }}/Packages --resolve --archlist=x86_64 {{ cpt_packages | join(' ') }}

- name: Download dependent packages
  shell: |
    yumdownloader --installroot=/tmp/ --releasever=/ --destdir={{ tfplenum_repo_dir }}/Packages --resolve --archlist=x86_64 {{ dependent_packages | join(' ') }}

- name: Get packages from RedHat
  shell: |
    repoquery --repoid=local_rhel_7 --qf=%{name} -g --list --grouppkgs=all "{{ item }}" | xargs yumdownloader --enablerepo=local_rhel_7 --installroot=/tmp/ --releasever=/ --destdir={{ tfplenum_repo_dir }}/Packages --resolve  --archlist=x86_64
  with_items: "{{ group_packages }}"

- name: Remove local iso repo
  yum_repository:
    name: local_rhel_7
    state: absent

- name: Remove Repodata
  file:
    path: "{{ tfplenum_repo_dir }}/repodata"
    state: absent

- name: get comp xml name
  shell: |
    find "{{ mnt_pth }}/repodata" -type f -iname "*comps*.xml"
  register: comps_result

- name: Validate if comps.xml exists
  stat:
    path: "{{ comps_result.stdout }}"
  register: comps_file

- name: copy comps xml to offline repo
  copy:
    src: "{{ comps_file.stat.path }}"
    dest: "{{ tfplenum_repo_dir }}/comps.xml"
  when: comps_file.stat.exists

- name: create repodata
  shell: "createrepo -g {{ tfplenum_repo_dir }}/comps.xml {{ tfplenum_repo_dir }}"

- name: get list of directories with wrong permissions
  shell: |
    # change all directories permissions that are not 755 to 755
    find {{ web_root}} -type d -not -perm 755 -exec chmod 755 {} \;
  register: dir_list

- name: fix files with wrong permissions
  shell: |
    find {{ web_root}} -type f -not -perm 644 -exec chmod 644 {} \;
  register: file_list

- name: restorecon for web server
  shell: |
    restorecon -Rv {{ web_root }}

- name: Remove unnecessary media from system
  shell: |
    umount -f {{ mnt_pth }}
...
