---
- name: Check for secure boot
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  tasks:
    - name: Check if secure boot is enabled
      shell: |
        mokutil --sb-state
      register: secure_boot_result
      changed_when: no
      ignore_errors: yes

    - name: Secure Boot Error
      fail:
        msg: "Unable to continue please disable secure boot in the bios settings"
      when: secure_boot_result is defined and secure_boot_result.stdout == "SecureBoot enabled"
      changed_when: False
  tags:
    - always
    - pre
    - MDT
    - CPT

- name: Clean up known hosts
  hosts: localhost
  gather_facts: no
  any_errors_fatal: true
  roles:
    - pre_installation_tasks
  tags:
    - pre
    - MDT
    - CPT

- name: Adding offline repos
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 002_adding-repos
  tags:
    - repos
    - MDT
    - CPT

- name: Install and download packages for MDT and CPT
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 003_main_packages
  tags:
    - packages_everyone
    - MDT
    - CPT

- name: Install and download packages for CPT only
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 004_CPT_packages
  tags:
    - packages_CPT
    - CPT

- name: Version lock kernel, kernel headers, kernel-devel
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 005_versionlock
  tags:
    - versionlock
    - CPT
    - MDT

- name: Adding Users
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 020_adding-users
  tags:
    - users
    - MDT
    - CPT

- name: CVAH folder
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 021_CVAH_copy
  tags:
    - cvah_folder

- name: Copy over the scripts used by the MIP
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 022_mip_scripts
  tags:
    - scripts
    - MDT
    - CPT

- name: CPT release file and notes
  hosts:
    - mips
    - localhost
  gather_facts: yes
  any_errors_fatal: true
  roles:
    - 023_CPT_release
  tags:
    - CPT_release
    - CPT

- name: MDT release file and notes
  hosts:
    - mips
  gather_facts: yes
  any_errors_fatal: true
  roles:
    - 024_MDT_release
  tags:
    - MDT_release
    - MDT

- name: Changing firewall settings
  hosts: mips
  gather_facts: yes
  any_errors_fatal: true
  roles:
    - 027_mip_firewall-config
  tags:
    - firewall
    - MDT
    - CPT

- name: Grub Configuration
  hosts: mips
  gather_facts: yes
  any_errors_fatal: true
  roles:
    - 034_mip_grub-configuration
  tags:
    - grub
    - MDT
    - CPT

- name: MIP Login Settings
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 041_mip_login-env
  tags:
    - login
    - MDT
    - CPT

- name: Classification banner setup
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 042_mip_classification_banner
  tags:
    - banner
    - MDT
    - CPT

- name: Add 2fa folder and files to desktop
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 045_2fa
  tags:
    - 2fa
    - MDT
    - CPT

- name: Install COTS software for MDT and CPT
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 102_vmware
    - 103_chrome
    - 104_vscode
    - 105_gitkraken
  tags:
    - COTS
    - MDT
    - CPT

- name: Install third party software CPT only
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 106_burpsuite
    - 107_nexpose
  tags:
    - third_party_CPT
    - CPT

# - name: Configure SSH
#   hosts:
#     - localhost
#     - mips
#   gather_facts: yes
#   any_errors_fatal: true
#   roles:
#     - 028_SSH
#   tags:
#     - MDT
#     - CPT
#     - 028-SSH

# - name: Host config
#   hosts:
#     - localhost
#     - mips
#   gather_facts: yes
#   any_errors_fatal: true
#   roles:
#     - 029_hosts
#   tags:
#     - 029-hosts
#     - MDT
#     - CPT

- name: Common STIG remediations
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - 901_common_STIG-remediation
  tags:
    - stigs
    - MDT
    - CPT

- name: Starting Post Installation tasks
  hosts: mips
  gather_facts: no
  any_errors_fatal: true
  roles:
    - post_installation_tasks
  tags:
    - post
    - MDT
    - CPT
