#version=RHEL8
# Determine what drives to use based on inventory file
{% if item is defined %}{% set boot_drive = hostvars[item].boot_drive %}{% else %}{% set boot_drive = default_boot_drive %}{% endif %}

{% if item is defined %}
{% set root_partition = hostvars[item].root_partition %}
{% else %}
{% set root_partition = default_root_partition %}
{% endif %}

# System authorization information

# Use CDROM installation media
url --url=http://{{ server_ip }}/offlinerepo/tfplenum

# Don't use graphical install
text

# Run the Setup Agent on first boot
firstboot --disable

# Keyboard layouts
keyboard --vckeymap=us

# System language
lang en_US.UTF-8
eula --agreed

# Network information
{% if item is defined %}
network --device={{ hostvars[item].mac | lower }} --bootproto=static --ip={{ hostvars[item].ip }} --netmask={{ netmask }} --gateway={{ gateway }} --nameserver={{ dns }} --noipv6 --activate
network  --hostname={{ item }}
{% else %}
network  --bootproto=dhcp --device=eth0 --noipv6 --activate
network  --hostname=localhost.localdomain
{% endif %}


# Root password  #
rootpw {{ root_password }}

# System services
services --disabled=abrtd,bluetooth,atd,avahi-daemon,rhnsd,ntpd,ModemManager

# System timezone
timezone America/Chicago

# X Window System configuration information
xconfig  --startxonboot

# System bootloader configuration
bootloader --location=mbr --boot-drive={{ boot_drive }} --password=default

# Partition clearing information
zerombr
clearpart --all --initlabel --drives={{ boot_drive }}

# Disk partitioning information
part /boot/efi --fstype="vfat" --ondisk={{ boot_drive }} --size=200
part /boot --fstype="xfs" --ondisk={{ boot_drive }} --size=1024
part pv.238 --fstype="lvmpv" --ondisk={{ boot_drive }} --size=100 --grow --encrypted --passphrase={{ luks_password }}
volgroup rhel --pesize=4096 pv.238
logvol /  --fstype="xfs" --size=1 --name=root --vgname=rhel --grow

# Secure boot disable
zipl --no-secure-boot

%packages
@workstation
@base
# @compat-libraries
@core
@desktop-debugging
@dial-up
# @directory-client
@fonts
@gnome-apps
@gnome-desktop
@guest-desktop-agents
@input-methods
@internet-browser
@java-platform
@multimedia
@network-file-system-client
@networkmanager-submodules
@office-suite
@print-client
@security-tools
@smart-card
# @x11

%end

%addon com_redhat_kdump --disable

%end

%post --log=/tmp/kick.log

# create a temp password file for LUKS
echo -n "blah" > /etc/mypasswdfile

# Make LUKs use the password file for passphrase
sed -i -e 's:none:/etc/mypasswdfile:' /etc/crypttab

# add my password file as a valid key for the luks device
echo {{ luks_password }} | cryptsetup luksAddKey /dev/{{ boot_drive }}{{ root_partition }} /etc/mypasswdfile

# configure dracut to add the following 2 items to the initramfs (so accessible at boot)
echo 'install_items="/etc/mypasswdfile /etc/crypttab"' > /etc/dracut.conf.d/99-mypwfile.conf

# Default boot to graphical runlevel
systemctl set-default graphical.target

# instruct dracut to apply the configuration
dracut -f

%end

%anaconda
pwpolicy root --minlen=14 --minquality=1 --strict --nochanges --notempty
pwpolicy user --minlen=14 --minquality=1 --strict --nochanges --notempty
pwpolicy luks --minlen=14 --minquality=1 --strict --nochanges --notempty

%end

reboot
