---
- name: "{{ ansible_distribution }} block"
  block:
    - name: Make default uefi {{ ansible_distribution }} {{ kick_cfg }} avail
      template:
        src: mip.cfg.j2
        dest: "{{ ks_template_dir }}/uefi/mip.cfg"
        owner: root
        group: root
        mode: 0644
        setype: httpd_sys_content_t
      vars:
        uefi: true

    - name: Create {{ ansible_distribution }} uefi ks for each server
      template:
        src: "mip.cfg.j2"
        dest: "{{ ks_template_dir }}/uefi/{{ item }}.cfg"
        owner: root
        group: root
        mode: 0644
        setype: httpd_sys_content_t
      with_items:
      - "{{ groups['mips'] }}"
      when: hostvars[item].pxe_type == 'uefi'
      vars:
        uefi: true

    - name: UEFI {{ ansible_distribution }} PXE Menus
      template:
        src: "grub.cfg.j2"
        dest: "{{ tftp_dir }}/uefi/grub.cfg"
        owner: root
        group: root
        mode: 0644
        setype: "cobbler_var_lib_t"
      register: tftp

    - name: Create {{ ansible_distribution }} uefi pxe menu for each server
      template:
        src: "grub.cfg.j2"
        # This takes the mac address from the inventory file for each node.
        # Replaces the colon with a dash and makes it lower case
        dest: "{{ tftp_dir }}/uefi/grub.cfg-01-{{ hostvars[item].mac | regex_replace(':', '-') | lower }}"
        owner: root
        group: root
        mode: 0644
        setype: "cobbler_var_lib_t"
      register: tftp
      with_items:
      - "{{ groups['mips'] }}"
      when: hostvars[item].pxe_type == 'uefi'
...
