---
- name: Copying 2fa folder to Desktop
  copy:
    src: '{{ mip_scripts_dir }}/2fa'
    dest: /home/assessor/Desktop/
    owner: root
    group: root
    mode: '0755'

- name: Copy the 2fa certs
  get_url:
    url: "http://controller.{{ kit_domain }}/MIP/{{ item }}"
    dest: /home/assessor/Desktop/2fa
    owner: root
    group: root
    mode: '0755'
  with_items:
    - 2fa_certs/NMIL_Cert_DoD_Root_CA_3.der.p7b
    - 2fa_certs/NMIL_Cert_DoD_Root_CA_3.der.p7b.pem
    - 2fa_certs/SMIL_checkedbase64.zip

- name: Copying 2fa image to Desktop
  get_url:
    url: "http://controller.{{ kit_domain }}/MIP/MIP_Images/2fa/tcl/2famapper.png"
    dest: /home/assessor/Desktop/2fa/tcl
    owner: root
    group: root
    mode: '0755'

- name: Configure PAM to use sssd
  shell: authselect select sssd with-smartcard with-smartcard-lock-on-removal --force

- name: Apply sssd changes
  shell: authselect apply-changes

- name: Run ans_2fa_rhel8_configure script
  shell: ./ans_2fa_rhel8_configure NMIL
  args:
    chdir: /home/assessor/Desktop/2fa/

- name: Copy 2famapper.wish to /usr/local/bin & set permissions
  copy:
    src: /home/assessor/Desktop/2fa/tcl/2famapper.wish
    dest: /usr/local/bin
    mode: '0755'
    remote_src: yes

- name: Copy 2famapper.desktop to /usr/share/applications
  copy:
    src: /home/assessor/Desktop/2fa/tcl/2famapper.desktop
    dest: /usr/share/applications
    remote_src: yes

- name: Copy 2famapper.desktop to /usr/share/applications
  copy:
    src: /home/assessor/Desktop/2fa/tcl/2famapper.png
    dest: /usr/share/icons/hicolor/512x512/apps
    remote_src: yes

- name: Create hidden file for validation if playbooks crash
  file:
    path: /operator/.DO_NOT_DELETE/.045
    state: touch
...
