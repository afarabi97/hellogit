---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-pipeline
  annotations:
    "helm.sh/hook": "pre-install"
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": "before-hook-creation"
data:
  beats.conf: |
    input {
      beats {
        port => 5045
        ssl => true
        ssl_certificate_authorities => ["/etc/ssl/certs/container/ca.crt"]
        ssl_certificate => '/etc/ssl/certs/container/tls.crt'
        ssl_key => '/etc/ssl/certs/container/tls.key'
        ssl_verify_mode => "peer"
      }
    }

    filter {
      mutate { add_field => { "[@metadata][index]" => "%{[@mymetadata][index_suffix]}" } }
      mutate { remove_field => [ "@mymetadata" ] }
    }

    output {
      #stdout {
      #  codec  => rubydebug {
      #    metadata => true
      #  }
      #}

      if [@metadata][beat] == "filebeat" {
      if "" in [@metadata][index] {
          elasticsearch {
            hosts => {{ .Values.elastic_ingest_nodes | toJson }}
            cacert => '/etc/ssl/certs/container/ca.crt'
            ssl_certificate_verification => true
            user => "${ELASTICSEARCH_USERNAME}"
            password => "${ELASTICSEARCH_PASSWORD}"
            index => "%{[@metadata][index]}"
            template_name => "filebeat-external"
            ilm_enabled => false
            pipeline => "filebeat-external_modules"
            manage_template => false
          }
        } else {
          elasticsearch {
            hosts => {{ .Values.elastic_ingest_nodes | toJson }}
            cacert => '/etc/ssl/certs/container/ca.crt'
            ssl_certificate_verification => true
            user => "${ELASTICSEARCH_USERNAME}"
            password => "${ELASTICSEARCH_PASSWORD}"
            ilm_rollover_alias => "filebeat-external"
            ilm_policy => "filebeat-external"
            ilm_enabled => true
            ilm_pattern => "{now/d}-000001"
            pipeline => "filebeat-external_modules"
            manage_template => false
          }
        }
      }
      if [@metadata][beat] == "winlogbeat" {
        if "" in [@metadata][index] {
          elasticsearch {
            hosts => {{ .Values.elastic_ingest_nodes | toJson }}
            cacert => '/etc/ssl/certs/container/ca.crt'
            ssl_certificate_verification => true
            user => "${ELASTICSEARCH_USERNAME}"
            password => "${ELASTICSEARCH_PASSWORD}"
            index => "%{[@metadata][index]}"
            template_name => "winlogbeat"
            ilm_enabled => false
            manage_template => false
          }
        } else {
          elasticsearch {
            hosts => {{ .Values.elastic_ingest_nodes | toJson }}
            cacert => '/etc/ssl/certs/container/ca.crt'
            ssl_certificate_verification => true
            user => "${ELASTICSEARCH_USERNAME}"
            password => "${ELASTICSEARCH_PASSWORD}"
            ilm_rollover_alias => "winlogbeat"
            ilm_policy => "winlogbeat"
            ilm_enabled => true
            ilm_pattern => "{now/d}-000001"
            manage_template => false
          }
        }
      }
      if [@metadata][beat] == "auditbeat" {
        elasticsearch {
          hosts => {{ .Values.elastic_ingest_nodes | toJson }}
          cacert => '/etc/ssl/certs/container/ca.crt'
          ssl_certificate_verification => true
          user => "${ELASTICSEARCH_USERNAME}"
          password => "${ELASTICSEARCH_PASSWORD}"
          ilm_rollover_alias => "auditbeat-external"
          ilm_policy => "auditbeat-external"
          ilm_enabled => true
          ilm_pattern => "{now/d}-000001"
          manage_template => false
        }
      }
    }
