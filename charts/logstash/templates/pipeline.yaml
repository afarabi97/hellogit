{{- $c := div .Values.number_of_kafka_partitions .Values.replicas -}}
---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-pipeline
  annotations:
    "helm.sh/hook": "pre-install"
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": "before-hook-creation"
data:
  zeek.conf: |
    input {
{{- range $index, $cluster := .Values.kafka_clusters }}
      kafka {
        topics => ["zeek-raw"]
        max_poll_records => "4096"
        consumer_threads => {{$c}}
        group_id => "logstash_bro_{{ $index }}"
        client_id => "logstash_bro_${POD_NAME:default}"
        bootstrap_servers => "{{ $cluster }}"
        codec => json
        auto_offset_reset => "earliest"
      }
{{- end }}
    }

    filter {
      mutate {
        rename => {
          "@stream" => "[event][dataset]"
          "@system" => "[observer][hostname]"
          "@proc"   => "[observer][sub_process]"
          "@interface"   => "[observer][interface]"
        }
      }
    }

    output {
      # stdout { codec => rubydebug }
      elasticsearch {
        hosts => ["https://{{ .Values.elastic_fqdn }}:{{ .Values.elastic_port }}"]
        cacert => '/etc/ssl/certs/container/ca.crt'
        ssl_certificate_verification => true
        user => "${ELASTICSEARCH_USERNAME}"
        password => "${ELASTICSEARCH_PASSWORD}"
        ilm_rollover_alias => "ecs-zeek"
        ilm_policy => "ecs-zeek"
        ilm_pattern => "000001"
        manage_template => false
      }
    }


  beats.conf: |
    input {
      beats {
        port => 5045
        ssl => true
        ssl_certificate_authorities => ["/etc/ssl/certs/container/ca.crt"]
        ssl_certificate => '/etc/ssl/certs/container/tls.crt'
        ssl_key => '/etc/ssl/certs/container/tls.key'
        ssl_verify_mode => "peer"
      }
    }


    output {
      if [@metadata][beat] == "filebeat" {
        elasticsearch {
          hosts => ["https://{{ .Values.elastic_fqdn }}:{{ .Values.elastic_port }}"]
          cacert => '/etc/ssl/certs/container/ca.crt'
          ssl_certificate_verification => true
          user => "${ELASTICSEARCH_USERNAME}"
          password => "${ELASTICSEARCH_PASSWORD}"
          ilm_rollover_alias => "filebeat-external"
          ilm_policy => "filebeat-external"
          ilm_enabled => false
          manage_template => false
        }
      }
      if [@metadata][beat] == "winlogbeat" {
        elasticsearch {
          hosts => ["https://{{ .Values.elastic_fqdn }}:{{ .Values.elastic_port }}"]
          cacert => '/etc/ssl/certs/container/ca.crt'
          ssl_certificate_verification => true
          user => "${ELASTICSEARCH_USERNAME}"
          password => "${ELASTICSEARCH_PASSWORD}"
          ilm_rollover_alias => "winlogbeat"
          ilm_policy => "winlogbeat"
          ilm_enabled => false
          manage_template => false
        }
      }
      if [@metadata][beat] == "auditbeat" {
        elasticsearch {
          hosts => ["https://{{ .Values.elastic_fqdn }}:{{ .Values.elastic_port }}"]
          cacert => '/etc/ssl/certs/container/ca.crt'
          ssl_certificate_verification => true
          user => "${ELASTICSEARCH_USERNAME}"
          password => "${ELASTICSEARCH_PASSWORD}"
          ilm_rollover_alias => "auditbeat-external"
          ilm_policy => "auditbeat-external"
          ilm_enabled => false
          manage_template => false
        }
      }
    }
