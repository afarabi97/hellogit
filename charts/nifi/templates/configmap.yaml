apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}
data:
  setup.sh: |
    #!/bin/sh -e

    scripts_dir='/opt/nifi/scripts'
    [ -f "${scripts_dir}/common.sh" ] && . "${scripts_dir}/common.sh"

    prop_replace 'nifi.flow.configuration.file' "./flowfile_repository/flow.xml.gz"

    # echo "Adding OIDC Settings"
    # prop_replace 'nifi.security.user.oidc.discovery.url' "{{ .Values.auth_base }}/.well-known/openid-configuration"
    # prop_replace 'nifi.security.user.oidc.client.id' "nifi"
    # prop_replace 'nifi.security.user.oidc.client.secret' "${CLIENT_SECRET}"
    # prop_replace 'nifi.security.user.oidc.additional.scopes' "givenName,surname,displayName,roles,groups"
    # prop_replace 'nifi.security.user.oidc.claim.identifying.user' "upn"
    #
    # #WebCA truststore
    # echo "Create WebCA TrustStore"
    # keytool -importcert -noprompt -trustcacerts -file /etc/ssl/certs/container/ca.crt -alias webCA -keystore /opt/nifi/nifi-current/webCA.jks -storepass ${TRUSTSTORE_PASSWORD}
    #
    # #Nifi Keystore
    # echo "Create NiFi KeyStore"
    # openssl pkcs12 -export -in /etc/ssl/certs/container/tls.crt -inkey /etc/ssl/certs/container/tls.key -out /opt/nifi/nifi-current/nifi.pfx -passout pass:${KEYSTORE_PASSWORD}
    # keytool -importkeystore -srckeystore /opt/nifi/nifi-current/nifi.pfx -srcstoretype pkcs12 -srcalias 1 -srcstorepass ${KEYSTORE_PASSWORD} -destkeystore /opt/nifi/nifi-current/nifi.jks -deststoretype jks -deststorepass ${KEYSTORE_PASSWORD} -destalias nifi

  keystore.sh: |
    #!/bin/sh -e

    #WebCA truststore
    echo "Create WebCA TrustStore"
    cp /usr/local/openjdk-8/lib/security/cacerts /tmp/keystore/cacerts
    chmod +w /tmp/keystore/cacerts
    keytool -importcert -noprompt -trustcacerts -file /etc/ssl/certs/container/ca.crt -alias webCA -keystore /tmp/keystore/cacerts -storepass changeit
