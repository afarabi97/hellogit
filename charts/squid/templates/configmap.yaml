apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}
  labels:
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
data:
  squid.conf: |
    http_port 8888

    acl localnet src 10.{{ .Values.jdms_gip_number }}.4.0/24
    acl vCenter src 10.{{ .Values.jdms_gip_number }}.2.4/32
    acl ops_vlan src 10.{{ .Values.jdms_gip_number }}.3.0/24

    acl SSL_ports port 443
    acl Safe_ports port 80                 # http
    acl Safe_ports port 443                # https
    acl Safe_ports port 70                 # gopher
    acl Safe_ports port 210                # wais
    acl Safe_ports port 1025-65535         # unregistered ports
    acl Safe_ports port 280                # http-mgmt
    acl Safe_ports port 488                # gss-http
    acl Safe_ports port 591                # filemaker
    acl Safe_ports port 777                # multiling http

    acl CONNECT method CONNECT

    acl approved_domains dstdomain .di2e.net .sbaas.pgs-sf.com

    http_access deny !Safe_ports
    http_access deny CONNECT !SSL_ports
    http_access allow localhost
    http_access allow localnet
    http_access allow vCenter
    http_access allow ops_vlan approved_domains
    http_access deny all

    coredump_dir /var/spool/squid

    # Add any of your own refresh_pattern entries above these.
    refresh_pattern ^ftp:           1440    20%     10080
    refresh_pattern ^gopher:        1440    0%      1440
    refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
    refresh_pattern .               0       20%     4320
