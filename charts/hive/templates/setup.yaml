---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-setup
data:
  setup.py: |
{{ .Files.Get "files/setup.py" | indent 4 }}

  init-cortex1.sh: |
    #!/bin/bash
    curl -o /tmp/api/cortex_api.txt -XGET -u ${CORTEX_SUPERADMIN_USERNAME}:${CORTEX_SUPERADMIN_PASSWORD} --cacert /etc/ssl/certs/container/ca.crt https://cortex.default.svc.cluster.local/api/user/${CORTEX_USER_USERNAME}/key

  init-cortex2.sh: |
    #!/bin/sh
    CORTEX_API_KEY=$(cat /tmp/hive/cortex_api.txt)
    cp /data/config.conf /tmp/hive/application.conf
    sed -i 's|##CORTEX_API_KEY##|'${CORTEX_API_KEY}'|g' /tmp/hive/application.conf
    chown -R 1 /tmp/hive

  init-misp.sh: |
    #!/bin/sh
    if [ ! -f /tmp/hive/application.conf ]; then
      cp /data/config.conf /tmp/hive/application.conf;
    fi
    sed -i 's|##MISP_API_KEY##|'${MISP_API_KEY}'|g' /tmp/hive/application.conf
    chown -R 1 /tmp/hive

  keystore.sh: |
    #!/bin/bash

    #WebCA truststore
    keytool -importcert -noprompt -trustcacerts -file /etc/ssl/certs/container/ca.crt -alias webCA -keystore /opt/thehive/keystore/webCA.jks -storepass ${KEYSTORE_PASSWORD}
    if [ ! -f /tmp/hive/application.conf ]; then
      cp /data/config.conf /tmp/hive/application.conf
    fi
    sed -i 's|##KEYSTORE_PASSWORD##|'${KEYSTORE_PASSWORD}'|g' /tmp/hive/application.conf
    chown -R 1 /tmp/hive

    #Default truststore
    echo "Add WebCA to default trustStore"
    cp /usr/local/openjdk-8/jre/lib/security/cacerts /opt/thehive/keystore/cacerts
    chmod +w /opt/thehive/keystore/cacerts
    keytool -importcert -noprompt -trustcacerts -file /etc/ssl/certs/container/ca.crt -alias webCA -keystore /opt/thehive/keystore/cacerts -storepass changeit

  init-hive.sh: |
    #!/bin/sh
    if [ ! -f /tmp/hive/application.conf ]; then
      cp /data/config.conf /tmp/hive/application.conf;
    fi
    sed -i 's|##OPEN_ID_SECRET##|'${OPEN_ID_SECRET}'|g' /tmp/hive/application.conf
    chown -R 1 /tmp/hive
