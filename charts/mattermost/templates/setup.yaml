---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-setup
data:
  setup.sh: |
{{ .Files.Get "files/setup.sh" | indent 4 }}

  config_file.sh: |
    #!/bin/sh
    cp /config.json.save /mattermost/config/config.json
    cp /config.json.save /mattermost/config/config.json.tmp

    echo "Configuring TLS Settings"
    cat /mattermost/config/config.json.tmp | jq '.ServiceSettings.SiteURL = "https://mattermost.{{ .Values.domain }}"' |
                                             jq '.ServiceSettings.ConnectionSecurity = "TLS"' |
                                             jq '.ServiceSettings.TLSCertFile = "/etc/ssl/certs/container/tls.crt"' |
                                             jq '.ServiceSettings.TLSKeyFile = "/etc/ssl/certs/container/tls.key"' > /mattermost/config/config.json
