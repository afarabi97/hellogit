---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-setup
data:
  setup.py: |
{{ .Files.Get "files/setup.py" | indent 4 }}

  config_file.sh: |
    #!/bin/sh
    cp /config.json.save /mattermost/config/config.json
    cp /config.json.save /mattermost/config/config.json.tmp

    echo "Configuring TLS Settings"
    # echo "Configuring TLS, GitLab (OpenId Connect), & SAML Settings"
    cat /mattermost/config/config.json.tmp | jq '.ServiceSettings.SiteURL = "https://mattermost.{{ .Values.domain }}"' |
                                             jq '.ServiceSettings.ConnectionSecurity = "TLS"' |
                                             jq '.ServiceSettings.TLSCertFile = "/etc/ssl/certs/container/tls.crt"' |
                                             jq '.ServiceSettings.TLSKeyFile = "/etc/ssl/certs/container/tls.key"' |
                                             jq '.GitLabSettings.Enable = true' |
                                             jq '.GitLabSettings.Secret = "'${OPEN_ID_SECRET}'"' |
                                             jq '.GitLabSettings.Id = "mattermost"' |
                                             jq '.GitLabSettings.Scope = ""' |
                                             jq '.GitLabSettings.AuthEndpoint = "{{ .Values.auth_base }}/protocol/openid-connect/auth"' |
                                             jq '.GitLabSettings.TokenEndpoint = "{{ .Values.auth_base }}/protocol/openid-connect/token"' |
                                             jq '.GitLabSettings.UserApiEndpoint = "{{ .Values.auth_base }}/protocol/openid-connect/userinfo"' > /mattermost/config/config.json

                                             # jq '.SamlSettings.Enable = true' |
                                             # jq '.SamlSettings.SignRequest = true' |
                                             # jq '.SamlSettings.IdpUrl = "{{ .Values.auth_base }}/protocol/saml"' |
                                             # jq '.SamlSettings.IdpDescriptorUrl = "https://{{ .Release.Name }}.{{ .Values.domain }}"' |
                                             # jq '.SamlSettings.IdpMetadataUrl = "{{ .Values.auth_base }}/protocol/saml/descriptor"' |
                                             # jq '.SamlSettings.AssertionConsumerServiceURL = "https://{{ .Release.Name }}.{{ .Values.domain }}/login/sso/saml"' |
                                             # jq '.SamlSettings.IdpCertificateFile = "saml-idp.crt"' |
                                             # jq '.SamlSettings.PublicCertificateFile = "saml-public.crt"' |
                                             # jq '.SamlSettings.PrivateKeyFile = "saml-private.key"' |
                                             # jq '.SamlSettings.IdAttribute = "id"' |
                                             # jq '.SamlSettings.EnableAdminAttribute = false' |
                                             # jq '.SamlSettings.AdminAttribute = ""' |
                                             # jq '.SamlSettings.FirstNameAttribute = "givenName"' |
                                             # jq '.SamlSettings.LastNameAttribute = "surname"' |
                                             # jq '.SamlSettings.EmailAttribute = "email"' |
                                             # jq '.SamlSettings.UsernameAttribute = "uid"' |
                                             # jq '.SamlSettings.NicknameAttribute = "displayName"' > /mattermost/config/config.json
