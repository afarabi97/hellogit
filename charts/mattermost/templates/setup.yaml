---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-setup
data:
  setup.py: |
{{ .Files.Get "files/setup.py" | indent 4 }}

  config_file.sh: |
    #!/bin/sh
    # Wait until config file is created
    while [ ! -f /mattermost/config/config.json ]; do sleep 5; done
    echo "Configuring TLS Settings"
    /mattermost/bin/mattermost config set ServiceSettings.TLSCertFile "/etc/ssl/certs/container/tls.crt"
    /mattermost/bin/mattermost config set ServiceSettings.TLSKeyFile "/etc/ssl/certs/container/tls.key"
    /mattermost/bin/mattermost config set ServiceSettings.ConnectionSecurity "TLS"
    /mattermost/bin/mattermost config set ServiceSettings.SiteURL "https://mattermost.{{ .Values.domain }}"
    echo "Configuring Gitlab Settings"
    /mattermost/bin/mattermost config set GitLabSettings.Enable true
    /mattermost/bin/mattermost config set GitLabSettings.Secret "'${OPEN_ID_SECRET}'"
    /mattermost/bin/mattermost config set GitLabSettings.Id mattermost
    /mattermost/bin/mattermost config set GitLabSettings.Scope ""
    /mattermost/bin/mattermost config set GitLabSettings.AuthEndpoint "{{ .Values.auth_base }}/protocol/openid-connect/auth"
    /mattermost/bin/mattermost config set GitLabSettings.TokenEndpoint "{{ .Values.auth_base }}/protocol/openid-connect/token"
    /mattermost/bin/mattermost config set GitLabSettings.UserApiEndpoint "{{ .Values.auth_base }}/protocol/openid-connect/userinfo"
