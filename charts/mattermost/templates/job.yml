---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-setup
  labels:
    component: {{ .Release.Name }}-setup
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 0
  template:
    metadata:
      labels:
        component: {{ .Release.Name }}-setup
    spec:
      restartPolicy: Never
      containers:
      - name: setup
        image: "{{ .Values.python_image }}"
        imagePullPolicy: IfNotPresent
        command:
        - "/bin/sh"
        - "-c"
        - "python3 /setup.py"
        env:
        - name: ADMIN_USER
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-secret
              key: admin_user
        - name: ADMIN_EMAIL
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-secret
              key: admin_email
        - name: ADMIN_PASS
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-secret
              key: admin_pass
        - name: TEAM_NAME
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-secret
              key: team_name
        volumeMounts:
        - name: setup
          mountPath: /setup.py
          subPath: setup.py
        - name: webca
          mountPath: /etc/ssl/certs/container
          readOnly: true
      nodeSelector:
        role: "server"
      volumes:
      - name: setup
        configMap:
          name: {{ .Release.Name }}-setup
      - name: webca
        secret:
          defaultMode: 420
          optional: false
          secretName: webca-certificate
      nodeSelector:
        role: server
      restartPolicy: Never
