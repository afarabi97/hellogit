---

- name: change domain
  copy:
    content: "{{ ansible_controller_hostname }}"
    dest: /etc/hostname
    force: yes
  register: controller_domain_results

- name: restart systemd-hostname # noqa 503
  systemd:
    name: systemd-hostnamed
    state: restarted
  when: controller_domain_results.changed

- name: modify /etc/hosts
  lineinfile:
    dest: /etc/hosts
    regexp: '^127\.0\.0\.1[ \t]+localhost'
    line: '127.0.0.1 localhost {{ ansible_controller_hostname }}'
    state: present

- name: modify offline yum repo
  lineinfile:
    dest: "{{ item }}"
    regexp: "baseurl=http://controller.*/offlinerepo/tfplenum"
    line: "baseurl=http://{{ ansible_controller_hostname }}/offlinerepo/tfplenum"
    state: present
  with_items:
    - /var/www/html/offlinerepo/offline.repo
    - /etc/yum.repos.d/offline.repo

- name: Update Keycloak and Controller Shibboleth Configs
  script: "/opt/sso-idp/update_portal_client.py --new_hostname {{ ansible_controller_hostname }} --new_ip {{ server_ip }}"
  args:
    executable: /opt/tfplenum/web/tfp-env/bin/python3

- name: Enable Firewalld Service
  service:
    name: "firewalld"
    state: started
    enabled: true

- name: Add assessor user
  user:
    name: assessor
    shell: /bin/bash
    groups: wheel
    append: yes
  register: assessor_user
  notify:
    - Generate RootPw
    - Update assessor user password

- name: update sshd_conf
  template:
    src: templates/sshd_config
    dest: "/etc/ssh/sshd_config"
  register: sshd_config
  notify:
    - Bump sshd

...
