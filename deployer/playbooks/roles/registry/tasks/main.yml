#######################################################
###########  Install Docker Distribution ##############
#######################################################
---
- name: Import tfplenum variables
  include_vars:
    file: "{{ tfplenum_vars }}"
  tags: pull-docker-images

- name: Install Docker Dist
  yum:
    name: docker-distribution
    state: installed

- name: docker-dist config template
  template:
    backup: yes
    src: config.yml.j2
    dest: /etc/docker-distribution/registry/config.yml
    owner: root
    group: root
    mode: 0644
  register: docker_dist_config_result

- name: Register Firewall Port
  firewalld:
    port: "{{ firewall_port }}/tcp"
    permanent: true
    immediate: true
    state: enabled

- name: Enable docker distribution service
  systemd:
    name: docker-distribution
    enabled: yes
    state: started
    daemon_reload: yes

- name: Restart docker-dist
  service:
    name: docker-distribution
    state: restarted
    enabled: yes
  when: docker_dist_config_result.changed

- name: Install Docker
  yum:
    name:
      - python-pip
      - docker-ce
    state: installed

- name: upgrade pip
  pip:
    name: pip
    state: latest

- name: install pip modules
  pip:
    name: "{{ pip_installs }}"
    state: present

- name: Create directory docker directory
  file:
    path: /etc/docker
    state: directory
    owner: root
    group: root
    mode: 0755

- name: docker daemon conf
  template:
    backup: yes
    src: daemon.json.j2
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: 0644
  register: docker_config_result

- name: Restart Docker
  systemd:
    name: docker
    enabled: yes
    state: restarted

- name: Download docker container images from internet
  docker_image:
    name: "{{ item }}"
    source: pull
  with_items:
    - "{{ kube_images }}"
  tags: pull-docker-images

- name: Tag local images for upload to registry
  shell: "docker tag {{ item }} localhost:{{ firewall_port }}/{{ item[item.find('/')+1:] }}"
  with_items:
    - "{{ kube_images }}"
  tags: pull-docker-images

- name: Upload local images to registry
  docker_image:
    name: "localhost:{{ firewall_port }}/{{ item[item.find('/')+1:] }}"
    push: yes
    source: local
  with_items:
    - "{{ kube_images }}"
  tags: pull-docker-images

...
