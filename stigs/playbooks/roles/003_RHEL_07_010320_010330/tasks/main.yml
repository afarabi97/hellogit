- name: |
    "MEDIUM | RHEL-07-010320 | Accounts on the Red Hat Enterprise Linux operating system that are subject to three unsuccessful logon attempts within 15 minutes must be locked for the maximum configurable period."
    "MEDIUM | RHEL-07-010330 | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
  block:
    - name: |
        "MEDIUM | RHEL-07-010320 | PATCH | Accounts on the Red Hat Enterprise Linux operating system that are subject to three unsuccessful logon attempts within 15 minutes must be locked for the maximum configurable period."
        "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
      pamd:
        name: "{{ item }}"
        state: before
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: required
        new_module_path: pam_faillock.so
      with_items:
        - "system-auth"
        - "password-auth"
    # TODO: Remove temporary audit check to determine if the following pamd module task needs to be run since the module is not idempotent
    - name: |
        "MEDIUM | RHEL-07-010320 | AUDIT | Check for existing account lockout settings"
        "MEDIUM | RHEL-07-010330 | AUDIT | Check for existing account lockout settings"
      command: "grep -iE '^auth\\s+required\\s+pam_faillock.so\\s+preauth\\s+silent\\s+audit\\s+deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }}\\s+unlock_time={{ rhel7stig_pam_faillock.unlock_time }}$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: rhel_07_010320_010330_preauth_audit.rc > 1
      register: rhel_07_010320_010330_preauth_audit
      with_items:
        - "system-auth"
        - "password-auth"
    # TODO: Once the pamd module is fixed (either args_present or updated) then remove the previous grep task and update the following.
    - name: |
        "MEDIUM | RHEL-07-010320 | PATCH | Accounts on the Red Hat Enterprise Linux operating system that are subject to three unsuccessful logon attempts within 15 minutes must be locked for the maximum configurable period."
        "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: "preauth silent audit deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }} unlock_time={{ rhel7stig_pam_faillock.unlock_time }}"
      with_items: "{{ rhel_07_010320_010330_preauth_audit.results }}"
      when: item.rc == 1
    - name: "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
      pamd:
        name: "{{ item }}"
        state: before
        type: auth
        control: required
        module_path: pam_deny.so
        new_type: auth
        new_control: "[default=die]"
        new_module_path: pam_faillock.so
      with_items:
        - "system-auth"
        - "password-auth"
    # TODO: Remove temporary audit check to determine if the following pamd module task needs to be run since the module is not idempotent
    - name: "MEDIUM | RHEL-07-010330 | AUDIT | Check for existing account lockout settings"
      command: "grep -iE '^auth\\s+\\[default=die\\]\\s+pam_faillock.so\\s+authfail\\s+audit\\s+deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }}\\s+unlock_time={{ rhel7stig_pam_faillock.unlock_time }}$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: rhel_07_010330_authfail_audit.rc > 1
      register: rhel_07_010330_authfail_audit
      with_items:
        - "system-auth"
        - "password-auth"
    # TODO: Once the pamd module is fixed (either args_present or updated) then remove the previous grep task and update the following.
    - name: "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: auth
        control: "[default=die]"
        module_path: pam_faillock.so
        module_arguments: "authfail audit deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }} unlock_time={{ rhel7stig_pam_faillock.unlock_time }}"
      with_items: "{{ rhel_07_010330_authfail_audit.results }}"
      when: item.rc == 1
    - name: "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
      pamd:
        name: "{{ item }}"
        state: before
        type: account
        control: required
        module_path: pam_unix.so
        new_type: account
        new_control: required
        new_module_path: pam_faillock.so
      with_items:
        - "system-auth"
        - "password-auth"
  tags:
    - RHEL-07-010320
    - RHEL-07-010330
    - pamd
