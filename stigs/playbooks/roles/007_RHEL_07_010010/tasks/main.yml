- name: "HIGH | RHEL-07-010010 | The Red Hat Enterprise Linux operating system must be configured so that the file permissions, ownership, and group membership of system files and commands match the vendor values."
  block:
    - name: "HIGH | RHEL-07-010010 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the file permissions, ownership, and group membership of system files and commands match the vendor values."
      shell: |
        rpm -Va --nolinkto --nofiledigest --nosize --nomtime --nodigest --nosignature | grep -E '^(.M|.....U|......G)' | tee /dev/stderr | cut -c13- | sed 's/^ //' | xargs rpm -qf --qf='%{name}\n' | sort -u
      args:
        warn: no
      check_mode: no
      failed_when: no
      changed_when: rhel_07_010010_audit.stdout != ""
      register: rhel_07_010010_audit

    - name: "HIGH | RHEL-07-010010 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the file permissions, ownership, and group membership of system files and commands match the vendor values."
      debug:
        msg: "{{ rhel_07_010010_audit.stderr_lines }}"
      changed_when: yes
      when: rhel_07_010010_audit.stdout != ""

    - name: "HIGH | RHEL-07-010010 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the file permissions, ownership, and group membership of system files and commands match the vendor values."
      shell: >
        ( rpm --setugids {{ item | quote }}; rpm --setperms {{ item | quote }} )
        2>&1 1>&2 | grep -v ': No such file or directory$'
      args:
        warn: no
      register: rhel_07_010010_patch
      failed_when: rhel_07_010010_patch.stdout != ""
      ignore_errors: yes
      with_items: "{{ rhel_07_010010_audit.stdout_lines }}"

    - name: "HIGH | RHEL-07-010010 | AUDIT | WARNING: error during remediation"
      debug:
        msg: "{{ item.stdout_lines }}"
      changed_when: yes
      with_items: "{{ rhel_07_010010_patch.results }}"
      loop_control:
        label: "{{ item.item }}"
      when:
        - rhel_07_010010_patch is changed
        - item is failed
  tags:
    - RHEL-07-010010
