# site.yml is the overall playbook, but all it does is include the other playbooks that are part of the site. For more
# information about the structure see:
# http://docs.ansible.com/ansible/latest/playbooks_best_practices.html
# http://docs.ansible.com/ansible/latest/intro_inventory.html
# We follow the guidance to include naming conventions there.

---

- name: Tag master server
  hosts: localhost
  tags: always
  tasks:
    - name: Set Master Server
      add_host:
        hostname: "{{ item }}"
        groups: master_server
      when: hostvars[item].is_master | default(false)
      with_items: "{{ groups['all'] }}"
      changed_when: false

- name: Verify tfplenum has been deployed
  hosts:
    - master_server
    - servers
    - sensors
  gather_facts: no
  roles:
    - preflight
  tags: preflight

# - name: Replay PCAPs
#   hosts:
#   - localhost
#   gather_facts: yes
#   roles:
#     - replay
#   tags: replay

- name: Verify kubernetes is healthy
  hosts: master_server
  gather_facts: no
  roles:
    - kubernetes
  tags: kubernetes

- name: Get ES Password from K8s
  hosts: master_server
  tags: always
  tasks:
    - name: Get ES Password
      shell: |
        set -o pipefail && kubectl get secret tfplenum-es-elastic-user -o=jsonpath='{.data.elastic}' | base64 --decode
      register: es_password_results
      changed_when: false
    - name: Set ES Creds
      set_fact:
        elastic_password: "{{ es_password_results.stdout }}"
        elastic_username: "elastic"
        cacheable: yes

- name: Validate Elasticsearch
  hosts:
  - master_server
  gather_facts: no
  roles:
    - elasticsearch
  tags: elasticsearch

- name: Validate Kibana
  hosts:
  - master_server
  gather_facts: no
  roles:
    - kibana
  tags: kibana

- name: Validate Zeek
  hosts:
  - master_server
  gather_facts: no
  roles:
    - zeek
  tags: zeek

- name: Validate Suricata
  hosts:
  - master_server
  - sensors
  gather_facts: no
  roles:
    - suricata
  tags: suricata

- name: Validate Moloch
  hosts:
  - master_server
  gather_facts: no
  roles:
    - moloch
  tags: moloch

- name: Validate WikiJS
  hosts:
  - master_server
  gather_facts: no
  roles:
    - wikijs
  tags: wikijs

- name: Validate Hive
  hosts:
  - master_server
  gather_facts: no
  roles:
    - hive
  tags: hive

- name: Validate Cortex
  hosts:
  - master_server
  gather_facts: no
  roles:
    - cortex
  tags: cortex

- name: Validate MISP
  hosts:
  - master_server
  gather_facts: no
  roles:
    - misp
  tags: misp

- name: Validate MongoDB
  hosts:
  - master_server
  gather_facts: no
  roles:
    - mongodb
  tags: mongodb

- name: Validate RocketChat
  hosts:
  - master_server
  gather_facts: no
  roles:
    - rocketchat
  tags: rocketchat
...
