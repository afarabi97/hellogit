# site.yml is the overall playbook, but all it does is include the other playbooks that are part of the site. For more
# information about the structure see:
# http://docs.ansible.com/ansible/latest/playbooks_best_practices.html
# http://docs.ansible.com/ansible/latest/intro_inventory.html
# We follow the guidance to include naming conventions there.

---

- name: Tag master server
  hosts: localhost
  tags: always
  tasks:
    - add_host:
        hostname: "{{ item }}"
        groups: master_server
      when: hostvars[item].is_master | default(false)
      with_items: "{{ groups['all'] }}"
      changed_when: false

- name: Tag remote sensors
  hosts: localhost
  tags: always
  tasks:
    - add_host:
        hostname: "{{ item }}"
        groups: remote_sensors
      when: hostvars[item].is_remote | default(false)
      with_items: "{{ groups['all'] }}"
      changed_when: false

- name: Verify tfplenum has been deployed
  hosts:
    - master_server
    - servers
    - sensors
    - remote_sensors
  gather_facts: no
  roles:
    - preflight
  tags: preflight

- name: Replay PCAPs
  hosts:
  - localhost
  gather_facts: yes
  roles:
    - replay
  tags: replay

- name: Verify kubernetes is healthy
  hosts: master_server
  gather_facts: no
  roles:
    - kubernetes
  tags: kubernetes

- name: Validate Elasticsearch
  hosts:
  - master_server
  gather_facts: no
  roles:
    - elasticsearch
  tags: elasticsearch

- name: Validate Kibana
  hosts:
  - master_server
  gather_facts: no
  roles:
    - kibana
  tags: kibana

- name: Validate Bro
  hosts:
  - master_server
  gather_facts: no
  roles:
    - bro
  tags: bro

- name: Validate Suricata
  hosts:
  - master_server
  - sensors
  gather_facts: no
  roles:
    - suricata
  tags: suricata

- name: Validate Moloch
  hosts:
  - master_server
  gather_facts: no
  roles:
    - moloch
  tags: moloch

- name: Validate Mumble
  hosts:
  - master_server
  gather_facts: no
  roles:
    - mumble-server
  tags: mumble-server

...
