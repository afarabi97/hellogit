---
- name: Prepare controller for export
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    ansible_python_interpreter: "{{ python_executable }}"
  tasks:
    - name: Wait for the virtual machine to shutdown
      vmware_guest_powerstate:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        name: "{{ node.hostname }}"
        state: shutdown-guest
        validate_certs: no
        state_change_timeout: 300
      retries: 3
      delay: 5

    - name: "Prepping the controller"
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        validate_certs: False
        name: "{{ node.hostname }}"
        datacenter: "{{ vcenter.datacenter }}"
        cluster: "{{ vcenter.cluster }}"
        folder: "{{ node.folder }}"
        state: present
        networks:
          - name: Internal
            type: dhcp
        hardware:
          memory_mb: "{{ node.memory }}"
          num_cpus: "{{ node.cpu }}"
        cdrom:
          type: none
          state: absent
      delegate_to: localhost

    - name: "Remove old template if it exists."
      ignore_errors: yes
      vmware_guest:
        datacenter: "{{ vcenter.datacenter }}"
        cluster: "{{ vcenter.cluster }}"
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        name: "{{ release_template_name }}"
        state: absent
        validate_certs: False
      delegate_to: localhost

    - name: "Cloning the release for archive."
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        validate_certs: False
        name: "{{ release_template_name }}"
        template: "{{ node.hostname }}"
        datacenter: "{{ vcenter.datacenter }}"
        cluster: "{{ vcenter.cluster }}"
        folder: "Releases"
        state: present
        is_template: no
        networks:
          - name: Internal
            type: dhcp
        hardware:
          memory_mb: "{{ node.memory }}"
          num_cpus: "{{ node.cpu }}"
        cdrom:
          type: none
          state: absent
        disk:
          - size_gb: "{{ node.disk_size }}"
            type: thin
            datastore: "{{ node.datastore }}"
      delegate_to: localhost

    - name: Create a VM snapshot
      vmware_guest_snapshot:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        folder: "{{ node.folder }}"
        name: "{{ release_template_name }}"
        validate_certs: False
        state: present
        snapshot_name: "baseline"

    - name: Create a VM Template
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        folder: "{{ node.folder }}"
        name: "{{ release_template_name }}"
        validate_certs: False
        state: present
        is_template: yes
