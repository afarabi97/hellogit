---
- name: Create a virtual machine from a template.
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    ansible_python_interpreter: "{{ python_executable }}"
  tasks:
    - name: "Power off the {{ vmname }} virtual machine."
      ignore_errors: yes
      vmware_guest:
        hostname: "{{ vcenter.hostname }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        name: "{{ vmname }}"
        datacenter: "{{ datacenter }}"
        cluster: "{{ cluster }}"
        folder: "{{ folder }}"
        state: poweredoff
        validate_certs: False
      delegate_to: localhost

    - name: "Delete the {{ vmname }} virtual machine."
      ignore_errors: yes
      vmware_guest:
        hostname: "{{ vcenter.hostname }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        name: "{{ vmname }}"
        datacenter: "{{ datacenter }}"
        cluster: "{{ cluster }}"
        state: absent
        validate_certs: False
      delegate_to: localhost

    - name: "Create a new virtual machine named {{ vmname }} from the {{ template }} template."
      vmware_guest:
        hostname: "{{ vcenter.hostname }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        validate_certs: False
        name: "{{ vmname }}"
        datacenter: "{{ datacenter }}"
        cluster: "{{ cluster }}"
        folder: "{{ folder }}"
        template: "{{ template }}"
        state: poweredon
        networks: "{{ networks }}"
        customization: "{{ customization }}"
        hardware: "{{ hardware }}"
        disk: "{{ disks }}"
      delegate_to: localhost
      register: result
    