---
- name: Change node network config settings
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    ansible_python_interpreter: "{{ python_executable }}"
    ens192_path: "/etc/sysconfig/network-scripts/ifcfg-ens192"
  tasks:
    - name: Set template ova name
      set_fact:
        ctrl_name: "{{ '.'.join(node.template.split('.')[:-1]) }}"
      when: "run_type == 'build_from_scratch'"

    - name: Set controller ova name
      set_fact:
        ctrl_name: "{{ '.'.join(node.ctrl_name.split('.')[:-1]) }}"
      when: "run_type == 'clone_from_nightly'"

    - name: "Power on the VM {{ ctrl_name }}"
      ignore_errors: yes
      vmware_guest_powerstate:
        hostname: "{{ esxi.ipaddress }}"
        username: "{{ esxi.username }}"
        password: "{{ esxi.password }}"
        name:  "{{ ctrl_name }}"
        state: powered-on
        validate_certs: no
      delegate_to: localhost     

    - name: Wait for SSH port
      wait_for:
        port: 22
        delay: 20
        state: started

    - name: Run command inside a virtual machine
      ignore_errors: yes
      vmware_vm_shell:
        hostname: "{{ esxi.ipaddress}}"
        username: "{{ esxi.username }}"
        password: "{{ esxi.password }}"
        vm_id: "{{ ctrl_name }}"
        vm_username: "{{ node.username }}"
        vm_password: "{{ node.password }}"
        vm_shell: /usr/bin/sudo
        vm_shell_args: "{{ item }}"
        vm_shell_cwd: "/usr/sbin"
        validate_certs: no
      delegate_to: localhost
      with_items:
        - "nmcli con mod ens192 ipv4.address {{ node.ipaddress }}/24"
        - "nmcli con mod ens192 ipv4.gateway {{ node.gateway }}"
        - "nmcli con mod ens192 ipv4.dns {{ node.dns_servers[0] }}"
        - "sed -i 's/HWADDR.*//' {{ ens192_path }}"
        - "sed -i 's/ONBOOT.*/ONBOOT=yes/' {{ ens192_path }}"
        - "sed -i 's/BOOTPROTO.*/BOOTPROTO=static/'  {{ ens192_path }}"
        - "systemctl restart network NetworkManager"
        - "echo nameserver {{ node.dns_servers[0] }} >> /etc/resolv.conf"
...

