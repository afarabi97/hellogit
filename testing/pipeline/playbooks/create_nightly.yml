---
- name: Create nightly templates
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    ansible_python_interpreter: "{{ python_executable }}"
  tasks:
    - name: Convert "{{ controller }}" back to a VM
      ignore_errors: yes
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        cluster: "{{ vcenter.cluster }}"
        validate_certs: no
        datacenter: "{{ vcenter.datacenter }}"
        name: "{{ controller }}"
        folder: "/{{ vcenter.datacenter }}/vm/Templates"
        state: present
        is_template: no

    - name: Delete old "{{ controller }}"
      ignore_errors: yes
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        cluster: "{{ vcenter.cluster }}"
        validate_certs: no
        datacenter: "{{ vcenter.datacenter }}"
        name: "{{ controller }}"
        folder: "/{{ vcenter.datacenter }}/vm/Templates"
        state: absent

    - name: Create a snapshot of new "{{ controller }}"
      vmware_guest_snapshot:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        folder: "{{ node.folder }}"
        name: "{{ node.hostname }}"
        validate_certs: no
        state: present
        snapshot_name: "baseline"

    - name: Get VM "{{ node.hostname }}" uuid
      vmware_guest_info:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        validate_certs: no
        datacenter: "{{ vcenter.datacenter }}"
        folder: "{{ node.folder }}"
        name: "{{ node.hostname }}"
      register: vm_facts

    - name: "Power off the VM {{ node.hostname }}"
      ignore_errors: yes
      vmware_guest:
        datacenter: "{{ vcenter.datacenter }}"
        cluster: "{{ vcenter.cluster }}"
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        name: "{{ node.hostname }}"
        folder: "{{ node.folder }}"
        state: poweredoff
        validate_certs: False
      delegate_to: localhost

    - name: Rename "{{ node.hostname }}" to "{{ controller }}"
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        validate_certs: no
        uuid: "{{ vm_facts.instance.hw_product_uuid }}"
        name: "{{ controller }}"

    - name: Create new "{{ controller }}"
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        folder: "{{ node.folder }}"
        name: "{{ controller }}"
        validate_certs: no
        state: present
        is_template: yes

    - name: Move "{{ controller }}" to the Templates folder
      vmware_guest_move:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        validate_certs: no
        name: "{{ controller }}"
        folder: "/{{ vcenter.datacenter }}/vm/Templates"

