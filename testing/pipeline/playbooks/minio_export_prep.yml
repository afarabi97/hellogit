---
- name: Prepare minio for export.
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    ansible_python_interpreter: "{{ python_executable }}"
  tasks:
    - name: Remove release template.
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        cluster: "{{ vcenter.cluster }}"
        folder: "Releases"
        name: "{{ release_template_name }}"
        state: absent
        validate_certs: no
      delegate_to: localhost

    - name: Run a command in the guest.
      vmware_vm_shell:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        cluster: "{{ vcenter.cluster }}"
        folder: "{{ folder }}"
        vm_id: "{{ vmname }}"
        vm_username: root
        vm_password: "{{ password }}"
        vm_shell: "{{ item.vm_shell }}"
        vm_shell_args: "{{ item.vm_shell_args }}"
        validate_certs: no
      loop: "{{ commands }}"
      delegate_to: localhost

    - name: Create snapshot.
      vmware_guest_snapshot:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        folder: "{{ folder }}"
        name: "{{ vmname }}"
        snapshot_name: baseline
        state: present
        validate_certs: no
      delegate_to: localhost

    - name: Create release template.
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        cluster: "{{ vcenter.cluster }}"
        folder: Releases
        name: "{{ release_template_name }}"
        template: "{{ vmname }}"
        is_template: yes
        state: present
        validate_certs: no
      delegate_to: localhost

    - name: Remove virtual machine.
      vmware_guest:
        hostname: "{{ vcenter.ipaddress }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        cluster: "{{ vcenter.cluster }}"
        folder: "{{ folder }}"
        name: "{{ vmname }}"
        state: absent
        force: yes
        validate_certs: no
      delegate_to: localhost
      ignore_errors: yes
